![img](/img/in-post/kubernetes-iptables/Kube-proxy NAT分析.png)

## Basics

3 protocols: TCP, UDP, ICMP

4 states: NEW, ESTABLISHED, INVALID, RELATED

4 tables

1. raw: Advanced features, such as: URL filtering.
1. mangle: Packet modification (QOS), used to implement quality of service.
1. net: Address translation, used for gateway routers.
1. filter: Packet filtering, used for firewall rules.

5 chains

1. PREROUTING chain: Used for destination address translation (DNAT).
1. INPUT chain: Processes input packets.
1. FORWARD chain: Processes forwarded packets.
2. OUTPUT chain: Processes output packets.
1. POSTROUTING chain: Used for source address translation (SNAT).

## Common Methods

```bash
iptables -t filter -nL
iptables -t nat -nL
iptables -t raw -nL
iptables -t mangle -nL
```


## Analyzing kubernetes svc Traffic Links with iptables

> The iptables on node nodes are generated by kube-proxy. For specific implementation, see [kube-proxy code](https://github.com/kubernetes/kubernetes/blob/master/pkg/proxy/iptables/proxier.go)
> 
> kube-proxy only modifies the filter and nat tables. It extends iptables chains, customizing five chains: KUBE-SERVICES, KUBE-NODEPORTS, KUBE-POSTROUTING, KUBE-MARK-MASQ and KUBE-MARK-DROP, and mainly configures traffic routing rules by adding rules to the KUBE-SERVICES chain (attached to PREROUTING and OUTPUT)

### Cluster Information

Pod CIDR: 172.31.0.0/16

Alibaba Cloud kubernetes v1.12.6-aliyun.1

*.aliyuncs.com/acs/flannel:v0.8.0

SLB private IP: 172.6.6.6 (actually also bound to an EIP)

### Using a svc as an Example

Using testsvc under default namespace as an example

```

➜  ~ kgsvc testsvc
NAME              TYPE           CLUSTER-IP     EXTERNAL-IP    PORT(S)         w
testsvc           LoadBalancer   172.30.5.207   172.6.6.6      443:30031/TCP   106d

➜  ~ iptables -t nat -nL 

Chain PREROUTING (policy ACCEPT)
target         prot opt source               destination
KUBE-SERVICES  all  --  0.0.0.0/0            0.0.0.0/0            /* kubernetes service portals */

Chain OUTPUT (policy ACCEPT)
target         prot opt source               destination
KUBE-SERVICES  all  --  0.0.0.0/0            0.0.0.0/0            /* kubernetes service portals */
DOCKER         all  --  0.0.0.0/0           !127.0.0.0/8          ADDRTYPE match dst-type LOCAL

# All services are in this Chain, very long
Chain KUBE-SERVICES (2 references)
target                     prot opt source               destination
KUBE-MARK-MASQ             tcp  -- !172.31.0.0/16        172.30.5.207         /* default/testsvc: cluster IP */ tcp dpt:443
KUBE-SVC-M42ZCW2EYUCRBVAF  tcp  --  0.0.0.0/0            172.30.5.207         /* default/testsvc: cluster IP */ tcp dpt:443
......
KUBE-FW-M42ZCW2EYUCRBVAF   tcp  --  0.0.0.0/0            172.6.6.6            /* default/testsvc: loadbalancer IP */ tcp dpt:443

# Mark packets passing through
Chain KUBE-MARK-MASQ (522 references)
target     prot opt source               destination
MARK       all  --  0.0.0.0/0            0.0.0.0/0            MARK or 0x4000

Chain KUBE-XLB-M42ZCW2EYUCRBVAF (2 references)
target                     prot opt source               destination
KUBE-SVC-M42ZCW2EYUCRBVAF  all  --  172.31.0.0/16        0.0.0.0/0            /* Redirect pods trying to reach external loadbalancer VIP to clusterIP */
KUBE-MARK-DROP             all  --  0.0.0.0/0            0.0.0.0/0            /* default/testsvc: has no local endpoints */


Chain KUBE-SVC-M42ZCW2EYUCRBVAF (2 references)
target                     prot opt source               destination
KUBE-SEP-EA7TYKWK2S6G4PQR  all  --  0.0.0.0/0            0.0.0.0/0            statistic mode random probability 0.14286000002
KUBE-SEP-ZJI36FVTROQF5MX7  all  --  0.0.0.0/0            0.0.0.0/0            statistic mode random probability 0.16667000018
KUBE-SEP-JLGUPWE7JCRU2AGG  all  --  0.0.0.0/0            0.0.0.0/0            statistic mode random probability 0.20000000019
KUBE-SEP-GCNPY23RDN22AOTX  all  --  0.0.0.0/0            0.0.0.0/0            statistic mode random probability 0.25000000000
KUBE-SEP-FNDISD3HQYKEHL3T  all  --  0.0.0.0/0            0.0.0.0/0            statistic mode random probability 0.33332999982
KUBE-SEP-3RWVMCKITDQWELSA  all  --  0.0.0.0/0            0.0.0.0/0            statistic mode random probability 0.50000000000
KUBE-SEP-BVMKBOC4GGNJ3567  all  --  0.0.0.0/0            0.0.0.0/0

Chain KUBE-SEP-BVMKBOC4GGNJ3567 (1 references)
# 172.31.9.52 is pod virtual IP
target          prot opt source               destination
KUBE-MARK-MASQ  all  --  172.31.9.52          0.0.0.0/0
DNAT            tcp  --  0.0.0.0/0            0.0.0.0/0            tcp to:172.31.9.52:80

Chain KUBE-FW-M42ZCW2EYUCRBVAF (1 references)
target                     prot opt source               destination
KUBE-XLB-M42ZCW2EYUCRBVAF  all  --  0.0.0.0/0            0.0.0.0/0            /* default/testsvc: loadbalancer IP */
KUBE-MARK-DROP             all  --  0.0.0.0/0            0.0.0.0/0            /* default/testsvc: loadbalancer IP */

Chain KUBE-MARK-DROP (60 references)
target     prot opt source               destination
MARK       all  --  0.0.0.0/0            0.0.0.0/0            MARK or 0x8000
```

Graphical:

![image](/img/in-post/kubernetes-iptables/chain.png)

```
graph TB
a(Internal traffic/PREROUTING)-->c(KUBE-SERVICES)
b(External traffic/OUTPUT)-->c
c-->d(KUBE-MARK-MASQ)
d-->|destination:172.30.5.207|e(KUBE-SVC-M42ZCW2EYUCRBVAF)
e-->|destination:172.30.5.207|p1(KUBE-SEP-EA7TYKWK2S6G4PQR)
e-->|destination:172.30.5.207|p2(KUBE-SEP-ZJI36FVTROQF5MX7)
p1-->|destination:<podIP1>|f(KUBE-FW-M42ZCW2EYUCRBVAF)
p2-->|destination:<podIP2>|f
f-->g(KUBE-XLB-M42ZCW2EYUCRBVAF)
g-->|After loadbalancer IP is intercepted on node, forward to service|h(KUBE-SVC-M42ZCW2EYUCRBVAF)
```

### Some iptables Tips

#### Why pod's probability increases

First 1/3 probability: If matched, it means hit 1/3. If not matched, remaining 2/3 goes to next line.

Second 1/2 probability: If matched, it means hit 2/3 * 1/2 = 1/3. If not matched, 1/2 goes to next line.

Third probability 1: If matched, it's 2/3 * 1/2 * 1 = 1/3

#### Why the last chain KUBE-SEP-BVMKBOC4GGNJ3567 has no probability

Sequential matching, it takes the remainder, so no need to calculate weight anymore.

#### What does destination 0.0.0.0/0 mean

Carefully observe the entire link. By the time we reach `KUBE-SEP-XXX` step, we've already obtained the pod's virtual IP. So except for this, other chains' destinations remain unchanged and no longer need modification.


## Conclusion

1. kubernetes 0.8 version's flannel is a large-scale application of iptables.
1. This long and smelly KUBE-SERVICES chain chain determines that service matching is O(n). As svc increases, add/delete/modify/query will become increasingly slow.
1. When svc count exceeds 1000, lag will be quite obvious.
2. kube-proxy should be based on IPVS mode, using iptables will only repeat the same mistake.
3. svcIP is a transit virtual IP.


## Reference Links

1. [Kubernetes Upgrade Record from 1.10 to 1.11 (Continued): Kubernetes kube-proxy Enables IPVS Mode](https://blog.frognew.com/2018/10/kubernetes-kube-proxy-enable-ipvs.htm)
2. [How to Enable ipvs in kubernetes](https://juejin.im/entry/5b7e409ce51d4538b35c03df)
3. [Huawei Cloud's Service Performance Optimization Practice in Large-Scale K8S Scenarios](https://zhuanlan.zhihu.com/p/37230013)
4. [kubernetes Network Packet Flow](https://zhuanlan.zhihu.com/p/28289080)
5. [kube-proxy ipvs Mode Interpretation](https://segmentfault.com/a/1190000016333317)
6. [kube-proxy Mode Comparison: iptables or IPVS?](https://www.jishuwen.com/d/2K3c)
1. [How to edit iptables rules](https://fedoraproject.org/wiki/How_to_edit_iptables_rules)
2. [Simple Introduction to iptables & ipvs](http://www.voidcn.com/article/p-uttldwvk-pz.html)
3. [iptables Related](https://www.zsythink.net/archives/category/%E8%BF%90%E7%BB%B4%E7%9B%B8%E5%85%B3/iptables/)
4. [Understanding iptables in kubernetes Environment](https://www.cnblogs.com/charlieroro/p/9588019.html)
