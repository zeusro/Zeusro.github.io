2018å¹´3æœˆï¼Œæˆ‘æ­£å¼é™†ç»­æ¥ç®¡é˜¿ç±³å·´é›†å›¢å…¬å¸çš„æ‰€æœ‰æ•°å­—èµ„äº§ï¼Œæˆä¸ºå®é™…æ„ä¹‰ä¸Šçš„è¿ç»´è´Ÿè´£äººã€‚

ç”±äºé¢†å¯¼å¾ˆçœ‹é‡æˆ‘ï¼ˆ~~è€æ¿ä¸èˆå¾—èŠ±é’±~~ï¼‰ï¼Œæœ‰å¾ˆé•¿çš„ä¸€æ®µæ—¶é—´ï¼Œéƒ½æ˜¯æˆ‘ä¸€ä¸ªäººåœ¨è´Ÿè´£æ‰€æœ‰äº‹æƒ…ã€‚

ç‰¹åˆ«æ˜¯åœ¨CDNè¿™ä¸€é¢†åŸŸï¼Œç”±äºæ¶‰åŠåˆ°å†å²é—ç•™é¡¹ç›®ï¼ŒåŸŸåè§£æï¼ŒTTLï¼Œå›½å†…å‚»é€¼äº’è”ç½‘è¿è¥å•†ï¼ˆæ¯”å¦‚é•¿åŸå®½å¸¦ï¼‰ï¼Œè¿™å—å·¥ä½œå†…å®¹æ›´è¦è°¨æ…å¤„ç†ã€‚

æˆ‘ä»¬å…ˆå›åˆ°æ ¹æºé—®é¢˜ï¼Œä¸ºä»€ä¹ˆéœ€è¦ CDN ï¼ŒCDN åˆ°åº•è§£å†³äº†ä»€ä¹ˆé—®é¢˜ã€‚

## ä¸ºä»€ä¹ˆéœ€è¦CDN

![image](/img/in-post/cdn-history/http.png)

è¦å›ç­”è¿™ä¸ªé—®é¢˜ï¼Œå¾—ä»å†å²çš„å®è§‚è§’åº¦æ€è€ƒè¿™ä¸ªé—®é¢˜ã€‚

è¿œå¤æ—¶æœŸçš„ web è¯·æ±‚ï¼Œå¦‚æœèµ°Aè§£æï¼Œé‚£ä¹ˆè¯·æ±‚é“¾è·¯åŸºæœ¬å¦‚ä¸‹ï¼š

```
computer --> local DNS  --> server IP
```

è·å–æœåŠ¡å™¨IPä¹‹åï¼Œå†ç”±ç”µå­ç»ˆç«¯ï¼ˆç”µè„‘ã€æ‰‹æœºã€iPadï¼‰ä¸æœåŠ¡å™¨å»ºç«‹TCPè¿æ¥ï¼Œæœ€åæ˜¯æµè§ˆå™¨æ¸²æŸ“ã€‚

ä½†è¿™é‡Œé¢æœ‰ä¸ªé—®é¢˜ï¼Œ`server IP` åªæœ‰ä¸€ä¸ªï¼Œè€Œ `computer` é€šå¸¸æœ‰å¤šä¸ªï¼Œå¦‚æœç”¨æˆ·è¿‡å¤šï¼ˆcomputerï¼‰ï¼Œå°±ä¼šå‡ºç°ç½‘ç»œæ‹¥å µã€‚è¿™å°±å¥½æ¯”ä½ å»é¥­é¦†åƒé¥­ï¼Œä½†æ˜¯è€æ¿å¾ˆæŠ ï¼ŒæœåŠ¡å‘˜åªæœ‰ä¸€ä¸ªï¼Œéšç€é¡¾å®¢çš„å¢å¤šï¼ŒæœåŠ¡å‘˜è¶Šæ¥è¶Šå¿™ï¼Œæœ€ç»ˆæ ¹æœ¬é¡¾ä¸ä¸Šä½ ã€‚

é‚£ä¹ˆï¼Œæ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ

![image](/img/in-post/cdn-history/secret-garden.jpg)

ç­”æ¡ˆå½“ç„¶æ˜¯ç ¸é’±å•¦ï¼æ—¢ç„¶ä½ è§‰å¾—æœåŠ¡å‘˜å¤ªå°‘ï¼ŒæœåŠ¡ä¸å‘¨åˆ°ã€‚é‚£ä¹ˆä½ å°±å¤šå‡ºç‚¹é’±å»å¥³ä»†åº—ï¼Œè®©å¦¹å­åˆæ³•åœ°å›´ç»•åœ¨ä½ èº«è¾¹ã€‚

CDNä¹Ÿæ˜¯ç±»ä¼¼è¿™ç§æœºåˆ¶ï¼Œé€šè¿‡æŒç»­æŠ•å…¥å¦¹å­ï¼ˆCDNè¾¹ç¼˜åŠ é€ŸèŠ‚ç‚¹ï¼‰ï¼Œæ›´å¥½åœ°æœåŠ¡æƒ³è¦åƒé¥­ï¼ˆä½¿ç”¨äº’è”ç½‘å¼€è½¦ï¼‰çš„äººã€‚

## ä½¿ç”¨CDN

åæ¥ï¼Œå½“æˆ‘ä»¬æ‘†è„±äº†è¿œå¤çš„webæ—¶ä»£ï¼Œæ¥åˆ°è¿‘ç°ä»£ã€‚éšç€ç”¨æˆ·çš„æŒ‡æ•°çº§å¢é•¿ï¼Œå°±éœ€è¦ä¸€å¥—æ–°çš„æ¶æ„æ¥é€‚åº”å˜åŒ–ã€‚

è€Œè½¯ä»¶è®¾è®¡ä¸€ç›´ä»¥æ¥æœ‰ä¸€ä¸ªå¥—è·¯ï¼š**å¦‚æœä¸€å±‚ä¸å¤Ÿï¼Œå°±å†åŠ å¤šä¸€å±‚**ã€‚

![image](/img/in-post/cdn-history/maxresdefault.jpg)

æ‰€ä»¥ï¼Œåˆ°äº†è¿‘ç°ä»£ï¼Œweb åç«¯æ¶æ„é€šå¸¸éƒ½æ˜¯ä¸€ä¸ª`æ¤’ç›åƒå±‚é¥¼`ï¼š

```
$host --> cname --> CDN --> SLB ip --> server1,server2,server3,...
```

è€Œç”¨æˆ·çš„è®¿é—®é“¾è·¯åˆ™æ˜¯

```
computer --> local DNS  --> CDN
```

CDN çš„æœ¬è´¨æ˜¯ä¸€ç§**é™æ€æ•°æ®çš„ç¼“å†²ä¸ç¼“å­˜**ã€‚

## CDNé—®é¢˜çš„è¯Šæ–­

å¤§æ¦‚2015å¹´çš„æ—¶å€™ï¼Œæˆ‘å…¼èŒå…¬å¸çš„æŠ€æœ¯æ”¯æŒã€‚ç»å¸¸åœ¨QQä¸Šç»™å®¢æˆ·æ’é™¤æŠ€æœ¯æ•…éšœï¼ˆ~~æ‹‰ç½‘çº¿~~ï¼‰ï¼Œé€æ­¥ç§¯ç´¯äº†ä¸€äº›ç½‘ç»œè¯Šæ–­(~~å¹ç‰›é€¼~~)çš„ç»éªŒã€‚

å¦‚æœæˆ‘ä»¬åˆ†æ‹†æ•´ä¸ªâ€œè¿‘ç°ä»£â€webåç«¯çš„è¯·æ±‚é“¾è·¯ï¼Œå°±ä¼šå‘ç°è¿™é‡Œé¢æ¯ä¸€å±‚æ•°æ®çš„æµåŠ¨éƒ½ä¼šäº§ç”Ÿé—®é¢˜ã€‚

### computer çš„é—®é¢˜

ä¸»è¦æ˜¯åƒåœ¾é…ç½®ï¼Œåƒåœ¾å®½å¸¦çš„é—®é¢˜ã€‚å¯¹äºåƒåœ¾å®½å¸¦çš„é—®é¢˜ï¼Œæˆ‘ä¸€èˆ¬å»ºè®®ç”¨æˆ·å» [å·¥ä¸šå’Œä¿¡æ¯åŒ–éƒ¨ç”µä¿¡ç”¨æˆ·ç”³è¯‰å—ç†ä¸­å¿ƒ](https://dxss.miit.gov.cn/) æŠ•è¯‰è¿è¥å•†ã€‚

### local DNS çš„é—®é¢˜

`local DNS` ä¹Ÿå«æœ¬åœ°DNSï¼Œå¦‚æœä¸ç‰¹åˆ«è®¾ç½®çš„è¯ï¼Œå°±ä¼šèµ°è·¯ç”±å™¨ï¼Œè€Œè·¯ç”±å™¨åˆ™è·Ÿè¿è¥å•†ã€‚
å¦‚æœä½ é‡åˆ°ä¸€ä¸ªæ¯«æ— èŠ‚æ“çš„è¿è¥å•†ï¼Œé‚£ä¹ˆæœ‰å¯èƒ½ä½ è¾“å…¥çš„ç½‘å€æ˜¯å¯¹çš„ï¼Œä½†æ˜¯ä½ ä¾æ—§ä¸Šä¸äº†ç½‘ã€‚

å‡ºç°è¿™ä¸ªé—®é¢˜çš„åŸå› åœ¨äº DNS æœåŠ¡æœ¬èº«æ˜¯ä¸€ä¸ªwebæœåŠ¡ä¾›åº”å•†ï¼Œå¦‚æœæˆ‘è¿™è¾¹æ”¹äº†DNS IPï¼Œè€Œè¿è¥å•†é‚£è¾¹æ•…æ„è§£æé”™ï¼ˆDNSæ±¡æŸ“ï¼‰æˆ–è€…DNSè·Ÿä¸ä¸Šï¼ˆè¿‡äº†TTLä¾æ—§ç¼“å­˜æ—§çš„è®°å½•ï¼‰ï¼Œæ•´ä¸ªè§£æå°±ä¼šæœ‰é—®é¢˜ã€‚

æ‰€ä»¥åˆ°äº†åæ¥ï¼Œæˆ‘å†™äº†ä¸€ä»½æ–‡æ¡£ï¼Œè®©è¿è¥åŠ å…¥åˆ°æˆ‘ä»¬å…¬å¸çš„[å¸®åŠ©æ–‡æ¡£](https://17zwd.com/help/dianzhu/201806250906137255.htm)é‡Œé¢â€”â€”ä¸»è¦å°±æ˜¯è®¾ç½®ä¸‹ `local DNS` ï¼Œè§„é¿æ‰è¿è¥å•†å¼±é¸¡ `DNS` çš„é—®é¢˜ã€‚

![image](/img/in-post/cdn-history/local-dns.png)

### CDN çš„é—®é¢˜

CDN çš„é—®é¢˜å‡ºç°å¾—æ¯”è¾ƒéšè”½ï¼Œè€Œä¸”é€šå¸¸CDNè¿è¥å•†ä¼šç”©é”…ã€‚æ‰€ä»¥è¿™ä¸ªæ—¶å€™å¾—è¯¦ç»†æ”¶é›†ç”¨æˆ·æ•°æ®ï¼Œå†åè¿‡æ¥é—®å€™CDN~~çˆ¶æ¯~~ã€‚

å‡è®¾å‡ºé—®é¢˜çš„æ˜¯ stu.17zwd.comã€‚æˆ‘ä¼šè®©ç”¨æˆ·è®¿é—® https://ipip.net ï¼Œæˆªå›¾ã€‚ç„¶åæ ¹æ®ä¸åŒçš„ç³»ç»Ÿï¼Œè¾“å…¥ä¸åŒçš„å‘½ä»¤ã€‚

- [windowå®¢æˆ·]

```bash
set host=stu.17zwd.com
ipconfig -all
ping %host%
tracert %host%
```

- [macå®¢æˆ·]

```bash
export host=stu.17zwd.com
nslookup $host
ping $host
traceroute $host
```

ä¹‹åå†å‘ä¸Šæ¸¸åé¦ˆã€‚

`*.w.alikunlun.com` é€šå¸¸éƒ½æ˜¯é˜¿é‡Œäº‘ï¼Œ
`*.wswebpic.com` åŸºæœ¬æ˜¯ç½‘å®¿ã€‚

### æƒå¨DNSçš„é—®é¢˜

![image](/img/in-post/cdn-history/dns-query_20151207015631_954.png)

è¿™ä¸ªé—®é¢˜å‡ºç°å¾—å¾ˆå°‘ï¼Œæˆ‘åªé‡è¿‡ä¸€æ¬¡ã€‚é‚£ä¸€æ¬¡æ˜¯æœåŠ¡å™¨åœ¨è®¿é—®æŸä¸ªå›½å†…ä¸èƒ½å¤‡æ¡ˆçš„åŸŸåæ—¶å‡ºç°çš„ã€‚
å½“æ—¶ç»è¿‡ä¸é˜¿é‡Œäº‘å”®åè”ç³»å‘ç°ï¼Œæ˜¯æœåŠ¡å™¨çš„IPè®¿é—®æƒå¨DNSå—é™ã€‚

å› ä¸ºæƒå¨DNSæœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ç§webæœåŠ¡ï¼Œå®ƒå¯ä»¥ä¸»åŠ¨æ‹’ç»ä¸åˆæ³•è¿æ¥ã€‚

## äº‰å–è®®ä»·æƒ

å…¬æœ‰äº‘çš„ç›ˆåˆ©æ¨¡å¼ï¼Œæœ¬è´¨ä¸Šé  [ç½‘ç»œæ•ˆåº”](https://wiki.mbalib.com/wiki/%E7%BD%91%E7%BB%9C%E6%95%88%E5%BA%94) å¸¦æ¥çš„æµé‡è´¹ç”¨ã€‚éšç€æœåŠ¡å™¨è§„æ¨¡çš„å¢å¤šï¼Œæˆ‘ä»¬ä¼šå‘ç°å¸¦å®½è´¹ç”¨ä¼šé€æ¸æ°´æ¶¨èˆ¹é«˜ã€‚

ç»è¿‡æˆ‘å¤§è‡´æµ‹ç®—ï¼Œå¹³æ‘Šä¹‹åï¼Œè´¹ç”¨ä¼šå åˆ°50%ä»¥ä¸Šã€‚æ‰€ä»¥ï¼Œæˆ‘ä¸Šä»»ä¹‹åï¼Œä¸ºäº†å°½å¯èƒ½æ”¶ç¼©è¿™æ–¹é¢çš„æ”¯å‡ºï¼Œåšäº†ä¸å°‘åŠªåŠ›ã€‚

**ä¼ä¸šç›ˆåˆ©çš„å…³é”®åœ¨äºå„æ–­ç»è¥ã€‚æ‰“ç ´å„æ–­ï¼Œåˆ™éœ€è¦ç«äº‰å¯¹æ‰‹ã€‚**æ‰€ä»¥æˆ‘å¼•å…¥äº†ç½‘å®¿ï¼Œå¹¶ç£ä¿ƒä»–ä»¬åšä¸€ä¸ªæˆ‘ç›¸å¯¹æ»¡æ„çš„æ–¹æ¡ˆã€‚è¿™ä¸ªæ–¹æ¡ˆå°±æ˜¯â€œ**æŒ‰å¸¦å®½è®¡è´¹**â€ã€‚

ç»è¿‡æˆ‘é•¿æœŸçš„ã€Œè´¹ç±³ä¼°ç®—ã€ï¼Œæˆ‘æ€»ç»“å‡º `æµé‡` + `å¸¦å®½` è¿™ä¸€æ··åˆç­–ç•¥ã€‚
ä¸»è¦çš„æµé‡æ”¾é˜¿é‡Œäº‘ï¼Œç”¨æµé‡è®¡è´¹ï¼›å›½å¤–å’Œå°æµé‡çš„ç«™ç‚¹æ”¾ç½‘å®¿é‚£è¾¹ã€‚

å¼•å…¥ç½‘å®¿ä¹‹åï¼Œæˆ‘ä»¬ä¸å†ç»å¯¹åœ°ä¾èµ–é˜¿é‡Œäº‘ï¼Œå…·å¤‡äº†éšæ—¶ä¼¸ç¼©çš„èƒ½åŠ›ã€‚ä¹‹åï¼Œæˆ‘å†ä»¥æ­¤ä¸ºç­¹ç ï¼Œåœ¨2020å¹´è¿™ä¸ªè´¢å¹´é‡Œé¢ï¼Œä¸ºå…¬å¸é˜¿é‡Œäº‘è´¦æˆ·çš„CDNäº§å“ç”³è¯·äº†ä¸€ä¸ªæ›´é«˜çš„æŠ˜æ‰£ã€‚

æ¯”è¾ƒæœ‰ç¼˜çš„æ˜¯ï¼Œå¯¹æ¥çš„é˜¿é‡Œäº‘å•†åŠ¡ç»ç†ä»¥å‰åœ¨è“æ±›ä¸Šç­ã€‚è€Œæˆ‘ä»¬ä»¥å‰ç”¨è“æ±›CDNçš„æ—¶å€™ï¼Œå¯¹æ¥çš„ä¹Ÿæ˜¯å¥¹ã€‚æˆ‘ä»¬ç®—æ˜¯ä¹…åˆ«é‡é€¢ã€‚

## è‡ªåŠ¨åŒ–è¿ç»´ç¨‹åº

**CDN è´¹ç”¨çš„æœ¬è´¨æ˜¯ç½‘ç»œæµé‡è´¹ç”¨**ã€‚

åœ¨é˜¿é‡Œäº‘å†…éƒ¨ï¼Œæˆ‘è¿½åŠ äº†ä¸€ä¸ªæŒ‰å¸¦å®½è®¡è´¹çš„å…±äº«å¸¦å®½æ± ã€‚å¹¶ç”¨ [common-bandwidth-auto-switch](https://github.com/p-program/common-bandwidth-auto-switch) è¿™ä¸ªæˆ‘è‡ªå·±å†™çš„é¡¹ç›®ï¼ŒåŠ¨æ€è§„åˆ’å…±äº«å¸¦å®½æ± é‡Œé¢çš„EIPåˆ—è¡¨ï¼Œåšå†³ä¸è®©é˜¿é‡Œäº‘å¤šæŒ£æˆ‘å¸ä¸€åˆ†é’±ï¼ï¼ï¼

å¯¹äºå›¾ç‰‡æºç«™ï¼Œæˆ‘åšäº†ä¸€ä¸ª [nginx-brotliå®éªŒ](http://www.zeusro.com/2018/07/05/nginx-brotli/)ï¼ŒæŠŠå›¾ç‰‡ç”¨ `brotli` ç¼–ç ï¼Œè¿›ä»¥å‹ç¼©è´¹ç”¨ã€‚

æœ€åï¼Œæˆ‘æ€»ç»“å‡º ã€Š[å¤šå…¬æœ‰äº‘CDNæœ€ä½³å®è·µ](http://www.zeusro.com/2019/09/20/cdn-pickup/)ã€‹ ï¼Œå¶å°” [ç”¨ã€Œè¶…è£…é€¼ã€æ’æŸ¥CDNæµé‡å‰§å¢é—®é¢˜](http://www.bullshitprogram.com/super-b/)ã€‚

å¤§æ¦‚åœ¨å¾ˆæ—©æ—¶å€™ï¼Œæˆ‘å°±éšçº¦è§‰å¾—â€œ**æŠ€æœ¯ä¸ºä¸šåŠ¡ä»·å€¼æœåŠ¡**â€ï¼Œæ‰€ä»¥æˆ‘åšçš„é¡¹ç›®åŸºæœ¬ä¸Šèƒ½ç®—æ¸…å•†ä¸šä»·å€¼ã€‚
è€Œä¹‹å‰çš„æ€ å·¥ï¼Œä¸»è¦æ˜¯è§‰å¾—åšçš„é‚£äº›é¡¹ç›®ä¸æ˜¯å¾ˆæŒ£é’±å§ã€‚

## äº‘åŸç”Ÿæ—¶ä»£çš„ç½‘ç»œè¯Šæ–­

è¿›å…¥äº‘åŸç”Ÿæ—¶ä»£ï¼Œæ’æŸ¥ç½‘ç»œé—®é¢˜å˜å¾—æ›´åŠ å¤æ‚ã€‚
å…·ä½“çš„å¯ä»¥çœ‹ 
1. [kubernetesçš„timeouté—®é¢˜](http://www.zeusro.com/2019/05/11/kubernetes-timeout/)
1. [ç†è§£kubernetesçš„serviceæµé‡è½¬å‘é“¾è·¯](http://www.zeusro.com/2019/05/17/kubernetes-iptables/)

[kt-connect](https://github.com/alibaba/kt-connect) è¿™ä¸ªé¡¹ç›®ä¹Ÿä¸é”™ã€‚
å¦‚æœå–œæ¬¢åŸç”Ÿæ€ï¼Œå»ºè®®ç›´æ¥ç”¨ `tcpdump` ğŸ¤£ ã€‚

## ç»“è®º

> æŒ–æ˜æœºæ˜¯CDNæœ€å¤§çš„æ•Œäººã€‚

## å‚è€ƒé“¾æ¥

[1]
Proxy-coonectionå’Œconnectionçš„ä½¿ç”¨ï¼Œå¦‚ä½•ç®¡ç†è·¨ä»£ç†æœåŠ¡å™¨çš„é•¿çŸ­è¿æ¥ï¼Ÿ
https://my.oschina.net/u/4266687/blog/3514919

[2]
DNSåŸºæœ¬æ¦‚å¿µ
https://dudns.baidu.com/support/knowledge/Theory/

[3]
HTMLæ¸²æŸ“è¿‡ç¨‹è¯¦è§£
https://www.cnblogs.com/dojo-lzz/p/3983335.html

[4]
CDNç¼“å­˜é‚£äº›äº‹
https://bbs.qcloud.com/forum.php?mod=viewthread&tid=3775

[5]
ä½¿ç”¨pingå‘½ä»¤ä¸¢åŒ…æˆ–ä¸é€šæ—¶çš„é“¾è·¯æµ‹è¯•æ–¹æ³•
https://help.aliyun.com/knowledge_detail/40573.html

[6]
å¤šç»´åº¦åˆ†æCDN
https://zhuanlan.zhihu.com/p/142787755