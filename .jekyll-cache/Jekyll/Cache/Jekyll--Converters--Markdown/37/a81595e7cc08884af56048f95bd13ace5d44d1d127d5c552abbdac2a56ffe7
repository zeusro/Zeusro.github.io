I"}‡<p>Kubernetes é›†ç¾¤ç®¡ç†ç»(æ•™)éªŒ(è®­)</p>

<p><strong>2020-02-26 æ›´æ–°ï¼šæœ¬æ–‡å†æ›´æ–°ï¼Œè¯·ç§»æ­¥ <a href="https://github.com/zeusro/awesome-kubernetes-notes/blob/master/source/chapter_6.md">Kubernetesé›†ç¾¤ç®¡ç†ç»éªŒ</a></strong></p>

<h2 id="èŠ‚ç‚¹é—®é¢˜">èŠ‚ç‚¹é—®é¢˜</h2>

<h3 id="åˆ é™¤èŠ‚ç‚¹çš„æ­£ç¡®æ­¥éª¤">åˆ é™¤èŠ‚ç‚¹çš„æ­£ç¡®æ­¥éª¤</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="c"># SchedulingDisabled,ç¡®ä¿æ–°çš„å®¹å™¨ä¸ä¼šè°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹</span>
kubectl cordon <span class="nv">$node</span>
<span class="c"># é©±é€é™¤äº†dsä»¥å¤–æ‰€æœ‰çš„pod</span>
kubectl drain <span class="nv">$node</span>   <span class="nt">--ignore-daemonsets</span>
kubectl delete <span class="nv">$node</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="ç»´æŠ¤èŠ‚ç‚¹çš„æ­£ç¡®æ­¥éª¤">ç»´æŠ¤èŠ‚ç‚¹çš„æ­£ç¡®æ­¥éª¤</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="c"># SchedulingDisabled,ç¡®ä¿æ–°çš„å®¹å™¨ä¸ä¼šè°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹</span>
kubectl cordon <span class="nv">$node</span>
<span class="c"># é©±é€é™¤äº†dsä»¥å¤–æ‰€æœ‰çš„pod</span>
kubectl drain <span class="nv">$node</span> <span class="nt">--ignore-daemonsets</span> <span class="nt">--delete-local-data</span>
<span class="c"># ç»´æŠ¤å®Œæˆ,æ¢å¤å…¶æ­£å¸¸çŠ¶æ€</span>
kubectl uncordon <span class="nv">$node</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>â€“delete-local-data æ˜¯å¿½ç•¥ <code class="highlighter-rouge">emptyDir</code>è¿™ç±»çš„ä¸´æ—¶å­˜å‚¨çš„æ„æ€</p>

<h3 id="imagegcfailed">ImageGCFailed</h3>

<blockquote>

  <p>kubelet å¯ä»¥æ¸…é™¤æœªä½¿ç”¨çš„å®¹å™¨å’Œé•œåƒã€‚kubelet åœ¨æ¯åˆ†é’Ÿå’Œæ¯äº”åˆ†é’Ÿåˆ†åˆ«å›æ”¶å®¹å™¨å’Œé•œåƒã€‚</p>

  <p><a href="https://k8smeetup.github.io/docs/concepts/cluster-administration/kubelet-garbage-collection/">é…ç½® kubelet åƒåœ¾æ”¶é›†</a></p>
</blockquote>

<p>ä½†æ˜¯ kubelet çš„åƒåœ¾å›æ”¶æœ‰ä¸ªé—®é¢˜,å®ƒåªèƒ½å›æ”¶é‚£äº›æœªä½¿ç”¨çš„é•œåƒ,æœ‰ç‚¹åƒ <code class="highlighter-rouge">docker system prune</code>,ç„¶è€Œè§‚å¯Ÿå‘ç°,é‚£äº›æ­»æ‰çš„å®¹å™¨ä¸æ˜¯æœ€å¤§çš„é—®é¢˜,æ­£åœ¨è¿è¡Œçš„å®¹å™¨æ‰æ˜¯æ›´å¤§çš„é—®é¢˜.å¦‚æœImageGCFailedä¸€ç›´å‘ç”Ÿ,è€Œå®¹å™¨ä½¿ç”¨çš„ephemeral-storage/hostpath(å®¿ä¸»ç›®å½•)è¶Šå‘å¢å¤š,æœ€ç»ˆå°†ä¼šå¯¼è‡´æ›´ä¸¥é‡çš„DiskPressureé—®é¢˜,æ³¢åŠèŠ‚ç‚¹ä¸Šæ‰€æœ‰å®¹å™¨.</p>

<p>å»ºè®®:</p>

<ol>
  <li>é«˜é…æœºå™¨(4æ ¸32Gä»¥ä¸Š)çš„dockerç›®å½•é…ç½®100G SSDä»¥ä¸Šç©ºé—´</li>
  <li>é…ç½®<a href="https://kubernetes.io/docs/concepts/policy/resource-quotas/#storage-resource-quota">ResourceQuota</a>é™åˆ¶æ•´ä½“èµ„æºé™é¢</li>
  <li>å®¹å™¨ç«¯ç¦ç”¨ephemeral-storage(æœ¬åœ°æ–‡ä»¶å†™å…¥),æˆ–è€…ä½¿ç”¨spec.containers[].resources.limits.ephemeral-storageé™åˆ¶,æ§åˆ¶å®¿ä¸»ç›®å½•å†™å…¥</li>
</ol>

<h3 id="èŠ‚ç‚¹å‡ºç°ç£ç›˜å‹åŠ›diskpressure">èŠ‚ç‚¹å‡ºç°ç£ç›˜å‹åŠ›(DiskPressure)</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>--eviction-hard=imagefs.available&lt;15%,memory.available&lt;300Mi,nodefs.available&lt;10%,nodefs.inodesFree&lt;5%
</pre></td></tr></tbody></table></code></pre></div></div>

<p>kubeletåœ¨å¯åŠ¨æ—¶æŒ‡å®šäº†ç£ç›˜å‹åŠ›,ä»¥é˜¿é‡Œäº‘ä¸ºä¾‹,<code class="highlighter-rouge">imagefs.available&lt;15%</code>æ„æ€æ˜¯è¯´å®¹å™¨çš„è¯»å†™å±‚å°‘äº15%çš„æ—¶å€™,èŠ‚ç‚¹ä¼šè¢«é©±é€.èŠ‚ç‚¹è¢«é©±é€çš„åæœå°±æ˜¯äº§ç”ŸDiskPressureè¿™ç§çŠ¶å†µ,å¹¶ä¸”èŠ‚ç‚¹ä¸Šå†ä¹Ÿä¸èƒ½è¿è¡Œä»»ä½•é•œåƒ,ç›´è‡³ç£ç›˜é—®é¢˜å¾—åˆ°è§£å†³.å¦‚æœèŠ‚ç‚¹ä¸Šå®¹å™¨ä½¿ç”¨äº†å®¿ä¸»ç›®å½•,è¿™ä¸ªé—®é¢˜å°†ä¼šæ˜¯è‡´å‘½çš„.å› ä¸ºä½ ä¸èƒ½æŠŠç›®å½•åˆ é™¤æ‰,ä½†æ˜¯çœŸæ˜¯è¿™äº›å®¿ä¸»æœºçš„ç›®å½•å †ç§¯,å¯¼è‡´äº†èŠ‚ç‚¹è¢«é©±é€.</p>

<p>æ‰€ä»¥,å¹³æ—¶è¦å…»å¥½è‰¯å¥½ä¹ æƒ¯,å®¹å™¨é‡Œé¢åˆ«çå†™ä¸œè¥¿(å®¹å™¨é‡Œé¢å†™æ–‡ä»¶ä¼šå ç”¨ephemeral-storage,ephemeral-storageè¿‡å¤špodä¼šè¢«é©±é€),å¤šä½¿ç”¨æ— çŠ¶æ€å‹å®¹å™¨,è°¨æ…é€‰æ‹©å­˜å‚¨æ–¹å¼,å°½é‡åˆ«ç”¨hostpathè¿™ç§å­˜å‚¨</p>

<p>å‡ºç°çŠ¶å†µæ—¶,çœŸçš„æœ‰ç§æ¬²å“­æ— æ³ªçš„æ„Ÿè§‰.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre>Events:
  Type     Reason                 Age                   From                                            Message
  ----     ------                 ----                  ----                                            -------
  Warning  FreeDiskSpaceFailed    23m                   kubelet, node.xxxx1     failed to garbage collect required amount of images. Wanted to free 5182058496 bytes, but freed 0 bytes
  Warning  FreeDiskSpaceFailed    18m                   kubelet, node.xxxx1     failed to garbage collect required amount of images. Wanted to free 6089891840 bytes, but freed 0 bytes
  Warning  ImageGCFailed          18m                   kubelet, node.xxxx1     failed to garbage collect required amount of images. Wanted to free 6089891840 bytes, but freed 0 bytes
  Warning  FreeDiskSpaceFailed    13m                   kubelet, node.xxxx1     failed to garbage collect required amount of images. Wanted to free 4953321472 bytes, but freed 0 bytes
  Warning  ImageGCFailed          13m                   kubelet, node.xxxx1     failed to garbage collect required amount of images. Wanted to free 4953321472 bytes, but freed 0 bytes
  Normal   NodeHasNoDiskPressure  10m (x5 over 47d)     kubelet, node.xxxx1     Node node.xxxx1 status is now: NodeHasNoDiskPressure
  Normal   Starting               10m                   kube-proxy, node.xxxx1  Starting kube-proxy.
  Normal   NodeHasDiskPressure    10m (x4 over 42m)     kubelet, node.xxxx1     Node node.xxxx1 status is now: NodeHasDiskPressure
  Warning  EvictionThresholdMet   8m29s (x19 over 42m)  kubelet, node.xxxx1     Attempting to reclaim ephemeral-storage
  Warning  ImageGCFailed          3m4s                  kubelet, node.xxxx1     failed to garbage collect required amount of images. Wanted to free 4920913920 bytes, but freed 0 bytes
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ImageGCFailed æ˜¯å¾ˆå‘çˆ¹çš„çŠ¶æ€,å‡ºç°è¿™ä¸ªçŠ¶æ€æ—¶,è¡¨ç¤º kubelet å°è¯•å›æ”¶ç£ç›˜å¤±è´¥,è¿™æ—¶å¾—è€ƒè™‘æ˜¯å¦è¦æ‰‹åŠ¨ä¸Šæœºä¿®å¤äº†.</p>

<p>å»ºè®®:</p>

<ol>
  <li>é•œåƒæ•°é‡åœ¨200ä»¥ä¸Šæ—¶,é‡‡è´­100G SSDå­˜é•œåƒ</li>
  <li>å°‘ç”¨ä¸´æ—¶å­˜å‚¨(empty-dir,hostpathä¹‹ç±»çš„)</li>
</ol>

<p>å‚è€ƒé“¾æ¥:</p>

<ol>
  <li><a href="https://kubernetes.io/docs/tasks/administer-cluster/out-of-resource/#eviction-signals">Eviction Signals</a></li>
  <li><a href="http://dockone.io/article/783">10å¼ å›¾å¸¦ä½ æ·±å…¥ç†è§£Dockerå®¹å™¨å’Œé•œåƒ</a></li>
</ol>

<h3 id="èŠ‚ç‚¹cpuå½ªé«˜">èŠ‚ç‚¹CPUå½ªé«˜</h3>

<p>æœ‰å¯èƒ½æ˜¯èŠ‚ç‚¹åœ¨è¿›è¡ŒGC(container GC/image GC),ç”¨<code class="highlighter-rouge">describe node</code>æŸ¥æŸ¥.æˆ‘æœ‰æ¬¡é‡åˆ°è¿™ç§çŠ¶å†µ,æœ€åèŠ‚ç‚¹ä¸Šçš„å®¹å™¨å°‘äº†å¾ˆå¤š,ä¹Ÿæ˜¯æœ‰ç‚¹éƒé—·</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>Events:
  Type     Reason                 Age                 From                                         Message
  ----     ------                 ----                ----
  Warning  ImageGCFailed          45m                 kubelet, cn-shenzhen.xxxx  failed to get image stats: rpc error: code = DeadlineExceeded desc = context deadline exceeded
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å‚è€ƒ:</p>

<p><a href="https://cizixs.com/2017/06/09/kubelet-source-code-analysis-part-3/">kubelet æºç åˆ†æï¼šGarbage Collect</a></p>

<h3 id="èŠ‚ç‚¹å¤±è”unknown">èŠ‚ç‚¹å¤±è”(unknown)</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>  Ready                False   Fri, 28 Jun 2019 10:19:21 +0800   Thu, 27 Jun 2019 07:07:38 +0800   KubeletNotReady              PLEG is not healthy: pleg was last seen active 27h14m51.413818128s ago; threshold is 3m0s

Events:
  Type     Reason             Age                 From                                         Message
  ----     ------             ----                ----                                         -------
  Warning  ContainerGCFailed  5s (x543 over 27h)  kubelet, cn-shenzhen.xxxx                    rpc error: code = DeadlineExceeded desc = context deadline exceeded
</pre></td></tr></tbody></table></code></pre></div></div>
<p>sshç™»å½•ä¸»æœºåå‘ç°,dockeræœåŠ¡è™½ç„¶è¿˜åœ¨è¿è¡Œ,ä½†<code class="highlighter-rouge">docker ps</code>å¡ä½äº†.äºæ˜¯æˆ‘é¡ºä¾¿å‡çº§äº†å†…æ ¸åˆ°5.1,ç„¶åé‡å¯.</p>

<p>åæ¥å‘ç°æ˜¯æœ‰ä¸ªäººä¸Šäº†ä¸€ä¸ªé—®é¢˜é•œåƒï¼Œæ— è®ºåœ¨å“ªèŠ‚ç‚¹è¿è¡Œï¼Œéƒ½ä¼šæŠŠèŠ‚ç‚¹æç˜«ï¼Œä¹Ÿæ˜¯é†‰äº†ã€‚</p>

<p>unknown æ˜¯éå¸¸ä¸¥é‡çš„é—®é¢˜,å¿…é¡»è¦äºˆä»¥é‡è§†.èŠ‚ç‚¹å‡ºç° unknown ,kubernetes master è‡ªèº«ä¸çŸ¥é“èŠ‚ç‚¹ä¸Šé¢çš„å®¹å™¨æ˜¯æ­»æ˜¯æ´»,å‡å¦‚æœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„å®¹å™¨åœ¨ unknown èŠ‚ç‚¹ä¸Šé¢è¿è¡Œ,è€Œä¸”ä»–åˆšå¥½åˆæŒ‚äº†,kubernetesæ˜¯ä¸ä¼šè‡ªåŠ¨å¸®ä½ å¦å¯ä¸€ä¸ªå®¹å™¨çš„,è¿™ç‚¹è¦æ³¨æ„.</p>

<p>å‚è€ƒé“¾æ¥:</p>

<p><a href="https://github.com/kubernetes/kubernetes/issues/45419">Node flapping between Ready/NotReady with PLEG issues</a>
<a href="https://my.oschina.net/jxcdwangtao/blog/1594348">æ·±åº¦è§£æKubernetes Pod Disruption Budgets(PDB)</a></p>

<h3 id="systemoom">SystemOOM</h3>

<p><code class="highlighter-rouge">SystemOOM</code> å¹¶ä¸ä¸€å®šæ˜¯æœºå™¨å†…å­˜ç”¨å®Œäº†.æœ‰ä¸€ç§æƒ…å†µæ˜¯docker åœ¨æ§åˆ¶å®¹å™¨çš„å†…å­˜å¯¼è‡´çš„.</p>

<p>é»˜è®¤æƒ…å†µä¸‹Dockerçš„å­˜æ”¾ä½ç½®ä¸ºï¼š/var/lib/docker/containers/$id</p>

<p>è¿™ä¸ªç›®å½•ä¸‹é¢æœ‰ä¸ªé‡è¦çš„æ–‡ä»¶: <code class="highlighter-rouge">hostconfig.json</code>,æˆªå–éƒ¨åˆ†å¤§æ¦‚é•¿è¿™æ ·:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="w">	</span><span class="nl">"MemorySwappiness"</span><span class="p">:</span><span class="w"> </span><span class="mi">-1</span><span class="err">,</span><span class="w">
	</span><span class="nl">"OomKillDisable"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="err">,</span><span class="w">
	</span><span class="nl">"PidsLimit"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="err">,</span><span class="w">
	</span><span class="nl">"Ulimits"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="err">,</span><span class="w">
	</span><span class="nl">"CpuCount"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="err">,</span><span class="w">
	</span><span class="nl">"CpuPercent"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="err">,</span><span class="w">
	</span><span class="nl">"IOMaximumIOps"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="err">,</span><span class="w">
	</span><span class="nl">"IOMaximumBandwidth"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="err">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p><code class="highlighter-rouge">"OomKillDisable": false,</code> ç¦æ­¢äº† docker æœåŠ¡é€šè¿‡æ€è¿›ç¨‹/é‡å¯çš„æ–¹å¼å»å’Œè°ä½¿ç”¨èµ„æºè¶…é™çš„å®¹å™¨,è€Œæ˜¯ä»¥å…¶ä»–çš„æ–¹å¼å»åˆ¶è£(å…·ä½“çš„å¯ä»¥çœ‹<a href="https://docs.docker.com/config/containers/resource_constraints/">è¿™é‡Œ</a>)</p>

<h3 id="docker-daemon-å¡ä½">docker daemon å¡ä½</h3>

<p>è¿™ç§çŠ¶å†µæˆ‘å‡ºç°è¿‡ä¸€æ¬¡,åŸå› æ˜¯æŸä¸ªå®¹å™¨æœ‰æ¯›ç—…,å‘äº†æ•´ä¸ªèŠ‚ç‚¹.</p>

<p>å‡ºç°è¿™ä¸ªé—®é¢˜è¦å°½å¿«è§£å†³,å› ä¸ºèŠ‚ç‚¹ä¸Šé¢æ‰€æœ‰çš„ pod éƒ½ä¼šå˜æˆ unknown .</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>systemctl daemon-reexec
systemctl restart docker<span class="o">(</span>å¯é€‰è§†æƒ…å†µå®š<span class="o">)</span>
systemctl restart kubelet
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä¸¥é‡æ—¶åªèƒ½é‡å¯èŠ‚ç‚¹,åœæ­¢æ¶‰äº‹å®¹å™¨.</p>

<p>å»ºè®®: <code class="highlighter-rouge">å¯¹äºå®¹å™¨çš„liveness/readiness ä½¿ç”¨tcp/httpgetçš„æ–¹å¼ï¼Œé¿å… é«˜é¢‘ç‡ä½¿ç”¨exec</code></p>
<h2 id="pod">pod</h2>

<h3 id="podé¢‘ç¹é‡å¯">podé¢‘ç¹é‡å¯</h3>

<p>åŸå› æœ‰å¤šç§,ä¸å¯ä¸€æ¦‚è€Œè®º</p>

<p>æœ‰ä¸€ç§æƒ…å†µæ˜¯,deployé…ç½®äº†å¥åº·æ£€æŸ¥,èŠ‚ç‚¹è¿è¡Œæ­£å¸¸,ä½†æ˜¯å› ä¸ºèŠ‚ç‚¹è´Ÿè½½è¿‡é«˜å¯¼è‡´äº†å¥åº·æ£€æŸ¥å¤±è´¥(load15é•¿æœŸå¤§äº2ä»¥ä¸Š),é¢‘ç¹Backoff.æˆ‘è°ƒé«˜äº†ä¸å¥åº·é˜ˆå€¼ä¹‹å,é™ä½èŠ‚ç‚¹è´Ÿè½½ä¹‹å,é—®é¢˜è§£å†³</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>
          <span class="na">livenessProbe</span><span class="pi">:</span>
            <span class="c1"># ä¸å¥åº·é˜ˆå€¼</span>
            <span class="na">failureThreshold</span><span class="pi">:</span> <span class="m">3</span>
            <span class="na">initialDelaySeconds</span><span class="pi">:</span> <span class="m">5</span>
            <span class="na">periodSeconds</span><span class="pi">:</span> <span class="m">10</span>
            <span class="na">successThreshold</span><span class="pi">:</span> <span class="m">1</span>
            <span class="na">tcpSocket</span><span class="pi">:</span>
              <span class="na">port</span><span class="pi">:</span> <span class="m">8080</span>
            <span class="na">timeoutSeconds</span><span class="pi">:</span> <span class="m">1</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="èµ„æºè¾¾åˆ°limitè®¾ç½®å€¼">èµ„æºè¾¾åˆ°limitè®¾ç½®å€¼</h3>

<p>è°ƒé«˜limitæˆ–è€…æ£€æŸ¥åº”ç”¨</p>

<h3 id="readinessliveness-connection-refused">Readiness/Liveness connection refused</h3>

<p>Readinessæ£€æŸ¥å¤±è´¥çš„ä¹Ÿä¼šé‡å¯,ä½†æ˜¯<code class="highlighter-rouge">Readiness</code>æ£€æŸ¥å¤±è´¥ä¸ä¸€å®šæ˜¯åº”ç”¨çš„é—®é¢˜,å¦‚æœèŠ‚ç‚¹æœ¬èº«è´Ÿè½½è¿‡é‡,ä¹Ÿæ˜¯ä¼šå‡ºç°connection refusedæˆ–è€…timeout</p>

<p>è¿™ä¸ªé—®é¢˜è¦ä¸ŠèŠ‚ç‚¹æ’æŸ¥</p>

<h3 id="podè¢«é©±é€evicted">podè¢«é©±é€(Evicted)</h3>

<ol>
  <li>èŠ‚ç‚¹åŠ äº†æ±¡ç‚¹å¯¼è‡´podè¢«é©±é€</li>
  <li>ephemeral-storageè¶…è¿‡é™åˆ¶è¢«é©±é€
    <ol>
      <li>EmptyDir çš„ä½¿ç”¨é‡è¶…è¿‡äº†ä»–çš„ SizeLimitï¼Œé‚£ä¹ˆè¿™ä¸ª pod å°†ä¼šè¢«é©±é€</li>
      <li>Container çš„ä½¿ç”¨é‡ï¼ˆlogï¼Œå¦‚æœæ²¡æœ‰ overlay åˆ†åŒºï¼Œåˆ™åŒ…æ‹¬ imagefsï¼‰è¶…è¿‡äº†ä»–çš„ limitï¼Œåˆ™è¿™ä¸ª pod ä¼šè¢«é©±é€</li>
      <li>Pod å¯¹æœ¬åœ°ä¸´æ—¶å­˜å‚¨æ€»çš„ä½¿ç”¨é‡ï¼ˆæ‰€æœ‰ emptydir å’Œ containerï¼‰è¶…è¿‡äº† pod ä¸­æ‰€æœ‰container çš„ limit ä¹‹å’Œï¼Œåˆ™ pod è¢«é©±é€</li>
    </ol>
  </li>
</ol>

<p>ephemeral-storageæ˜¯ä¸€ä¸ªpodç”¨çš„ä¸´æ—¶å­˜å‚¨.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>resources:
       requests: 
           ephemeral-storage: "2Gi"
       limits:
           ephemeral-storage: "3Gi"
</pre></td></tr></tbody></table></code></pre></div></div>
<p>èŠ‚ç‚¹è¢«é©±é€åé€šè¿‡get poè¿˜æ˜¯èƒ½çœ‹åˆ°,ç”¨describeå‘½ä»¤,å¯ä»¥çœ‹åˆ°è¢«é©±é€çš„å†å²åŸå› </p>

<blockquote>
  <p>Message:            The node was low on resource: ephemeral-storage. Container codis-proxy was using 10619440Ki, which exceeds its request of 0.</p>
</blockquote>

<p>å‚è€ƒ:</p>
<ol>
  <li><a href="https://blog.csdn.net/hyneria_hope/article/details/79467922">Kubernetes pod ephemeral-storageé…ç½®</a></li>
  <li><a href="https://kubernetes.io/docs/concepts/configuration/manage-compute-resources-container/">Managing Compute Resources for Containers</a></li>
</ol>

<h3 id="kubectl-exec-è¿›å…¥å®¹å™¨å¤±è´¥">kubectl exec è¿›å…¥å®¹å™¨å¤±è´¥</h3>

<p>è¿™ç§é—®é¢˜æˆ‘åœ¨æ­å»ºcodis-serverçš„æ—¶å€™é‡åˆ°è¿‡,å½“æ—¶æ²¡æœ‰é…ç½®å°±ç»ªä»¥åŠå¥åº·æ£€æŸ¥.ä½†è·å–podæè¿°çš„æ—¶å€™,æ˜¾ç¤ºrunning.å…¶å®è¿™ä¸ªæ—¶å€™å®¹å™¨ä»¥åŠä¸æ­£å¸¸äº†.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>~ kex codis-server-3 sh
rpc error: code = 2 desc = containerd: container not found
command terminated with exit code 126
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è§£å†³åŠæ³•:åˆ äº†è¿™ä¸ªpod,é…ç½®<code class="highlighter-rouge">livenessProbe</code></p>

<h3 id="podçš„virtual-host-name">podçš„virtual host name</h3>

<p><code class="highlighter-rouge">Deployment</code>è¡ç”Ÿçš„pod,<code class="highlighter-rouge">virtual host name</code>å°±æ˜¯<code class="highlighter-rouge">pod name</code>.</p>

<p><code class="highlighter-rouge">StatefulSet</code>è¡ç”Ÿçš„pod,<code class="highlighter-rouge">virtual host name</code>æ˜¯<code class="highlighter-rouge">&lt;pod name&gt;.&lt;svc name&gt;.&lt;namespace&gt;.svc.cluster.local</code>.ç›¸æ¯”<code class="highlighter-rouge">Deployment</code>æ˜¾å¾—æ›´æœ‰è§„å¾‹ä¸€äº›.è€Œä¸”æ”¯æŒå…¶ä»–podè®¿é—®</p>

<h3 id="podæ¥è¿crashbackoff">podæ¥è¿Crashbackoff</h3>

<p><code class="highlighter-rouge">Crashbackoff</code>æœ‰å¤šç§åŸå› .</p>

<p>æ²™ç®±åˆ›å»º(FailedCreateSandBox)å¤±è´¥,å¤šåŠæ˜¯cniç½‘ç»œæ’ä»¶çš„é—®é¢˜</p>

<p>é•œåƒæ‹‰å–,æœ‰ä¸­å›½ç‰¹è‰²ç¤¾ä¼šä¸»ä¹‰çš„é—®é¢˜,å¯èƒ½å¤ªå¤§äº†,æ‹‰å–è¾ƒæ…¢</p>

<p>ä¹Ÿæœ‰ä¸€ç§å¯èƒ½æ˜¯å®¹å™¨å¹¶å‘è¿‡é«˜,æµé‡é›ªå´©å¯¼è‡´.</p>

<p>æ¯”å¦‚,ç°åœ¨æœ‰3ä¸ªå®¹å™¨abc,açªç„¶é‡åˆ°æµé‡æ´ªå³°å¯¼è‡´å†…éƒ¨å¥”æºƒ,ç»§è€Œ<code class="highlighter-rouge">Crashbackoff</code>,é‚£ä¹ˆaå°±ä¼šè¢«<code class="highlighter-rouge">service</code>å‰”é™¤å‡ºå»,å‰©ä¸‹çš„bcä¹Ÿæ‰¿è½½ä¸äº†é‚£ä¹ˆå¤šæµé‡,æ¥è¿å´©æºƒ,æœ€ç»ˆç½‘ç«™ä¸å¯è®¿é—®.è¿™ç§æƒ…å†µ,å¤šè§äºé«˜å¹¶å‘ç½‘ç«™+ä½æ•ˆç‡webå®¹å™¨.</p>

<p>åœ¨ä¸æ”¹å˜ä»£ç çš„æƒ…å†µä¸‹,æœ€ä¼˜è§£æ˜¯å¢åŠ å‰¯æœ¬æ•°,å¹¶ä¸”åŠ ä¸Šhpa,å®ç°åŠ¨æ€ä¼¸ç¼©å®¹.</p>

<h3 id="dns-æ•ˆç‡ä½ä¸‹">DNS æ•ˆç‡ä½ä¸‹</h3>

<p>å®¹å™¨å†…æ‰“å¼€nscd(åŸŸåç¼“å­˜æœåŠ¡)ï¼Œå¯å¤§å¹…æå‡è§£ææ€§èƒ½</p>

<p>ä¸¥ç¦ç”Ÿäº§ç¯å¢ƒä½¿ç”¨alpineä½œä¸ºåŸºç¡€é•œåƒ(ä¼šå¯¼è‡´dnsè§£æè¯·æ±‚å¼‚å¸¸)</p>

<h2 id="deploy">deploy</h2>

<h3 id="minimumreplicationunavailable">MinimumReplicationUnavailable</h3>

<p>å¦‚æœ<code class="highlighter-rouge">deploy</code>é…ç½®äº†SecurityContext,ä½†æ˜¯api-serveræ‹’ç»äº†,å°±ä¼šå‡ºç°è¿™ä¸ªæƒ…å†µ,åœ¨api-serverçš„å®¹å™¨é‡Œé¢,å»æ‰<code class="highlighter-rouge">SecurityContextDeny</code>è¿™ä¸ªå¯åŠ¨å‚æ•°.</p>

<p>å…·ä½“è§<a href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/">Using Admission Controllers</a></p>

<h2 id="service">service</h2>

<h3 id="å»ºäº†ä¸€ä¸ªæœåŠ¡ä½†æ˜¯æ²¡æœ‰å¯¹åº”çš„poä¼šå‡ºç°ä»€ä¹ˆæƒ…å†µ">å»ºäº†ä¸€ä¸ªæœåŠ¡,ä½†æ˜¯æ²¡æœ‰å¯¹åº”çš„po,ä¼šå‡ºç°ä»€ä¹ˆæƒ…å†µ?</h3>

<p>è¯·æ±‚æ—¶ä¸€ç›´ä¸ä¼šæœ‰å“åº”,ç›´åˆ°request timeout</p>

<p>å‚è€ƒ</p>

<ol>
  <li><a href="https://kubernetes.io/docs/tasks/administer-cluster/out-of-resource/#node-conditions">Configure Out Of Resource Handling</a></li>
</ol>

<h3 id="service-connection-refuse">service connection refuse</h3>

<p>åŸå› å¯èƒ½æœ‰</p>

<ol>
  <li>podæ²¡æœ‰è®¾ç½®readinessProbe,è¯·æ±‚åˆ°æœªå°±ç»ªçš„pod</li>
  <li>kube-proxyå®•æœºäº†(kube-proxyè´Ÿè´£è½¬å‘è¯·æ±‚)</li>
  <li>ç½‘ç»œè¿‡è½½</li>
</ol>

<h3 id="serviceæ²¡æœ‰è´Ÿè½½å‡è¡¡">serviceæ²¡æœ‰è´Ÿè½½å‡è¡¡</h3>

<p>æ£€æŸ¥ä¸€ä¸‹æ˜¯å¦ç”¨äº†<code class="highlighter-rouge">headless service</code>.<code class="highlighter-rouge">headless service</code>æ˜¯ä¸ä¼šè‡ªåŠ¨è´Ÿè½½å‡è¡¡çš„â€¦</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">spec</span><span class="pi">:</span>
<span class="c1"># clusterIP: Noneçš„å³ä¸º`headless service`</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">ClusterIP</span>
  <span class="na">clusterIP</span><span class="pi">:</span> <span class="s">None</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å…·ä½“è¡¨ç°serviceæ²¡æœ‰è‡ªå·±çš„è™šæ‹ŸIP,nslookupä¼šå‡ºç°æ‰€æœ‰podçš„ip.ä½†æ˜¯pingçš„æ—¶å€™åªä¼šå‡ºç°ç¬¬ä¸€ä¸ªpodçš„ip</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre>/ <span class="c"># nslookup consul</span>
nslookup: can<span class="s1">'t resolve '</span><span class="o">(</span>null<span class="o">)</span><span class="s1">': Name does not resolve

Name:      consul
Address 1: 172.31.10.94 172-31-10-94.consul.default.svc.cluster.local
Address 2: 172.31.10.95 172-31-10-95.consul.default.svc.cluster.local
Address 3: 172.31.11.176 172-31-11-176.consul.default.svc.cluster.local

/ # ping consul
PING consul (172.31.10.94): 56 data bytes
64 bytes from 172.31.10.94: seq=0 ttl=62 time=0.973 ms
64 bytes from 172.31.10.94: seq=1 ttl=62 time=0.170 ms
^C
--- consul ping statistics ---
2 packets transmitted, 2 packets received, 0% packet loss
round-trip min/avg/max = 0.170/0.571/0.973 ms

/ # ping consul
PING consul (172.31.10.94): 56 data bytes
64 bytes from 172.31.10.94: seq=0 ttl=62 time=0.206 ms
64 bytes from 172.31.10.94: seq=1 ttl=62 time=0.178 ms
^C
--- consul ping statistics ---
2 packets transmitted, 2 packets received, 0% packet loss
round-trip min/avg/max = 0.178/0.192/0.206 ms
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>æ™®é€šçš„type: ClusterIP service,nslookupä¼šå‡ºç°è¯¥æœåŠ¡è‡ªå·±çš„IP</p>

<pre><code class="language-BASH">/ # nslookup consul
nslookup: can't resolve '(null)': Name does not resolve

Name:      consul
Address 1: 172.30.15.52 consul.default.svc.cluster.local
</code></pre>

<h2 id="replicationcontrollerä¸æ›´æ–°">ReplicationControllerä¸æ›´æ–°</h2>

<p>ReplicationControllerä¸æ˜¯ç”¨applyå»æ›´æ–°çš„,è€Œæ˜¯<code class="highlighter-rouge">kubectl rolling-update</code>,ä½†æ˜¯è¿™ä¸ªæŒ‡ä»¤ä¹ŸåºŸé™¤äº†,å–è€Œä»£ä¹‹çš„æ˜¯<code class="highlighter-rouge">kubectl rollout</code>.æ‰€ä»¥åº”è¯¥ä½¿ç”¨<code class="highlighter-rouge">kubectl rollout</code>ä½œä¸ºæ›´æ–°æ‰‹æ®µ,æˆ–è€…æ‡’ä¸€ç‚¹,apply fileä¹‹å,delete po.</p>

<p>å°½é‡ä½¿ç”¨deployå§.</p>

<h2 id="statefulset">StatefulSet</h2>

<h3 id="pod-æ›´æ–°å¤±è´¥">pod æ›´æ–°å¤±è´¥</h3>

<p>StatefulSetæ˜¯é€ä¸€æ›´æ–°çš„,è§‚å¯Ÿä¸€ä¸‹æ˜¯å¦æœ‰<code class="highlighter-rouge">Crashbackoff</code>çš„å®¹å™¨,æœ‰å¯èƒ½æ˜¯è¿™ä¸ªå®¹å™¨å¯¼è‡´æ›´æ–°å¡ä½äº†,åˆ æ‰å³å¯.</p>

<h3 id="unknown-pod">unknown pod</h3>

<p>å¦‚æœ StatefulSet ç»‘å®š pod çŠ¶æ€å˜æˆ unknown ,è¿™ä¸ªæ—¶å€™æ˜¯éå¸¸å‘çˆ¹çš„,StatefulSetä¸ä¼šå¸®ä½ é‡å»ºpod.</p>

<p>è¿™æ—¶ä¼šå¯¼è‡´å¤–éƒ¨è¯·æ±‚ä¸€ç›´å¤±è´¥.</p>

<p>ç»¼åˆå»ºè®®,ä¸ç”¨ <code class="highlighter-rouge">StatefulSet</code> ,æ”¹ç”¨ operator æ¨¡å¼æ›¿æ¢å®ƒ.</p>

<h2 id="kube-apiserver"><a href="https://kubernetes.io/zh/docs/reference/command-line-tools-reference/kube-apiserver/">kube-apiserver</a></h2>

<p><code class="highlighter-rouge">kube-apiserver</code> æ˜¯ä¸€ç»„è¿è¡Œåœ¨ <code class="highlighter-rouge">master</code> ä¸Šé¢çš„ç‰¹æ®Šå®¹å™¨ã€‚ä»¥ é˜¿é‡Œäº‘ kubernetes ä¸ºä¾‹ ï¼ˆ<code class="highlighter-rouge">kubeadm</code>åˆ›å»ºçš„ kubernetes åŒç†ï¼‰</p>

<p>åœ¨ <code class="highlighter-rouge">/etc/kubernetes/manifests/</code> ä¸‹é¢å®šä¹‰äº†ä¸‰ä¸ªæ–‡ä»¶</p>
<ol>
  <li>kube-apiserver.yaml</li>
  <li>kube-controller-manager.yaml</li>
  <li>kube-scheduler.yaml</li>
</ol>

<p>master èŠ‚ç‚¹ä¼šè‡ªåŠ¨ç›‘è§†è¿™ä¸ªç›®å½•é‡Œé¢æ–‡ä»¶çš„å˜åŒ–ï¼Œè§†æƒ…å†µè‡ªåŠ¨é‡å¯ã€‚</p>

<p>æ‰€ä»¥ä¿®æ”¹ <code class="highlighter-rouge">api server</code> çš„è®¾ç½®åªéœ€è¦ä¿®æ”¹<code class="highlighter-rouge">kube-apiserver.yaml</code>,ä¿å­˜é€€å‡ºï¼Œç›¸åº”çš„å®¹å™¨å°±ä¼šé‡å¯ã€‚åŒç†ï¼Œå¦‚æœä½ æ”¹é”™äº†é…ç½®ï¼Œ<code class="highlighter-rouge">api server</code> å°±ä¼šå¯åŠ¨å¤±è´¥ï¼Œä¿®æ”¹ä¹‹å‰åŠ¡å¿…ä»”ç»†çœ‹æ¸…æ¥š<a href="https://kubernetes.io/zh/docs/concepts/overview/kubernetes-api/">æ–‡æ¡£</a></p>

<h2 id="é˜¿é‡Œäº‘kubernetesé—®é¢˜">é˜¿é‡Œäº‘Kubernetesé—®é¢˜</h2>

<h3 id="ä¿®æ”¹é»˜è®¤ingress">ä¿®æ”¹é»˜è®¤ingress</h3>

<p>æ–°å»ºä¸€ä¸ªæŒ‡å‘ingressçš„è´Ÿè½½å‡è¡¡å‹svc,ç„¶åä¿®æ”¹ä¸€ä¸‹<code class="highlighter-rouge">kube-system</code>ä¸‹<code class="highlighter-rouge">nginx-ingress-controller</code>å¯åŠ¨å‚æ•°.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>        - args:
            - /nginx-ingress-controller
            - '--configmap=$(POD_NAMESPACE)/nginx-configuration'
            - '--tcp-services-configmap=$(POD_NAMESPACE)/tcp-services'
            - '--udp-services-configmap=$(POD_NAMESPACE)/udp-services'
            - '--annotations-prefix=nginx.ingress.kubernetes.io'
            - '--publish-service=$(POD_NAMESPACE)/&lt;è‡ªå®šä¹‰svc&gt;'
            - '--v=2'
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="loadbalanceræœåŠ¡ä¸€ç›´æ²¡æœ‰ip">LoadBalanceræœåŠ¡ä¸€ç›´æ²¡æœ‰IP</h3>

<p>å…·ä½“è¡¨ç°æ˜¯EXTERNAL-IPä¸€ç›´æ˜¾ç¤ºpending.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>~ kg svc consul-web
NAME         TYPE           CLUSTER-IP      EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>         AGE
consul-web   LoadBalancer   172.30.13.122   &lt;pending&gt;     443:32082/TCP   5m  
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¿™é—®é¢˜è·Ÿ<a href="https://yq.aliyun.com/articles/626066">Alibaba Cloud Provider</a>è¿™ä¸ªç»„ä»¶æœ‰å…³,<code class="highlighter-rouge">cloud-controller-manager</code>æœ‰3ä¸ªç»„ä»¶,ä»–ä»¬éœ€è¦å†…éƒ¨é€‰ä¸»,å¯èƒ½å“ªé‡Œå‡ºé”™äº†,å½“æ—¶æˆ‘æŠŠå…¶ä¸­ä¸€ä¸ªå‡ºé—®é¢˜çš„<code class="highlighter-rouge">pod</code>åˆ äº†,å°±å¥½äº†.</p>

<h3 id="æ¸…ç†statefulsetåŠ¨æ€pvc">æ¸…ç†StatefulsetåŠ¨æ€PVC</h3>

<p>ç›®å‰é˜¿é‡Œäº‘<code class="highlighter-rouge">Statefulset</code>åŠ¨æ€PVCç”¨çš„æ˜¯nasã€‚</p>

<ol>
  <li>å¯¹äºè¿™ç§å­˜å‚¨ï¼Œéœ€è¦å…ˆæŠŠå®¹å™¨å‰¯æœ¬å°†ä¸º0ï¼Œæˆ–è€…æ•´ä¸ª<code class="highlighter-rouge">Statefulset</code>åˆ é™¤ã€‚</li>
  <li>åˆ é™¤PVC</li>
  <li>æŠŠnasæŒ‚è½½åˆ°ä»»æ„ä¸€å°æœåŠ¡å™¨ä¸Šé¢ï¼Œç„¶ååˆ é™¤pvcå¯¹åº”nasçš„ç›®å½•ã€‚</li>
</ol>

<h3 id="å‡çº§åˆ°v1126-aliyun1ä¹‹åèŠ‚ç‚¹å¯åˆ†é…å†…å­˜å˜å°‘">å‡çº§åˆ°v1.12.6-aliyun.1ä¹‹åèŠ‚ç‚¹å¯åˆ†é…å†…å­˜å˜å°‘</h3>

<p>è¯¥ç‰ˆæœ¬æ¯ä¸ªèŠ‚ç‚¹ä¿ç•™äº†1Gi,ç›¸å½“äºæ•´ä¸ªé›†ç¾¤å°‘äº†N GB(Nä¸ºèŠ‚ç‚¹æ•°)ä¾›Podåˆ†é….</p>

<p>å¦‚æœèŠ‚ç‚¹æ˜¯4Gçš„,Podè¯·æ±‚3G,æå…¶å®¹æ˜“è¢«é©±é€.</p>

<p>å»ºè®®æé«˜èŠ‚ç‚¹è§„æ ¼.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>Server Version: version.Info{Major:"1", Minor:"12+", GitVersion:"v1.12.6-aliyun.1", GitCommit:"8cb561c", GitTreeState:"", BuildDate:"2019-04-22T11:34:20Z", GoVersion:"go1.10.8", Compiler:"gc", Platform:"linux/amd64"}
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="æ–°åŠ èŠ‚ç‚¹å‡ºç°networkunavailable">æ–°åŠ èŠ‚ç‚¹å‡ºç°NetworkUnavailable</h3>

<p>RouteController failed to create a route</p>

<p>çœ‹ä¸€ä¸‹kubernetes events,æ˜¯å¦å‡ºç°äº†</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>timed out waiting for the condition -&gt; WaitCreate: ceate route for table vtb-wz9cpnsbt11hlelpoq2zh error, Aliyun API Error: RequestId: 7006BF4E-000B-4E12-89F2-F0149D6688E4 Status Code: 400 Code: QuotaExceeded Message: Route entry quota exceeded in this route table  
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å‡ºç°è¿™ä¸ªé—®é¢˜æ˜¯å› ä¸ºè¾¾åˆ°äº†<a href="https://help.aliyun.com/document_detail/27750.html">VPCçš„è‡ªå®šä¹‰è·¯ç”±æ¡ç›®é™åˆ¶</a>,é»˜è®¤æ˜¯48,éœ€è¦æé«˜<code class="highlighter-rouge">vpc_quota_route_entrys_num</code>çš„é…é¢</p>

<h3 id="è®¿é—®loadbalancer-svcéšæœºå‡ºç°æµé‡è½¬å‘å¼‚å¸¸">è®¿é—®LoadBalancer svcéšæœºå‡ºç°æµé‡è½¬å‘å¼‚å¸¸</h3>

<p>è§
<a href="https://github.com/kubernetes/cloud-provider-alibaba-cloud/issues/57">[bug]é˜¿é‡Œäº‘kubernetesç‰ˆä¸æ£€æŸ¥loadbalancer service port,å¯¼è‡´æµé‡è¢«å¼‚å¸¸è½¬å‘</a>
ç®€å•çš„è¯´ï¼ŒåŒSLBä¸èƒ½æœ‰ç›¸åŒçš„svcç«¯å£ï¼Œä¸ç„¶ä¼šçè½¬å‘ã€‚</p>

<p>å®˜æ–¹è¯´æ³•ï¼š</p>
<blockquote>
  <p>å¤ç”¨åŒä¸€ä¸ªSLBçš„å¤šä¸ªServiceä¸èƒ½æœ‰ç›¸åŒçš„å‰ç«¯ç›‘å¬ç«¯å£ï¼Œå¦åˆ™ä¼šé€ æˆç«¯å£å†²çªã€‚</p>
</blockquote>

<h3 id="æ§åˆ¶å°æ˜¾ç¤ºçš„èŠ‚ç‚¹å†…å­˜ä½¿ç”¨ç‡æ€»æ˜¯åå¤§">æ§åˆ¶å°æ˜¾ç¤ºçš„èŠ‚ç‚¹å†…å­˜ä½¿ç”¨ç‡æ€»æ˜¯åå¤§</h3>

<p><a href="https://xuxinkun.github.io/2016/05/16/memory-monitor-with-cgroup/">Dockerå®¹å™¨å†…å­˜ç›‘æ§</a></p>

<p>åŸå› åœ¨äºä»–ä»¬æ§åˆ¶å°ç”¨çš„æ˜¯usage_in_bytes(cache+buffer),æ‰€ä»¥ä¼šæ¯”äº‘ç›‘æ§çœ‹åˆ°çš„æ•°å­—å¤§</p>

<h3 id="ingress-controller-ç„å­¦ä¼˜åŒ–">Ingress Controller ç„å­¦ä¼˜åŒ–</h3>

<p>ä¿®æ”¹ kube-system ä¸‹é¢åä¸º nginx-configuration çš„configmap</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre>proxy-connect-timeout: "75" 
proxy-read-timeout: "75" 
proxy-send-timeout: "75" 
upstream-keepalive-connections: "300" 
upstream-keepalive-timeout: "300" 
upstream-keepalive-requests: "1000" 
keep-alive-requests: "1000" 
keep-alive: "300"
disable-access-log: "true" 
client-header-timeout: "75" 
worker-processes: "16"
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ³¨æ„,æ˜¯ä¸€ä¸ªé¡¹å¯¹åº”ä¸€ä¸ªé…ç½®,è€Œä¸æ˜¯ä¸€ä¸ªæ–‡ä»¶. æ ¼å¼å¤§æ¦‚è¿™æ ·</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>âœ  ~ kg cm nginx-configuration -o yaml
apiVersion: v1
data:
  disable-access-log: "true"
  keep-alive: "300"
  keep-alive-requests: "1000"
  proxy-body-size: 20m
  worker-processes: "16"
  ......
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="pid-é—®é¢˜">pid é—®é¢˜</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>Message: **Liveness probe failed: rpc error: code = 2 desc = oci runtime error: exec failed: container_linux.go:262: starting container process caused "process_linux.go:86: adding pid 30968 to cgroups caused \"failed to write 30968 to cgroup.procs: write /sys/fs/cgroup/cpu,cpuacct/kubepods.slice/kubepods-burstable.slice/kubepods-burstable-podfe4cc065_cc58_11e9_bf64_00163e08cd06.slice/docker-0447a362d2cf4719ae2a4f5ad0f96f702aacf8ee38d1c73b445ce41bdaa8d24a.scope/cgroup.procs: invalid argument\""
</pre></td></tr></tbody></table></code></pre></div></div>

<p>é˜¿é‡Œäº‘åˆå§‹åŒ–èŠ‚ç‚¹ç”¨çš„ centos ç‰ˆæœ¬è€æ—§,å†…æ ¸æ˜¯3.1, Centos7.4çš„å†…æ ¸3.10è¿˜æ²¡æœ‰æ”¯æŒcgroupå¯¹äºpid/fdé™åˆ¶,æ‰€ä»¥ä¼šå‡ºç°è¿™ç±»é—®é¢˜.</p>

<p>å»ºè®®:</p>

<ol>
  <li>æ‰‹åŠ¨ç»´æŠ¤èŠ‚ç‚¹,å‡çº§åˆ°5.xçš„å†…æ ¸(ç›®å‰å·²æœ‰ä¸€äº›èŠ‚ç‚¹å‡çº§åˆ°5.x,ä½†æ˜¯dockerç‰ˆæœ¬è¿˜æ˜¯ 17.6.2 ,æŒç»­è§‚å¯Ÿä¸­~)</li>
  <li>å®‰è£… <a href="https://github.com/AliyunContainerService/node-problem-detector">NPD</a> + <a href="https://github.com/AliyunContainerService/kube-eventer">eventer</a> ,åˆ©ç”¨äº‹ä»¶æœºåˆ¶æé†’ç®¡ç†å‘˜æ‰‹åŠ¨ç»´æŠ¤</li>
</ol>

<h3 id="oss-pvc-failedmount">OSS PVC FailedMount</h3>

<p>å¯ä»¥é€šè¿‡PVåˆ¶å®šaccess key,access secret +PVCçš„æ–¹å¼ä½¿ç”¨OSS.æŸå¤©æŸä¸ªdeployé‡åˆ° FailedMount çš„é—®é¢˜,è”ç³»åˆ°é˜¿é‡Œäº‘çš„å¼€å‘å·¥ç¨‹å¸ˆ,è¯´æ˜¯ flexvolume åœ¨åˆæ¬¡è¿è¡Œçš„èŠ‚ç‚¹ä¸Šé¢è¿è¡Œä¼šæœ‰é—®é¢˜,è¦è®©ä»–â€é‡æ–°æ³¨å†Œâ€</p>

<p>å½±å“åˆ°çš„ç‰ˆæœ¬: registry-vpc.cn-shenzhen.aliyuncs.com/acs/flexvolume:v1.12.6.16-1f4c6cb-aliyun</p>

<p>è§£å†³æ–¹æ¡ˆ:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nb">touch</span> /usr/libexec/kubernetes/kubelet-plugins/volume/exec/alicloud~oss/debug
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å‚è€ƒ(åº”ç”¨è°ƒåº¦ç›¸å…³):</p>
<ol>
  <li><a href="http://dockone.io/article/2587">Kubernetesä¹‹å¥åº·æ£€æŸ¥ä¸æœåŠ¡ä¾èµ–å¤„ç†</a></li>
  <li><a href="https://ieevee.com/tech/2017/04/23/k8s-svc-dependency.html">kuberneteså¦‚ä½•è§£å†³æœåŠ¡ä¾èµ–å‘¢ï¼Ÿ</a></li>
  <li><a href="https://yq.aliyun.com/articles/562440?spm=a2c4e.11153959.0.0.5e0ed55aq1betz">Kubernetesä¹‹è·¯ 1 - Javaåº”ç”¨èµ„æºé™åˆ¶çš„è¿·æ€</a></li>
  <li><a href="https://kubernetes.io/docs/tasks/administer-cluster/cpu-management-policies/#cpu-management-policies">Control CPU Management Policies on the Node</a></li>
  <li><a href="https://kubernetes.io/docs/tasks/administer-cluster/reserve-compute-resources/">Reserve Compute Resources for System Daemons</a></li>
  <li><a href="https://kubernetes.io/docs/tasks/administer-cluster/out-of-resource/">Configure Out Of Resource Handling</a></li>
</ol>
:ET