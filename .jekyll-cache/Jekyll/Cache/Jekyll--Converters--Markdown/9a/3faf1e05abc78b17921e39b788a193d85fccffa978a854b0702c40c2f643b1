I"\–<p>ä½¿ç”¨docker-composeæ¼”ç¤ºredisçš„å„ç§ä½¿ç”¨æƒ…æ™¯,æœ€åä»‹ç»äº†<code class="highlighter-rouge">codis</code>å’Œ<code class="highlighter-rouge">kubernetes</code>æ–¹æ¡ˆ</p>

<h2 id="æ€»ç»“">æ€»ç»“</h2>

<table>
  <thead>
    <tr>
      <th>æ¨¡å¼</th>
      <th>ç‰¹ç‚¹</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>å•æœºç‰ˆ-RDB</td>
      <td>å¤‡ä»½å¿«,ä½†æ•°æ®å¯èƒ½ä¸å®Œæ•´</td>
    </tr>
    <tr>
      <td>å•æœºç‰ˆ-AOF</td>
      <td>å¤‡ä»½æ…¢,ä½†æ˜¯æ•°æ®æ¯”è¾ƒå®Œæ•´</td>
    </tr>
    <tr>
      <td>1ä¸»Nä»</td>
      <td>è¯»å†™åˆ†ç¦»çš„å…¸èŒƒ</td>
    </tr>
    <tr>
      <td>æ ‘çŠ¶ä¸»ä»(Nçº§ç¼“å­˜)</td>
      <td>ä¸ºäº†è§„é¿ä¸»é‡å¯å¯¼è‡´çš„å¤§è§„æ¨¡å…¨é‡å¤åˆ¶,ä½†æ˜¯éœ€è¦ç»´æŒæ¯ä¸€ä¸ªä¸­é—´masterçš„å¥åº·</td>
    </tr>
    <tr>
      <td>ä¸»ä»è‡ªåŠ¨åˆ‡æ¢(Sentinel)</td>
      <td>åœ¨ä¸»ä»çš„åŸºç¡€ä¸ŠåŠ äº†Sentinelè§’è‰²,é€šè¿‡Sentinelå®ç°ä¸»ä»çš„è‡ªåŠ¨åˆ‡æ¢</td>
    </tr>
    <tr>
      <td>é›†ç¾¤(Nä¸»Nä»)</td>
      <td>åŸºäºslotçš„keyåˆ†ç‰‡,å®¢æˆ·ç«¯æ”¯æŒå¾—ä¸æ˜¯å¾ˆå¤š,æ‰€ä»¥ç”¨çš„äººä¸å¤š</td>
    </tr>
  </tbody>
</table>

<h2 id="å•æœºç‰ˆ">å•æœºç‰ˆ</h2>

<h3 id="rdbæ¨¡å¼é»˜è®¤æ¨¡å¼">RDBæ¨¡å¼(é»˜è®¤æ¨¡å¼)</h3>

<p>å®šæœŸå¿«ç…§æ¨¡å¼</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3'</span>
<span class="na">services</span><span class="pi">:</span>   
    <span class="na">redis-master</span><span class="pi">:</span> 
        <span class="na">image</span><span class="pi">:</span> <span class="s">redis</span>
        <span class="na">ports</span><span class="pi">:</span> 
        <span class="pi">-</span> <span class="s2">"</span><span class="s">12660:6379"</span>
        <span class="na">expose</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s2">"</span><span class="s">6379"</span>
        <span class="na">networks</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">default</span>        
        <span class="na">entrypoint</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">redis-server</span>
        <span class="na">volumes</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">./data:/data</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="aofæ¨¡å¼">AOFæ¨¡å¼</h3>

<p>é€ä¸€å†™å…¥,æ•°æ®æ¯”è¾ƒå®Œæ•´,æ–‡ä»¶è¾ƒå¤§,ä½†æ¢å¤è¾ƒæ…¢</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3'</span>
<span class="na">services</span><span class="pi">:</span>   
    <span class="na">redis-master</span><span class="pi">:</span> 
        <span class="na">image</span><span class="pi">:</span> <span class="s">redis</span>
        <span class="na">ports</span><span class="pi">:</span> 
        <span class="pi">-</span> <span class="s2">"</span><span class="s">12660:6379"</span>
        <span class="na">expose</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s2">"</span><span class="s">6379"</span>
        <span class="na">networks</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">default</span>        
        <span class="na">entrypoint</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">redis-server</span> 
        <span class="pi">-</span> <span class="s">--appendonly yes</span>
        <span class="na">volumes</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">./data:/data</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="ä¸»ä»å¤åˆ¶ç‰ˆ">ä¸»ä»å¤åˆ¶ç‰ˆ</h2>

<h3 id="1ä¸»nä»">1ä¸»Nä»</h3>

<p>è¿™ç§æ¨¡å¼ç®€å•ç²—æš´,ä½†æ˜¯masterä¸€æ—¦é‡å¯,å¤šä»èŠ‚ç‚¹å…¨é‡å¤åˆ¶,IOå°†ä¼šæ¯”è¾ƒç¹é‡</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre></td><td class="rouge-code"><pre><span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3'</span>
<span class="na">services</span><span class="pi">:</span>   
    <span class="na">redis-master</span><span class="pi">:</span> 
        <span class="na">image</span><span class="pi">:</span> <span class="s">redis</span>
        <span class="na">ports</span><span class="pi">:</span> 
        <span class="pi">-</span> <span class="s2">"</span><span class="s">12660:6379"</span>
        <span class="na">expose</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s2">"</span><span class="s">6379"</span>
        <span class="na">networks</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">default</span>        
        <span class="na">entrypoint</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">redis-server</span> 
        <span class="pi">-</span> <span class="s">--save 1 </span><span class="m">1</span>
        <span class="na">volumes</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">./data:/data</span>
    <span class="na">redis-slave1</span><span class="pi">:</span> 
        <span class="na">image</span><span class="pi">:</span> <span class="s">redis</span>
        <span class="na">ports</span><span class="pi">:</span> 
        <span class="pi">-</span> <span class="s2">"</span><span class="s">12661:6379"</span>
        <span class="na">expose</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s2">"</span><span class="s">6379"</span>        
        <span class="na">networks</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">default</span>             
        <span class="na">entrypoint</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">redis-server</span> 
        <span class="pi">-</span> <span class="s">--slaveof redis-master </span><span class="m">6379</span>
        <span class="pi">-</span> <span class="s">--slave-serve-stale-data yes</span>
        <span class="c1">#å½“ä»æœºä¸ä¸»æœºæ–­å¼€è¿æ¥æ—¶ï¼Œæˆ–è€…å½“å¤åˆ¶ä»åœ¨è¿›è¡Œæ—¶,slaveä»ç„¶ä¼šå›å¤clientè¯·æ±‚ï¼Œ å°½ç®¡æ•°æ®å¯èƒ½ä¼šå‡ºç°è¿‡æœŸæˆ–è€…å¦‚æœè¿™æ˜¯ç¬¬ä¸€æ¬¡åŒæ­¥ï¼Œæ•°æ®é›†å¯èƒ½ä¸ºç©ºã€‚</span>
        <span class="pi">-</span> <span class="s">--slave-read-only yes</span>
        <span class="c1">#0ä½œä¸ºä¸€ä¸ªç‰¹æ®Šçš„ä¼˜å…ˆçº§ï¼Œæ ‡è¯†è¿™ä¸ªslaveä¸èƒ½ä½œä¸ºmaster </span>
        <span class="pi">-</span> <span class="s">--slave-priority </span><span class="m">100</span>
    <span class="na">redis-slave2</span><span class="pi">:</span> 
        <span class="na">image</span><span class="pi">:</span> <span class="s">redis</span>
        <span class="na">ports</span><span class="pi">:</span> 
        <span class="pi">-</span> <span class="s2">"</span><span class="s">12662:6379"</span>
        <span class="na">expose</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s2">"</span><span class="s">6379"</span>            
        <span class="na">entrypoint</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">redis-server</span>         
        <span class="pi">-</span> <span class="s">--slaveof redis-master </span><span class="m">6379</span>
        <span class="pi">-</span> <span class="s">--slave-serve-stale-data yes</span>
        <span class="c1">#å½“ä»æœºä¸ä¸»æœºæ–­å¼€è¿æ¥æ—¶ï¼Œæˆ–è€…å½“å¤åˆ¶ä»åœ¨è¿›è¡Œæ—¶,slaveä»ç„¶ä¼šå›å¤clientè¯·æ±‚ï¼Œ å°½ç®¡æ•°æ®å¯èƒ½ä¼šå‡ºç°è¿‡æœŸæˆ–è€…å¦‚æœè¿™æ˜¯ç¬¬ä¸€æ¬¡åŒæ­¥ï¼Œæ•°æ®é›†å¯èƒ½ä¸ºç©ºã€‚</span>
        <span class="pi">-</span> <span class="s">--slave-read-only yes</span>
        <span class="c1">#0ä½œä¸ºä¸€ä¸ªç‰¹æ®Šçš„ä¼˜å…ˆçº§ï¼Œæ ‡è¯†è¿™ä¸ªslaveä¸èƒ½ä½œä¸ºmaster </span>
        <span class="pi">-</span> <span class="s">--slave-priority </span><span class="m">100</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="æ ‘çŠ¶ä¸»ä»nçº§ç¼“å­˜">æ ‘çŠ¶ä¸»ä»(Nçº§ç¼“å­˜)</h3>

<p>ä»èŠ‚ç‚¹ä½œä¸ºä¸»èŠ‚ç‚¹.</p>

<p>è¿™ç§æ¨¡å¼è§„é¿äº†å•master</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre></td><td class="rouge-code"><pre><span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3'</span>
<span class="na">services</span><span class="pi">:</span>   
    <span class="na">redis-master</span><span class="pi">:</span> 
        <span class="na">image</span><span class="pi">:</span> <span class="s">redis</span>
        <span class="na">ports</span><span class="pi">:</span> 
        <span class="pi">-</span> <span class="s2">"</span><span class="s">12660:6379"</span>
        <span class="na">expose</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s2">"</span><span class="s">6379"</span>
        <span class="na">networks</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">default</span>        
        <span class="na">entrypoint</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">redis-server</span> 
        <span class="pi">-</span> <span class="s">--save 1 </span><span class="m">1</span>
        <span class="na">volumes</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">./data:/data</span>
    <span class="na">redis-slave1</span><span class="pi">:</span> 
        <span class="na">image</span><span class="pi">:</span> <span class="s">redis</span>
        <span class="na">ports</span><span class="pi">:</span> 
        <span class="pi">-</span> <span class="s2">"</span><span class="s">12661:6379"</span>
        <span class="na">expose</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s2">"</span><span class="s">6379"</span>        
        <span class="na">networks</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">default</span>             
        <span class="na">entrypoint</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">redis-server</span> 
        <span class="pi">-</span> <span class="s">--slaveof redis-master </span><span class="m">6379</span>
        <span class="pi">-</span> <span class="s">--slave-serve-stale-data yes</span>
        <span class="c1">#å½“ä»æœºä¸ä¸»æœºæ–­å¼€è¿æ¥æ—¶ï¼Œæˆ–è€…å½“å¤åˆ¶ä»åœ¨è¿›è¡Œæ—¶,slaveä»ç„¶ä¼šå›å¤clientè¯·æ±‚ï¼Œ å°½ç®¡æ•°æ®å¯èƒ½ä¼šå‡ºç°è¿‡æœŸæˆ–è€…å¦‚æœè¿™æ˜¯ç¬¬ä¸€æ¬¡åŒæ­¥ï¼Œæ•°æ®é›†å¯èƒ½ä¸ºç©ºã€‚</span>
        <span class="pi">-</span> <span class="s">--slave-read-only yes</span>
        <span class="c1">#0ä½œä¸ºä¸€ä¸ªç‰¹æ®Šçš„ä¼˜å…ˆçº§ï¼Œæ ‡è¯†è¿™ä¸ªslaveä¸èƒ½ä½œä¸ºmaster </span>
        <span class="pi">-</span> <span class="s">--slave-priority </span><span class="m">100</span>
        <span class="c1"># - --masterauth xxx</span>
    <span class="na">redis-slave2</span><span class="pi">:</span> 
        <span class="na">image</span><span class="pi">:</span> <span class="s">redis</span>
        <span class="na">ports</span><span class="pi">:</span> 
        <span class="pi">-</span> <span class="s2">"</span><span class="s">12662:6379"</span>
        <span class="na">expose</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s2">"</span><span class="s">6379"</span>            
        <span class="na">entrypoint</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">redis-server</span>         
        <span class="pi">-</span> <span class="s">--slaveof redis-slave1 </span><span class="m">6379</span>
        <span class="pi">-</span> <span class="s">--slave-serve-stale-data yes</span>
        <span class="c1">#å½“ä»æœºä¸ä¸»æœºæ–­å¼€è¿æ¥æ—¶ï¼Œæˆ–è€…å½“å¤åˆ¶ä»åœ¨è¿›è¡Œæ—¶,slaveä»ç„¶ä¼šå›å¤clientè¯·æ±‚ï¼Œ å°½ç®¡æ•°æ®å¯èƒ½ä¼šå‡ºç°è¿‡æœŸæˆ–è€…å¦‚æœè¿™æ˜¯ç¬¬ä¸€æ¬¡åŒæ­¥ï¼Œæ•°æ®é›†å¯èƒ½ä¸ºç©ºã€‚</span>
        <span class="pi">-</span> <span class="s">--slave-read-only yes</span>
        <span class="c1">#0ä½œä¸ºä¸€ä¸ªç‰¹æ®Šçš„ä¼˜å…ˆçº§ï¼Œæ ‡è¯†è¿™ä¸ªslaveä¸èƒ½ä½œä¸ºmaster </span>
        <span class="pi">-</span> <span class="s">--slave-priority </span><span class="m">100</span>
        <span class="c1"># - --masterauth xxx</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="ä¸»ä»è‡ªåŠ¨åˆ‡æ¢sentinelæ¨¡å¼">ä¸»ä»è‡ªåŠ¨åˆ‡æ¢(Sentinelæ¨¡å¼)</h3>

<p>è¿™æ—¶éœ€è¦å¼•å…¥ Sentinel çš„æ¦‚å¿µ</p>

<p>Redis çš„ Sentinel ç³»ç»Ÿç”¨äºç®¡ç†å¤šä¸ª Redis æœåŠ¡å™¨ï¼ˆinstanceï¼‰ï¼Œ è¯¥ç³»ç»Ÿæ‰§è¡Œä»¥ä¸‹ä¸‰ä¸ªä»»åŠ¡ï¼š</p>

<ol>
  <li>ç›‘æ§ï¼ˆMonitoringï¼‰ï¼š Sentinel ä¼šä¸æ–­åœ°æ£€æŸ¥ä½ çš„ä¸»æœåŠ¡å™¨å’Œä»æœåŠ¡å™¨æ˜¯å¦è¿ä½œæ­£å¸¸ã€‚</li>
  <li>æé†’ï¼ˆNotificationï¼‰ï¼š å½“è¢«ç›‘æ§çš„æŸä¸ª Redis æœåŠ¡å™¨å‡ºç°é—®é¢˜æ—¶ï¼Œ Sentinel å¯ä»¥é€šè¿‡ API å‘ç®¡ç†å‘˜æˆ–è€…å…¶ä»–åº”ç”¨ç¨‹åºå‘é€é€šçŸ¥ã€‚</li>
  <li>è‡ªåŠ¨æ•…éšœè¿ç§»ï¼ˆAutomatic failoverï¼‰ï¼š å½“ä¸€ä¸ªä¸»æœåŠ¡å™¨ä¸èƒ½æ­£å¸¸å·¥ä½œæ—¶ï¼Œ Sentinel ä¼šå¼€å§‹ä¸€æ¬¡è‡ªåŠ¨æ•…éšœè¿ç§»æ“ä½œï¼Œ å®ƒä¼šå°†å¤±æ•ˆä¸»æœåŠ¡å™¨çš„å…¶ä¸­ä¸€ä¸ªä»æœåŠ¡å™¨å‡çº§ä¸ºæ–°çš„ä¸»æœåŠ¡å™¨ï¼Œ å¹¶è®©å¤±æ•ˆä¸»æœåŠ¡å™¨çš„å…¶ä»–ä»æœåŠ¡å™¨æ”¹ä¸ºå¤åˆ¶æ–°çš„ä¸»æœåŠ¡å™¨ï¼› å½“å®¢æˆ·ç«¯è¯•å›¾è¿æ¥å¤±æ•ˆçš„ä¸»æœåŠ¡å™¨æ—¶ï¼Œ é›†ç¾¤ä¹Ÿä¼šå‘å®¢æˆ·ç«¯è¿”å›æ–°ä¸»æœåŠ¡å™¨çš„åœ°å€ï¼Œ ä½¿å¾—é›†ç¾¤å¯ä»¥ä½¿ç”¨æ–°ä¸»æœåŠ¡å™¨ä»£æ›¿å¤±æ•ˆæœåŠ¡å™¨ã€‚</li>
</ol>

<p><a href="https://raw.githubusercontent.com/antirez/redis/unstable/sentinel.conf">é»˜è®¤çš„Sentinelé…ç½®</a>å»æ‰æ³¨é‡Šåé•¿è¿™æ ·</p>

<div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="n">port</span> <span class="m">26379</span>
<span class="n">daemonize</span> <span class="n">no</span>
<span class="n">pidfile</span> /<span class="n">var</span>/<span class="n">run</span>/<span class="n">redis</span>-<span class="n">sentinel</span>.<span class="n">pid</span>
<span class="n">logfile</span> <span class="s2">""</span>
<span class="n">dir</span> /<span class="n">tmp</span>
<span class="c"># ç›‘è§†ä¸»æœåŠ¡å™¨,ä¸‹çº¿masteréœ€è¦2ä¸ªSentinelåŒæ„
</span><span class="n">sentinel</span> <span class="n">monitor</span> <span class="n">mymaster</span> <span class="n">redis</span>-<span class="n">master</span> <span class="m">6379</span> <span class="m">2</span>
<span class="c"># 30ç§’å†…æœ‰æ•ˆå›å¤è§†ä¸ºmasterå¥åº·,å¦åˆ™ä¸‹çº¿
</span><span class="n">sentinel</span> <span class="n">down</span>-<span class="n">after</span>-<span class="n">milliseconds</span> <span class="n">mymaster</span> <span class="m">30000</span>
<span class="c"># æ•…éšœè½¬ç§»æ—¶,ä»æœåŠ¡å™¨åŒéƒ¨æ•°æœ€å¤§å€¼
</span><span class="n">sentinel</span> <span class="n">parallel</span>-<span class="n">syncs</span> <span class="n">mymaster</span> <span class="m">1</span>
<span class="c"># 1. åŒä¸€ä¸ªsentinelå¯¹åŒä¸€ä¸ªmasterä¸¤æ¬¡failoverä¹‹é—´çš„é—´éš”æ—¶é—´ã€‚
# 2. å½“ä¸€ä¸ªslaveä»ä¸€ä¸ªé”™è¯¯çš„masteré‚£é‡ŒåŒæ­¥æ•°æ®å¼€å§‹è®¡ç®—æ—¶é—´ã€‚ç›´åˆ°slaveè¢«çº æ­£ä¸ºå‘æ­£ç¡®çš„masteré‚£é‡ŒåŒæ­¥æ•°æ®æ—¶ã€‚
# 3.å½“æƒ³è¦å–æ¶ˆä¸€ä¸ªæ­£åœ¨è¿›è¡Œçš„failoveræ‰€éœ€è¦çš„æ—¶é—´ã€‚  
# 4.å½“è¿›è¡Œfailoveræ—¶ï¼Œé…ç½®æ‰€æœ‰slavesæŒ‡å‘æ–°çš„masteræ‰€éœ€çš„æœ€å¤§æ—¶é—´ã€‚ä¸è¿‡ï¼Œå³ä½¿è¿‡äº†è¿™ä¸ªè¶…æ—¶ï¼Œslavesä¾ç„¶ä¼šè¢«æ­£ç¡®é…ç½®ä¸ºæŒ‡å‘masterï¼Œä½†æ˜¯å°±ä¸æŒ‰parallel-syncsæ‰€é…ç½®çš„è§„åˆ™æ¥äº†ã€‚
</span><span class="n">sentinel</span> <span class="n">failover</span>-<span class="n">timeout</span> <span class="n">mymaster</span> <span class="m">90000</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>åŸºæœ¬æ ¼å¼æ˜¯<code class="highlighter-rouge">sentinel &lt;é€‰é¡¹çš„åå­—&gt; &lt;ä¸»æœåŠ¡å™¨çš„åå­—&gt; &lt;é€‰é¡¹çš„å€¼&gt;</code></p>

<p>åŸæœ¬æˆ‘æƒ³é€šè¿‡<code class="highlighter-rouge">docker-compose up --scale redis-sentinel=3</code>ç›´æ¥å¯åŠ¨3ä¸ªå®¹å™¨,ç»“æœå‘ç°è¿™å®¹å™¨ç«Ÿç„¶ä¼šä¿®æ”¹é…ç½®æ–‡ä»¶,æ‰€ä»¥åªèƒ½åˆ†å¼€å†™äº†</p>

<h4 id="åˆç‰ˆ">åˆç‰ˆ</h4>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
</pre></td><td class="rouge-code"><pre><span class="c1"># docker-compose up --scale redis-sentinel=3 è™½ç„¶å¯ä»¥å¯åŠ¨,ä½†æ˜¯3ä¸ªå®¹å™¨åŒæ—¶å†™åŒä¸€ä¸ªæ–‡ä»¶,æ„Ÿè§‰ä¸æ˜¯å¾ˆå¥½</span>
<span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3'</span>
<span class="na">services</span><span class="pi">:</span>   
    <span class="na">redis-master</span><span class="pi">:</span> 
        <span class="na">image</span><span class="pi">:</span> <span class="s">redis</span>
        <span class="na">ports</span><span class="pi">:</span> 
        <span class="pi">-</span> <span class="s2">"</span><span class="s">12660:6379"</span>
        <span class="na">expose</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s2">"</span><span class="s">6379"</span>  
        <span class="na">entrypoint</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">redis-server</span> 
        <span class="pi">-</span> <span class="s">--save 1 </span><span class="m">1</span>
        <span class="na">volumes</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">./data:/data</span>
        <span class="c1"># é‡å¯ç­–ç•¥æ”¹ä¸ºnoæ‰‹åŠ¨è®©ä»–å®•æœºæ¨¡æ‹Ÿä¸»ä»åˆ‡æ¢</span>
        <span class="na">restart</span><span class="pi">:</span> <span class="s2">"</span><span class="s">no"</span>
    <span class="na">redis-slave1</span><span class="pi">:</span> 
        <span class="na">image</span><span class="pi">:</span> <span class="s">redis</span>
        <span class="na">ports</span><span class="pi">:</span> 
        <span class="pi">-</span> <span class="s2">"</span><span class="s">12661:6379"</span>
        <span class="na">expose</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s2">"</span><span class="s">6379"</span>          
        <span class="na">entrypoint</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">redis-server</span> 
        <span class="pi">-</span> <span class="s">--slaveof redis-master </span><span class="m">6379</span>
        <span class="pi">-</span> <span class="s">--slave-serve-stale-data yes</span>
        <span class="c1">#å½“ä»æœºä¸ä¸»æœºæ–­å¼€è¿æ¥æ—¶ï¼Œæˆ–è€…å½“å¤åˆ¶ä»åœ¨è¿›è¡Œæ—¶,slaveä»ç„¶ä¼šå›å¤clientè¯·æ±‚ï¼Œ å°½ç®¡æ•°æ®å¯èƒ½ä¼šå‡ºç°è¿‡æœŸæˆ–è€…å¦‚æœè¿™æ˜¯ç¬¬ä¸€æ¬¡åŒæ­¥ï¼Œæ•°æ®é›†å¯èƒ½ä¸ºç©ºã€‚</span>
        <span class="pi">-</span> <span class="s">--slave-read-only yes</span>
        <span class="c1">#0ä½œä¸ºä¸€ä¸ªç‰¹æ®Šçš„ä¼˜å…ˆçº§ï¼Œæ ‡è¯†è¿™ä¸ªslaveä¸èƒ½ä½œä¸ºmaster </span>
        <span class="pi">-</span> <span class="s">--slave-priority </span><span class="m">100</span>
        <span class="c1"># - --masterauth xxx</span>
    <span class="na">redis-slave2</span><span class="pi">:</span> 
        <span class="na">image</span><span class="pi">:</span> <span class="s">redis</span>
        <span class="na">ports</span><span class="pi">:</span> 
        <span class="pi">-</span> <span class="s2">"</span><span class="s">12662:6379"</span>
        <span class="na">expose</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s2">"</span><span class="s">6379"</span>            
        <span class="na">entrypoint</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">redis-server</span>         
        <span class="pi">-</span> <span class="s">--slaveof redis-slave1 </span><span class="m">6379</span>
        <span class="pi">-</span> <span class="s">--slave-serve-stale-data yes</span>
        <span class="c1">#å½“ä»æœºä¸ä¸»æœºæ–­å¼€è¿æ¥æ—¶ï¼Œæˆ–è€…å½“å¤åˆ¶ä»åœ¨è¿›è¡Œæ—¶,slaveä»ç„¶ä¼šå›å¤clientè¯·æ±‚ï¼Œ å°½ç®¡æ•°æ®å¯èƒ½ä¼šå‡ºç°è¿‡æœŸæˆ–è€…å¦‚æœè¿™æ˜¯ç¬¬ä¸€æ¬¡åŒæ­¥ï¼Œæ•°æ®é›†å¯èƒ½ä¸ºç©ºã€‚</span>
        <span class="pi">-</span> <span class="s">--slave-read-only yes</span>
        <span class="c1">#0ä½œä¸ºä¸€ä¸ªç‰¹æ®Šçš„ä¼˜å…ˆçº§ï¼Œæ ‡è¯†è¿™ä¸ªslaveä¸èƒ½ä½œä¸ºmaster </span>
        <span class="pi">-</span> <span class="s">--slave-priority </span><span class="m">100</span>
        <span class="c1"># - --masterauth xxx</span>
    <span class="na">redis-sentinel</span><span class="pi">:</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">redis</span>
        <span class="na">expose</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s2">"</span><span class="s">26379"</span>
        <span class="na">entrypoint</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">redis-server</span>
        <span class="pi">-</span> <span class="s">/usr/local/etc/redis/redis.conf</span>
        <span class="pi">-</span> <span class="s">--sentinel</span>
        <span class="na">volumes</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">./redis-sentinel.conf:/usr/local/etc/redis/redis.conf</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="æœ€ç»ˆç‰ˆ">æœ€ç»ˆç‰ˆ:</h4>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
</pre></td><td class="rouge-code"><pre><span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3'</span>
<span class="na">services</span><span class="pi">:</span>   
    <span class="na">redis-master</span><span class="pi">:</span> 
        <span class="na">image</span><span class="pi">:</span> <span class="s">redis</span>
        <span class="na">ports</span><span class="pi">:</span> 
        <span class="pi">-</span> <span class="s2">"</span><span class="s">12660:6379"</span>
        <span class="na">expose</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s2">"</span><span class="s">6379"</span>  
        <span class="na">entrypoint</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">redis-server</span> 
        <span class="pi">-</span> <span class="s">--save 1 </span><span class="m">1</span>
        <span class="na">volumes</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">./data:/data</span>
        <span class="c1"># é‡å¯ç­–ç•¥æ”¹ä¸ºnoæ‰‹åŠ¨è®©ä»–å®•æœºæ¨¡æ‹Ÿä¸»ä»åˆ‡æ¢</span>
        <span class="na">restart</span><span class="pi">:</span> <span class="s2">"</span><span class="s">no"</span>
    <span class="na">redis-slave1</span><span class="pi">:</span> 
        <span class="na">image</span><span class="pi">:</span> <span class="s">redis</span>
        <span class="na">ports</span><span class="pi">:</span> 
        <span class="pi">-</span> <span class="s2">"</span><span class="s">12661:6379"</span>
        <span class="na">expose</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s2">"</span><span class="s">6379"</span>          
        <span class="na">entrypoint</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">redis-server</span> 
        <span class="pi">-</span> <span class="s">--slaveof redis-master </span><span class="m">6379</span>
        <span class="pi">-</span> <span class="s">--slave-serve-stale-data yes</span>
        <span class="c1">#å½“ä»æœºä¸ä¸»æœºæ–­å¼€è¿æ¥æ—¶ï¼Œæˆ–è€…å½“å¤åˆ¶ä»åœ¨è¿›è¡Œæ—¶,slaveä»ç„¶ä¼šå›å¤clientè¯·æ±‚ï¼Œ å°½ç®¡æ•°æ®å¯èƒ½ä¼šå‡ºç°è¿‡æœŸæˆ–è€…å¦‚æœè¿™æ˜¯ç¬¬ä¸€æ¬¡åŒæ­¥ï¼Œæ•°æ®é›†å¯èƒ½ä¸ºç©ºã€‚</span>
        <span class="pi">-</span> <span class="s">--slave-read-only yes</span>
        <span class="c1">#0ä½œä¸ºä¸€ä¸ªç‰¹æ®Šçš„ä¼˜å…ˆçº§ï¼Œæ ‡è¯†è¿™ä¸ªslaveä¸èƒ½ä½œä¸ºmaster </span>
        <span class="pi">-</span> <span class="s">--slave-priority </span><span class="m">100</span>
        <span class="c1"># - --masterauth xxx</span>
    <span class="na">redis-slave2</span><span class="pi">:</span> 
        <span class="na">image</span><span class="pi">:</span> <span class="s">redis</span>
        <span class="na">ports</span><span class="pi">:</span> 
        <span class="pi">-</span> <span class="s2">"</span><span class="s">12662:6379"</span>
        <span class="na">expose</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s2">"</span><span class="s">6379"</span>            
        <span class="na">entrypoint</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">redis-server</span>         
        <span class="pi">-</span> <span class="s">--slaveof redis-slave1 </span><span class="m">6379</span>
        <span class="pi">-</span> <span class="s">--slave-serve-stale-data yes</span>
        <span class="c1">#å½“ä»æœºä¸ä¸»æœºæ–­å¼€è¿æ¥æ—¶ï¼Œæˆ–è€…å½“å¤åˆ¶ä»åœ¨è¿›è¡Œæ—¶,slaveä»ç„¶ä¼šå›å¤clientè¯·æ±‚ï¼Œ å°½ç®¡æ•°æ®å¯èƒ½ä¼šå‡ºç°è¿‡æœŸæˆ–è€…å¦‚æœè¿™æ˜¯ç¬¬ä¸€æ¬¡åŒæ­¥ï¼Œæ•°æ®é›†å¯èƒ½ä¸ºç©ºã€‚</span>
        <span class="pi">-</span> <span class="s">--slave-read-only yes</span>
        <span class="c1">#0ä½œä¸ºä¸€ä¸ªç‰¹æ®Šçš„ä¼˜å…ˆçº§ï¼Œæ ‡è¯†è¿™ä¸ªslaveä¸èƒ½ä½œä¸ºmaster </span>
        <span class="pi">-</span> <span class="s">--slave-priority </span><span class="m">100</span>
        <span class="c1"># - --masterauth xxx</span>
    <span class="na">redis-sentinel1</span><span class="pi">:</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">redis</span>
        <span class="na">expose</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s2">"</span><span class="s">26379"</span>
        <span class="na">entrypoint</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">redis-server</span>
        <span class="pi">-</span> <span class="s">/usr/local/etc/redis/redis.conf</span>
        <span class="pi">-</span> <span class="s">--sentinel</span>
        <span class="na">volumes</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">./redis-sentinel1.conf:/usr/local/etc/redis/redis.conf</span>
    <span class="na">redis-sentinel2</span><span class="pi">:</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">redis</span>
        <span class="na">expose</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s2">"</span><span class="s">26379"</span>
        <span class="na">entrypoint</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">redis-server</span>
        <span class="pi">-</span> <span class="s">/usr/local/etc/redis/redis.conf</span>
        <span class="pi">-</span> <span class="s">--sentinel</span>
        <span class="na">volumes</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">./redis-sentinel2.conf:/usr/local/etc/redis/redis.conf</span>
    <span class="na">redis-sentinel3</span><span class="pi">:</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">redis</span>
        <span class="na">expose</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s2">"</span><span class="s">26379"</span>
        <span class="na">entrypoint</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">redis-server</span>
        <span class="pi">-</span> <span class="s">/usr/local/etc/redis/redis.conf</span>
        <span class="pi">-</span> <span class="s">--sentinel</span>
        <span class="na">volumes</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">./redis-sentinel3.conf:/usr/local/etc/redis/redis.conf</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>sentinelå¯åŠ¨ä¹‹å,é…ç½®å‘ç”Ÿäº†å˜åŒ–</p>

<p>è¿™äº›å†…å®¹æ²¡äº†</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>sentinel monitor mymaster redis-master 6379 2
sentinel down-after-milliseconds mymaster 30000
sentinel parallel-syncs mymaster 1
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å˜æˆ</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>sentinel myid 3ae98d6815c1a9b941f8283b7e48bfeef7435905
sentinel deny-scripts-reconfig yes
# Generated by CONFIG REWRITE
sentinel config-epoch mymaster 0
sentinel leader-epoch mymaster 0
sentinel known-replica mymaster 172.24.0.4 6379
sentinel known-sentinel mymaster 172.24.0.7 26379 19ac7e0519e3c30a75e23bac34a7033594256c54
sentinel known-sentinel mymaster 172.24.0.5 26379 c596734a7f55ba2b6c7e3e81562aa6687e45fdeb
sentinel current-epoch 0
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ä¹‹åé€šè¿‡<code class="highlighter-rouge">docker ps</code>å’Œ<code class="highlighter-rouge">docker stop</code>æ‰‹åŠ¨åœæ‰äº†masteré‚£ä¸ªå®¹å™¨,sentinelå‘è§‰äº†,å¹¶é‡æ–°é€‰ä¸».</p>

<p>æ­¤æ—¶é€šè¿‡<code class="highlighter-rouge">redis-cli</code>è¾“å…¥info,å‘ç°å®ƒå·²ç»æˆåŠŸå˜æˆäº†å¯ä»¥å†™å…¥æ•°æ®çš„<code class="highlighter-rouge">master</code></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre># Generated by CONFIG REWRITE
sentinel config-epoch mymaster 1
sentinel leader-epoch mymaster 1
sentinel known-replica mymaster 172.24.0.3 6379
sentinel known-replica mymaster 172.24.0.2 6379
sentinel known-sentinel mymaster 172.24.0.7 26379 19ac7e0519e3c30a75e23bac34a7033594256c54
sentinel known-sentinel mymaster 172.24.0.5 26379 c596734a7f55ba2b6c7e3e81562aa6687e45fdeb
sentinel current-epoch 1
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ­¤æ—¶é‡å¯master,è™½ç„¶ä»–ä»¥serverå½¢å¼å¯åŠ¨,ä½†æ˜¯è§’è‰²å·²ç»è‡ªåŠ¨è¢«è´¬ä¸ºslave.</p>

<p>æ­¤æ—¶masteræ²¡æœ‰å˜åŒ–,æ‰€ä»¥sentinelçš„é…ç½®å†…å®¹æ²¡æœ‰å˜</p>

<h2 id="é›†ç¾¤ç‰ˆnä¸»nä»">é›†ç¾¤ç‰ˆ(Nä¸»Nä»)</h2>

<p>é›†ç¾¤åŸºäº16384ä¸ªslotåšåˆ†ç‰‡.ç›®å‰å„è¯­è¨€å®¢æˆ·ç«¯å®ç°æ¯”è¾ƒå°‘.æ‰€ä»¥ç”¨çš„äººä¸æ˜¯å¾ˆå¤š.</p>

<p>åœ¨dockerä¸­è¿è¡Œæ—¶,éœ€è¦ä½¿ç”¨hostç½‘ç»œæ¨¡å¼(â€“net=host)</p>

<h3 id="redis-tribrb">redis-trib.rb</h3>

<p>redisç‰ˆæœ¬&lt;5æ—¶,å¯ä»¥ç”¨<code class="highlighter-rouge">redis-trib.rb</code>å»ºé›†ç¾¤</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>./redis-trib.rb create <span class="nt">--replicas</span> 1 127.0.0.1:7000 127.0.0.1:7001 <span class="se">\</span>
127.0.0.1:7002 127.0.0.1:7003 127.0.0.1:7004 127.0.0.1:7005

<span class="c"># å¼•å…¥æ–°èŠ‚ç‚¹</span>
./redis-trib.rb add-node 127.0.0.1:7006 &lt;ä»»æ„èŠ‚ç‚¹IP&gt;:&lt;èŠ‚ç‚¹ç«¯å£&gt;

<span class="c"># é‡æ–°åˆ†ç‰‡</span>
./redis-trib.rb reshard &lt;ä»»æ„èŠ‚ç‚¹IP&gt;:&lt;èŠ‚ç‚¹ç«¯å£&gt;

</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="redis-cli">redis-cli</h3>

<blockquote>
  <p>=5ç›´æ¥ç”¨redis-cliå³å¯.</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre>redis-cli <span class="nt">--cluster</span> create 127.0.0.1:7000 127.0.0.1:7001 <span class="se">\</span>
127.0.0.1:7002 127.0.0.1:7003 127.0.0.1:7004 127.0.0.1:7005 <span class="se">\</span>
<span class="nt">--cluster-replicas</span> 1
redis-cli <span class="nt">--cluster</span> reshard 127.0.0.1:7000
redis-cli reshard &lt;host&gt;:&lt;port&gt; <span class="nt">--cluster-from</span> &lt;node-id&gt; <span class="nt">--cluster-to</span> &lt;node-id&gt; <span class="nt">--cluster-slots</span> &lt;number of slots&gt; <span class="nt">--cluster-yes</span>
redis-cli <span class="nt">--cluster</span> add-node 127.0.0.1:7006 127.0.0.1:7000
<span class="c"># Adding a new node as a replica</span>
redis-cli <span class="nt">--cluster</span> add-node 127.0.0.1:7006 127.0.0.1:7000 <span class="nt">--cluster-slave</span>
redis-cli <span class="nt">--cluster</span> add-node 127.0.0.1:7006 127.0.0.1:7000 <span class="nt">--cluster-slave</span> <span class="nt">--cluster-master-id</span> 3c3a0c74aae0b56170ccb03a76b60cfe7dc1912e
redis-cli <span class="nt">--cluster</span> del-node 127.0.0.1:7000 <span class="sb">`</span>&lt;node-id&gt;<span class="sb">`</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="é›†ç¾¤æŒ‡ä»¤">é›†ç¾¤æŒ‡ä»¤</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>CLUSTER REPLICATE &lt;master-node-id&gt;
cluster nodes
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="kubernetes">Kubernetes</h2>

<p>ä¸ªäººè§‰å¾—å§,redisè·ŸKubernetesä¸æ˜¯ç‰¹åˆ«å¥‘åˆ.kubernetesæœ¬èº«æœ‰ç½‘ç»œç“¶é¢ˆçš„é—®é¢˜,é€šè¿‡svcå»è®¿é—®,é¢‘ç¹DNSè§£æä¹Ÿä¸å¥½å¯¹å§.è¿™å¯¹äºé«˜é¢‘è®¿é—®redisçš„åœºæ™¯æ¥è¯´æ˜¯è‡´å‘½çš„.</p>

<p>è€Œä¸”podè¿™ç§æ˜“å¤±æ¶æ„æ³¨å®šäº†åœ¨Kubernetesä¸Šé¢ç”¨redisè¦ä¹ˆç”¨æ•°æ®å·æŒ‚è½½,è¦ä¹ˆç”¨ä¸»ä»è‡ªåŠ¨åˆ‡æ¢æ¨¡å¼(çº¯å†…å­˜çš„è¯è‡³å°‘è¦1ä¸»2ä»,å¹¶ä¸”ç”¨åäº²å’Œåº¦é”™å¼€å½¼æ­¤çš„è¿è¡ŒèŠ‚ç‚¹).</p>

<p>ä¸»ä»å’Œå•æœºç‰ˆå€’å¥½è§£å†³,å•æœºçš„è¯æŒ‚è½½å¥½æ•°æ®å·,ä¸»ä»çš„è¯,ä¸»Redisç”¨StatefulSetæ­ä¸€ä¸ªå®ä¾‹ï¼Œä»Redisç”¨deployã€‚åªè¦é…ç½®å¥½å†…ç½®çš„å¥åº·æ£€æŸ¥ï¼Œè¿é€‰ä¸»å’Œå“¨å…µéƒ½çœä¸‹äº†ã€‚</p>

<p>ä½†æ˜¯é›†ç¾¤ç‰ˆå°±æ¯”è¾ƒéº»çƒ¦.å®˜æ–¹çš„è®¾è®¡è¿˜æ˜¯åå‘äºä¼ ç»ŸäºŒè¿›åˆ¶äººå·¥è¿ç»´,æ²¡æœ‰åšåˆ°äº‘åŸç”Ÿ</p>

<p>çœ‹äº†ä¸€ä¸‹å®˜æ–¹çš„helm chart,ä¹Ÿæ˜¯ç”¨çš„ä¸»ä»æ¨¡å¼.</p>

<p>ä½†ä¸ç®¡ç”¨ä»€ä¹ˆæ¨¡å¼ï¼Œéƒ½è®°ä½CAPåŸç†è¿™ä¸ªç´§ç®å’’ã€‚å½“ä½ ç”¨äº†ä¸»ä»æƒ³å®ç°é«˜å¯ç”¨ï¼Œæœ€ç»ˆåªèƒ½æ”¾å¼ƒä¸€è‡´æ€§è€Œé€‰æ‹©æœ€ç»ˆä¸€è‡´æ€§ï¼›å¦‚æœå¼ºè¡Œä¸ºäº†ä¸€è‡´æ€§ï¼Œé‚£å¿…å®šåªèƒ½é€‰æ‹©å•æœºç‰ˆï¼Œç‰ºç‰²æ‰å®¹é”™æ€§ç”šè‡³å¯ç”¨æ€§ã€‚</p>

<h2 id="codis">codis</h2>

<p>codisæ˜¯redisé›†ç¾¤æ²¡å‡ºæ¥ä¹‹å‰,è±Œè±†èšå›¢é˜Ÿåšçš„ä¸€ä¸ªæ–¹æ¡ˆ,é€šè¿‡proxy,éš”ç¦»äº†åç«¯çš„redisé›†ç¾¤</p>

<h3 id="ä¼˜ç‚¹">ä¼˜ç‚¹</h3>

<ol>
  <li>æ”¯æŒKubernetes</li>
  <li>æœ‰webå›¾å½¢ç•Œé¢,æ–¹ä¾¿è¿ç»´</li>
  <li>Redisè·å¾—åŠ¨æ€æ‰©å®¹/ç¼©å®¹çš„èƒ½åŠ›ï¼Œå¢å‡rediså®ä¾‹å¯¹clientå®Œå…¨é€æ˜ã€ä¸éœ€è¦é‡å¯æœåŠ¡</li>
  <li>ä¼¸ç¼©æ–¹ä¾¿ï¼Œæ‰©å¼ æœåŠ¡å™¨å¢åŠ å‰¯æœ¬æ•°ï¼Œé‡æ–°å¹³è¡¡slotå³å¯ï¼›ç¼©å°çš„è¯ï¼Œå…ˆæŠŠslotç§»åŠ¨åˆ°æ—§çš„åˆ†ç»„ï¼Œå†è°ƒå°å‰¯æœ¬æ•°å³å¯ã€‚</li>
</ol>

<h3 id="ç¼ºç‚¹">ç¼ºç‚¹</h3>

<ol>
  <li>ç¨³å®šæ€§å ªå¿§</li>
  <li>ä¾èµ–äºå›½å†…çš„è±Œè±†èšå›¢é˜Ÿå¼€å‘,è¿­ä»£é€Ÿåº¦è¾ƒæ…¢</li>
  <li>åŸç‰ˆçš„dockeré•œåƒè¾ƒå¤§,æ²¡æœ‰æ ¹æ®ç»„ä»¶è¿›è¡Œåˆ†å¼€</li>
  <li>åŸºäºredis 3.x,è€Œä¸”å¾ˆå¤šåŸç”Ÿçš„redisæŒ‡ä»¤è¢«é˜‰å‰²äº†</li>
  <li>å¼ºä¾èµ–æ³¨å†Œä¸­å¿ƒ(Zookeeperã€Etcdã€Fs)</li>
</ol>

<p>æˆ‘ä»¬ç”¨äº†å‡ ä¸ªæœˆå§,åˆ°åæœŸé¢‘ç¹å‡ºç°</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>ERR handle response, backend conn reset
</pre></td></tr></tbody></table></code></pre></div></div>
<p>æ­¤å¤–,æ—¥å¸¸è§‚å¯Ÿå‘ç°podé€€å‡º/é‡å¯å›°éš¾.å¦‚æœæŸä¸ªgroupèŠ‚ç‚¹å…¨éƒ¨æŒ‚æ‰çš„è¯,æ•´ä¸ªé›†ç¾¤å°†ä¸å¯è¯»å†™.è›‹ç–¼çš„æ˜¯ï¼Œstatefulsetæ˜¯é¡ºåºæ›´æ–°çš„ï¼ˆpodManagementPolicy: â€œOrderedReadyâ€œï¼‰ï¼Œpodå¼‚å¸¸ä¼šå½±å“åé¢çš„podæ›´æ–°ã€‚è®¾ç½®ä¸ºå¹¶è¡Œå¹¶è¡Œï¼ˆpodManagementPolicy: â€œParallelâ€ï¼‰ä¼¼ä¹ä¹Ÿä¸å¤§åˆé€‚ã€‚</p>

<p>å¶å°”è¿˜ä¼šå‡ºç°èŠ‚ç‚¹é‡å¯äº†ï¼Œä½†ä¸€ç›´æ²¡æœ‰åŠ å…¥ä»»ä½•ä¸€ä¸ªgroupä¸­ã€‚</p>

<p>ç»¼ä¸Š,codiså·²ç»å½±å“åˆ°äº†ä¸¥é‡å½±å“åˆ°äº†æˆ‘ä»¬ç¨‹åºçš„æ­£ç¡®æ€§,å†³å®šå¼ƒç”¨codis.æ”¹ä¸ºæ™®é€šçš„1ä¸»Nä»çš„æ¨¡å¼.</p>

<p><a href="https://github.com/CodisLabs/codis/issues/1356">ä¸»æŒ‚äº†ä¹‹åå¯¼è‡´æœåŠ¡ä¸å¯ç”¨ #1356</a></p>

<h2 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥</h2>
<ol>
  <li><a href="https://blog.csdn.net/slvher/article/details/17682147">ã€Redisç¬”è®°ã€‘ ç¬¬4ç¯‡: redis.confä¸­Replicationé…ç½®é¡¹è¯´æ˜</a></li>
  <li><a href="https://www.jianshu.com/p/788ce685fc7c">Redis é…ç½®æ–‡ä»¶è¯¦è§£</a></li>
  <li><a href="http://redisdoc.com/topic/sentinel.html">rediså‘½ä»¤å‚è€ƒ</a></li>
  <li><a href="https://my.oschina.net/u/3371837/blog/1789452">redisä¸»ä»å¤åˆ¶å¸¸è§çš„ä¸€äº›å‘</a></li>
  <li><a href="https://mp.weixin.qq.com/s/36o135V1BpcCBVNH-bvotw">Redis çš„å„é¡¹åŠŸèƒ½è§£å†³äº†å“ªäº›é—®é¢˜ï¼Ÿ</a></li>
  <li><a href="http://redisdoc.com/topic/cluster-tutorial.html">é›†ç¾¤æ•™ç¨‹</a></li>
</ol>
:ET