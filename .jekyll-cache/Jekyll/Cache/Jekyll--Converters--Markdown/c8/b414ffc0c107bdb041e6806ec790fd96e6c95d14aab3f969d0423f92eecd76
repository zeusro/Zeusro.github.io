I"¹8<p>æœ€è¿‘æœ‰ç‚¹åˆ’æ°´,æ–‡ç« è¿˜æ˜¯æœ‰å†™çš„,åªæ˜¯æ²¡æˆå‹,æ‰€ä»¥æ²¡å‘å‡ºæ¥.</p>

<p>ä»Šå¤©ä»‹ç»ä¸‹ç”¨k8sæŒ‚è½½ä¸€äº›å¸¸ç”¨çš„èµ„æº</p>

<p>å½“å‰ç‰ˆæœ¬Kubernetesç‰ˆæœ¬:1.12.2</p>

<h2 id="env">env</h2>

<h3 id="env-1">env</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>          env:
            - name: GIT_REPO
              value: 'ssh://git@127.0.0.1:22/a/b.git'
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="åµŒå¥—env">åµŒå¥—env</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>          env:
            - name: spring.profiles.active
              value: 'product'
            - name: MY_POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP              
            - name: GOMS_API_HTTP_ADDR
              value: 'http://$(MY_POD_IP):9090'
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="configmap">configMap</h3>

<p><strong>æ³¨æ„ä¸€ä¸‹,ä¿®æ”¹configmapä¸ä¼šå¯¼è‡´å®¹å™¨é‡Œçš„æŒ‚è½½çš„configmapæ–‡ä»¶/ç¯å¢ƒå˜é‡å‘ç”Ÿæ”¹å˜;åˆ é™¤configmapä¹Ÿä¸ä¼šå½±å“åˆ°å®¹å™¨å†…éƒ¨çš„ç¯å¢ƒå˜é‡/æ–‡ä»¶,ä½†æ˜¯åˆ é™¤configmapä¹‹å,è¢«æŒ‚è½½çš„podä¸Šé¢ä¼šå‡ºç°ä¸€ä¸ªwarnningçš„äº‹ä»¶</strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>Events:
  Type     Reason       Age                 From                                         Message
  ----     ------       ----                ----                                         -------
  Warning  FailedMount  64s (x13 over 11m)  kubelet, cn-shenzhen.i-wz9498k1n1l7sx8bkc50  MountVolume.SetUp failed for volume "nginx" : configmaps "nginx" not found
</pre></td></tr></tbody></table></code></pre></div></div>

<p><a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/#define-container-environment-variables-using-configmap-data">config map</a>å†™çš„å¾ˆæ¸…æ¥šäº†,è¿™é‡Œæ¬ä¸çŸ¥è€»å¾—copyä¸€ä¸‹</p>

<p><strong>æ³¨æ„,configmapæœ‰1Mçš„é™åˆ¶,ä¸€èˆ¬ç”¨æ¥æŒ‚è½½å°å‹é…ç½®,å¤§é‡é…ç½®å»ºè®®ä¸Šé…ç½®ä¸­å¿ƒ</strong></p>

<h3 id="æŒ‚è½½å•ä¸€é¡¹">æŒ‚è½½å•ä¸€é¡¹</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre>apiVersion: v1
kind: Pod
metadata:
  name: dapi-test-pod
spec:
  containers:
    - name: test-container
      image: k8s.gcr.io/busybox
      command: [ "/bin/sh", "-c", "env" ]
      env:
        # Define the environment variable
        - name: SPECIAL_LEVEL_KEY
          valueFrom:
            configMapKeyRef:
              # The ConfigMap containing the value you want to assign to SPECIAL_LEVEL_KEY
              name: special-config
              # Specify the key associated with the value
              key: special.how
  restartPolicy: Never
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¡¨ç¤ºæŒ‚è½½<code class="highlighter-rouge">special-config</code>è¿™ä¸ªconfigmapçš„<code class="highlighter-rouge">special.how</code>é¡¹</p>

<h3 id="æŒ‚è½½æ•´ä¸ªconfigmap">æŒ‚è½½æ•´ä¸ªconfigmap</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre>apiVersion: v1
kind: Pod
metadata:
  name: dapi-test-pod
spec:
  containers:
    - name: test-container
      image: k8s.gcr.io/busybox
      command: [ "/bin/sh", "-c", "env" ]
      envFrom:
      - configMapRef:
          name: special-config
  restartPolicy: Never
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å‚è€ƒ:</p>

<ol>
  <li><a href="https://stackoverflow.com/questions/42078080/add-nginx-conf-to-kubernetes-cluster">Add nginx.conf to Kubernetes cluster</a></li>
  <li><a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/#define-container-environment-variables-using-configmap-data">Configure a Pod to Use a ConfigMap</a></li>
</ol>

<h3 id="fieldref">fieldRef</h3>

<p>å¯ä»¥æŒ‚è½½podçš„ä¸€äº›å±æ€§</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>          env:
          - name: MY_POD_IP
            valueFrom:
              fieldRef:
                fieldPath: status.podIP

</pre></td></tr></tbody></table></code></pre></div></div>

<p>Selects a field of the pod: supports metadata.name, metadata.namespace, metadata.labels, metadata.annotations, spec.nodeName, spec.serviceAccountName, status.hostIP, status.podIP.</p>

<h3 id="resourcefieldref">resourceFieldRef</h3>

<p>Selects a resource of the container: only resources limits and requests (limits.cpu, limits.memory, limits.ephemeral-storage, requests.cpu, requests.memory and requests.ephemeral-storage) are currently supported.</p>

<p>è‹±æ–‡ä»‹ç»å¾—å¾ˆæ˜ç™½,ç”¨æ¥æŒ‚è½½å½“å‰yamlé‡Œé¢containerçš„èµ„æº(CPU/å†…å­˜)é™åˆ¶,ç”¨å¾—æ¯”è¾ƒå°‘å•¦å…¶å®.æ­¤å¤–è¿˜å¯ä»¥ç»“åˆ<code class="highlighter-rouge">downloadAPI</code></p>

<p>æ³¨æ„<code class="highlighter-rouge">containerName</code>ä¸èƒ½é…é”™,ä¸ç„¶podçŠ¶æ€ä¼šå˜æˆ<code class="highlighter-rouge">CreateContainerConfigError</code></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>          env:  
            - name: a
              valueFrom: 
                 resourceFieldRef:
                      containerName: nginx-test2
                      resource: limits.cpu
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="secretkeyref">secretKeyRef</h3>

<p>Selects a key of a secret in the podâ€™s namespace</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre>        env:
        - name: WORDPRESS_DB_USER
          valueFrom:
            secretKeyRef:
              name: mysecret
              key: username
        - name: WORDPRESS_DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysecret
              key: password
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å‚è€ƒ:</p>
<ol>
  <li><a href="https://blog.csdn.net/yan234280533/article/details/77018640">Kubernetesä¸­Secretä½¿ç”¨è¯¦è§£</a></li>
  <li>https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.12/#envvarsource-v1-core</li>
</ol>

<h2 id="ç›®å½•æ–‡ä»¶ç±»æŒ‚è½½">ç›®å½•/æ–‡ä»¶ç±»æŒ‚è½½</h2>

<p>k8så¯ä»¥æŒ‚è½½çš„èµ„æºå®åœ¨æ˜¯å¤ªå¤š,è¿™é‡ŒæŒ‘ä¸€äº›æ¯”è¾ƒæœ‰ä»£è¡¨æ€§çš„æ¥è®²ä¸€ä¸‹</p>

<p>è¿™ä¸€ç±»èµ„æºä¸€èˆ¬è¦å…ˆåœ¨specå±‚çº§å®šä¹‰<code class="highlighter-rouge">volumes</code>,ç„¶ååœ¨<code class="highlighter-rouge">containers</code>å®šä¹‰<code class="highlighter-rouge">volumeMounts</code>,æœ‰ç§å…ˆå£°æ˜,å†ä½¿ç”¨çš„æ„æ€</p>

<h3 id="hostpathå®¿ä¸»æœºç›®å½•æ–‡ä»¶">hostPath(å®¿ä¸»æœºç›®å½•/æ–‡ä»¶)</h3>

<ol>
  <li>æ—¢æœ‰ç›®å½•/æ–‡ä»¶ç”¨<code class="highlighter-rouge">Directory</code>/<code class="highlighter-rouge">File</code>+nodeSelector
  ä½†æ˜¯ç”¨äº†<code class="highlighter-rouge">nodeSelector</code>ä¹‹å,ä»¥åçš„ä¼¸ç¼©éƒ½ä¼šåœ¨åŒ¹é…çš„èŠ‚ç‚¹ä¸Š,å¦‚æœèŠ‚ç‚¹åªæœ‰1ä¸ª,å‰¯æœ¬é›†è®¾ç½®å¾—è¶…å‡ºå®é™…èŠ‚ç‚¹å¯æ‰¿å—ç©ºé—´,æœ€ç»ˆå°†å¯¼è‡´å•ç‚¹é—®é¢˜,è¿™ä¸ªè¦æ³¨æ„ä¸‹</li>
  <li>åº”ç”¨å¯ç”¨æ—¶è¯»å†™ç©ºæ–‡ä»¶ç”¨<code class="highlighter-rouge">DirectoryOrCreate</code>æˆ–è€…<code class="highlighter-rouge">FileOrCreate</code></li>
</ol>

<p>ä»¥ä¸‹æ¼”ç¤ºç¬¬ä¸€ç§æ–¹æ¡ˆ</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>#ç»™èŠ‚ç‚¹æ‰“ä¸Šæ ‡ç­¾(è¿™é‡Œçœç•¥)
kubectl get node --show-labels
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
</pre></td><td class="rouge-code"><pre>apiVersion: apps/v1beta2
kind: Deployment
metadata:  
  labels:
    app: nginx-test2
  name: nginx-test2
  namespace: test
spec:
  progressDeadlineSeconds: 600
  replicas: 1
  revisionHistoryLimit: 2
  selector:
    matchLabels:
      app: nginx-test2
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 1
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: nginx-test2
    spec:
      containers:
        - image: 'nginx:1.15.4-alpine'
          imagePullPolicy: Always
          name: nginx-test2
          resources: {}
          terminationMessagePolicy: File
          volumeMounts:
            - name: host1
              mountPath: /etc/nginx/sites-enabled
            - name: host2
              mountPath: /etc/nginx/sites-enabled2/a.com.conf            
      nodeSelector: 
        kubernetes.io/hostname: cn-shenzhen.i-wz9aabuytimkomdmjabq        
      dnsPolicy: ClusterFirst
      restartPolicy: Always
      schedulerName: default-scheduler
      securityContext: {}
      terminationGracePeriodSeconds: 30
      volumes:
        - name: host1
          hostPath:
            path: /root/site
            type: Directory
        - name: host2
          hostPath:
            path: /root/site/a.com.conf
            type: File            
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="configmap-1">configMap</h3>

<h4 id="å•é¡¹æŒ‚è½½ç¬¬1ç§">å•é¡¹æŒ‚è½½(ç¬¬1ç§)</h4>

<p>è¿™ç§æŒ‚è½½ä¼šçƒ­æ›´æ–°,æ›´æ”¹åå¤§çº¦10ç§’åèƒ½çœ‹åˆ°å˜åŒ–</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>      volumeMounts:
        - name: config-vol
          mountPath: /etc/config
  volumes:
    - name: config-vol
      configMap:
        name: log-config
        items:
          - key: log_level
            path: log_level
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="å•é¡¹æŒ‚è½½ç¬¬2ç§">å•é¡¹æŒ‚è½½(ç¬¬2ç§)</h4>

<p>è¿™ç§æŒ‚è½½æ–¹å¼ä¸ä¼šçƒ­æ›´æ–°</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>          volumeMounts:                  
            - name: nginx
              mountPath: /etc/nginx/nginx.conf
              subPath: nginx.conf                            
      volumes:             
          - name: nginx
            configMap:
              name: amiba-nginx 
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="å®Œå…¨æŒ‚è½½">å®Œå…¨æŒ‚è½½</h4>

<p>è¿™ç§æŒ‚è½½ä¼šçƒ­æ›´æ–°,æ›´æ”¹åå¤§çº¦10ç§’åèƒ½çœ‹åˆ°å˜åŒ–</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>      volumeMounts:
        - name: config-vol
          mountPath: /etc/config
  volumes:
    - name: config-vol
      configMap:
        name: log-config
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="secret">secret</h3>

<h4 id="å•é¡¹æŒ‚è½½">å•é¡¹æŒ‚è½½</h4>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre>  volumes:
  - name: secrets
    secret:
      secretName: mysecret
      items:
      - key: password
        mode: 511
        path: tst/psd
      - key: username
        mode: 511
        path: tst/usr
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="å®Œå…¨æŒ‚è½½-1">å®Œå…¨æŒ‚è½½</h4>

<p>è¿™é‡Œç”¨äº†ç‰¹å®šæƒé™å»æŒ‚è½½æ–‡ä»¶,é»˜è®¤å¥½åƒæ˜¯777</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>          volumeMounts:
            - name: sshkey
              mountPath: /root/.ssh              
      volumes:
        - name: sshkey
          secret:           
           secretName: pull-gitea
           defaultMode: 0400    
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre> kubectl create secret generic pull-gitea  \
--from-file=id_rsa=/Volumes/D/temp/id_rsa  \
--from-file=id_rsa.pub=/Volumes/D/temp/id_rsa.pub  \
--from-file=known_hosts=/Volumes/D/temp/known_hosts \
</pre></td></tr></tbody></table></code></pre></div></div>
<p>æ¯”å¦‚è¿™ä¸ªæ¨¡å¼åˆ›å»ºå‡ºæ¥çš„secret,å®¹å™¨é‡Œé¢/root/.sshç›®å½•å°±ä¼šæœ‰<code class="highlighter-rouge">id_rsa</code>,<code class="highlighter-rouge">id_rsa.pub</code>,<code class="highlighter-rouge">known_hosts</code>3ä¸ªæ–‡ä»¶</p>

<h3 id="downwardapi">downwardAPI</h3>

<p>å‚è€ƒé“¾æ¥:</p>
<ol>
  <li><a href="https://kubernetes.io/docs/concepts/storage/volumes/">volumes</a></li>
  <li><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.12/#hostpathvolumesource-v1-core">kubernetes-api/v1.12</a></li>
</ol>
:ET