I"‚“<p>è¿æ¥api-serveråˆ†3ç§æƒ…å†µ</p>

<ol>
  <li>é€šè¿‡kubectl proxyä¸­è½¬è¿æ¥</li>
  <li>é€šè¿‡æˆæƒéªŒè¯,ç›´æ¥è¿æ¥(kubectlå’Œå„ç§clientå°±æ˜¯è¿™ç§æƒ…å†µ)
 <code class="highlighter-rouge">kubectl</code>åŠ è½½<code class="highlighter-rouge">~/.kube/config</code>ä½œä¸ºæˆæƒä¿¡æ¯,è¯·æ±‚è¿œç«¯çš„<code class="highlighter-rouge">api-server</code>çš„resetful
 API.<code class="highlighter-rouge">api-server</code>æ ¹æ®ä½ æäº¤çš„æˆæƒä¿¡æ¯åˆ¤æ–­æœ‰æ²¡æœ‰æƒé™,æœ‰æƒé™çš„è¯å°±å°†å¯¹åº”çš„ç»“æœè¿”å›ç»™ä½ .</li>
  <li>å®¹å™¨å†…éƒ¨é€šè¿‡<code class="highlighter-rouge">ServiceAccount</code>è¿æ¥</li>
</ol>

<p>ä»Šå¤©æ¥ä»‹ç»å®¹å™¨å†…éƒ¨è¿æ¥<code class="highlighter-rouge">api-server</code>çš„åŠæ³•.</p>

<h2 id="ä¸€ä¸ªç®€å•çš„ä¾‹å­">ä¸€ä¸ªç®€å•çš„ä¾‹å­</h2>

<p><img src="https://d33wubrfki0l68.cloudfront.net/673dbafd771491a080c02c6de3fdd41b09623c90/50100/images/docs/admin/access-control-overview.svg" alt="img" /></p>

<p><code class="highlighter-rouge">Kubernetes</code>è¿™å¥—RBACçš„æœºåˆ¶åœ¨<a href="https://www.zeusro.tech/2019/01/17/kubernetes-rbac/">ä¹‹å‰çš„æ–‡ç« </a>æœ‰æè¿‡.è¿™é‡Œå°±ä¸è§£é‡Šäº†</p>

<p>ä¸ºäº†æ–¹ä¾¿èµ·è§,æˆ‘ç›´æ¥ä½¿ç”¨<code class="highlighter-rouge">kube-system</code>çš„<code class="highlighter-rouge">admin</code>ä½œä¸ºä¾‹å­.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
</pre></td><td class="rouge-code"><pre><span class="c1"># </span>

<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="s">kubectl.kubernetes.io/last-applied-configuration</span><span class="pi">:</span> <span class="pi">|</span>
      <span class="s">{"apiVersion":"v1","kind":"ServiceAccount","metadata":{"annotations":{},"name":"admin","namespace":"kube-system"}}</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">admin</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
  <span class="na">resourceVersion</span><span class="pi">:</span> <span class="s2">"</span><span class="s">383"</span>
<span class="na">secrets</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">admin-token-wggwk</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="s">rbac.authorization.kubernetes.io/autoupdate</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="s">kubernetes.io/bootstrapping</span><span class="pi">:</span> <span class="s">rbac-defaults</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">cluster-admin</span>
  <span class="na">resourceVersion</span><span class="pi">:</span> <span class="s2">"</span><span class="s">51"</span>
<span class="na">rules</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s1">'</span><span class="s">*'</span>
  <span class="na">resources</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s1">'</span><span class="s">*'</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s1">'</span><span class="s">*'</span>
<span class="pi">-</span> <span class="na">nonResourceURLs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s1">'</span><span class="s">*'</span>
  <span class="na">verbs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s1">'</span><span class="s">*'</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRoleBinding</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="s">rbac.authorization.kubernetes.io/autoupdate</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="s">kubernetes.io/bootstrapping</span><span class="pi">:</span> <span class="s">rbac-defaults</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">cluster-admin</span>
  <span class="na">resourceVersion</span><span class="pi">:</span> <span class="s2">"</span><span class="s">102"</span>
<span class="na">roleRef</span><span class="pi">:</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">cluster-admin</span>
<span class="na">subjects</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">Group</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">system:masters</span>

<span class="c1"># </span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç®€å•åœ°è¯´,å®¹å™¨é€šè¿‡<code class="highlighter-rouge">ServiceAccount</code>é…åˆRBACè¿™å¥—æœºåˆ¶,è®©å®¹å™¨æ‹¥æœ‰è®¿é—®<code class="highlighter-rouge">api-server</code>çš„æƒé™.</p>

<p>åŸæœ¬æˆ‘æ‰“ç®—åœ¨<code class="highlighter-rouge">kube-system</code>ä¸‹é¢åˆ›å»ºä¸€ä¸ªnginxå®¹å™¨,å»è®¿é—®,ä½†æ˜¯curlå¤±è´¥äº†,åæ¥æˆ‘æ‰¾äº†ä¸ªcentosçš„é•œåƒå»æµ‹è¯•.å¤§å®¶è®°å¾—é…ç½®å¥½<code class="highlighter-rouge">serviceAccount</code>å°±è¡Œ</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>metadata.spec.template.spec.serviceAccount: admin
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="å®¹å™¨è¯·æ±‚api-serverçš„ç»†èŠ‚">å®¹å™¨è¯·æ±‚api-serverçš„ç»†èŠ‚</h2>

<h3 id="deployå£°æ˜saserviceaccountçš„æœ¬è´¨">deployå£°æ˜sa(<code class="highlighter-rouge">ServiceAccount</code>)çš„æœ¬è´¨</h3>

<p>åœ¨deployå£°æ˜saçš„æœ¬è´¨æ˜¯æŠŠsaçš„å¯¹åº”çš„secretæŒ‚è½½åˆ°<code class="highlighter-rouge">/var/run/secrets/kubernetes.io/serviceaccount</code>ç›®å½•ä¸­.</p>

<p>ä¸å£°æ˜sa,åˆ™æŠŠ<code class="highlighter-rouge">default</code>ä½œä¸ºsaæŒ‚è½½è¿›å»</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre># k edit secret admin-token-wggwk
# ç”¨editåŠ è½½çš„secretå†…å®¹éƒ½ä¼šä»¥base64å½¢å¼è¡¨ç¤º
# base64(kube-system):a3ViZS1zeXN0ZW0=
apiVersion: v1
data:
  ca.crt: *******
  namespace: a3ViZS1zeXN0ZW0=
  token: *******
kind: Secret
metadata:
  annotations:
    kubernetes.io/service-account.name: admin
    kubernetes.io/service-account.uid: 9911ff2a-8c46-4179-80ac-727f48012229 
  name: admin-token-wggwk
  namespace: kube-system
  resourceVersion: "378"
type: kubernetes.io/service-account-token
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ‰€ä»¥deployè¡ç”Ÿçš„æ¯ä¸€ä¸ªpodé‡Œé¢çš„å®¹å™¨,
<code class="highlighter-rouge">/var/run/secrets/kubernetes.io/serviceaccount</code>ç›®å½•ä¸‹é¢éƒ½ä¼šæœ‰è¿™3ä¸ªæ–‡ä»¶</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>/run/secrets/kubernetes.io/serviceaccount # ls -l
total 0
lrwxrwxrwx    1 root     root            13 Apr 19 06:46 ca.crt -&gt; ..data/ca.crt
lrwxrwxrwx    1 root     root            16 Apr 19 06:46 namespace -&gt; ..data/namespace
lrwxrwxrwx    1 root     root            12 Apr 19 06:46 token -&gt; ..data/token
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è™½ç„¶è¿™3ä¸ªæ–‡ä»¶éƒ½æ˜¯è½¯é“¾æ¥è€Œä¸”æœ€ç»ˆæŒ‡å‘äº†ä¸‹é¢é‚£ä¸ªå¸¦æ—¥æœŸçš„æ–‡ä»¶å¤¹,ä½†æ˜¯æˆ‘ä»¬ä¸ç”¨ç®¡å®ƒ.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>/run/secrets/kubernetes.io/serviceaccount # ls -a -l
total 4
drwxrwxrwt    3 root     root           140 Apr 19 06:46 .
drwxr-xr-x    3 root     root          4096 Apr 19 06:46 ..
drwxr-xr-x    2 root     root           100 Apr 19 06:46 ..2019_04_19_06_46_10.877180351
lrwxrwxrwx    1 root     root            31 Apr 19 06:46 ..data -&gt; ..2019_04_19_06_46_10.877180351
lrwxrwxrwx    1 root     root            13 Apr 19 06:46 ca.crt -&gt; ..data/ca.crt
lrwxrwxrwx    1 root     root            16 Apr 19 06:46 namespace -&gt; ..data/namespace
lrwxrwxrwx    1 root     root            12 Apr 19 06:46 token -&gt; ..data/token
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="è¯·æ±‚api-server">è¯·æ±‚api-server</h2>

<p>é›†ç¾¤å°±ç»ªä¹‹å,åœ¨<code class="highlighter-rouge">default</code>è¿™ä¸ªå‘½åç©ºé—´ä¸‹ä¼šæœ‰<code class="highlighter-rouge">kubernetes</code>è¿™ä¸ªsvc,å®¹å™¨é€è¿‡ca.crtä½œä¸ºè¯ä¹¦å»è¯·æ±‚å³å¯.è·¨nsçš„è®¿é—®æ–¹å¼ä¸º<code class="highlighter-rouge">https://kubernetes.default.svc:443</code></p>

<h3 id="å‰æœŸå‡†å¤‡">å‰æœŸå‡†å¤‡</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>kubectl exec -it $po sh -n kube-system
cd /var/run/secrets/kubernetes.io/serviceaccount
TOKEN=$(cat token)
APISERVER=https://kubernetes.default.svc:443

</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="å…ˆä¼ªè£…æˆä¸€ä¸ªæµæ°“å»è®¿é—®api-server">å…ˆä¼ªè£…æˆä¸€ä¸ªæµæ°“å»è®¿é—®<code class="highlighter-rouge">api-server</code></h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre>sh-4.2# curl <span class="nt">-voa</span>  <span class="nt">-s</span>  <span class="nv">$APISERVER</span>/version
<span class="k">*</span> About to connect<span class="o">()</span> to kubernetes.default.svc port 443 <span class="o">(</span><span class="c">#0)</span>
<span class="k">*</span>   Trying 172.30.0.1...
<span class="k">*</span> Connected to kubernetes.default.svc <span class="o">(</span>172.30.0.1<span class="o">)</span> port 443 <span class="o">(</span><span class="c">#0)</span>
<span class="k">*</span> Initializing NSS with certpath: sql:/etc/pki/nssdb
<span class="k">*</span>   CAfile: /etc/pki/tls/certs/ca-bundle.crt
  CApath: none
<span class="k">*</span> Server certificate:
<span class="k">*</span> 	subject: <span class="nv">CN</span><span class="o">=</span>kube-apiserver
<span class="k">*</span> 	start <span class="nb">date</span>: Jul 24 06:31:00 2018 GMT
<span class="k">*</span> 	expire <span class="nb">date</span>: Jul 24 06:44:02 2019 GMT
<span class="k">*</span> 	common name: kube-apiserver
<span class="k">*</span> 	issuer: <span class="nv">CN</span><span class="o">=</span>cc95defe1ffd6401d8ede6d4efb0f0f7c,OU<span class="o">=</span>default,O<span class="o">=</span>cc95defe1ffd6401d8ede6d4efb0f0f7c
<span class="k">*</span> NSS error <span class="nt">-8179</span> <span class="o">(</span>SEC_ERROR_UNKNOWN_ISSUER<span class="o">)</span>
<span class="k">*</span> Peer<span class="s1">'s Certificate issuer is not recognized.
* Closing connection 0
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>å¯ä»¥çœ‹åˆ°,ç”¨é»˜è®¤çš„<code class="highlighter-rouge">/etc/pki/tls/certs/ca-bundle.crt</code>å…¬é’¥å»è®¿é—®,ç›´æ¥å°±æŠ¥è¯ä¹¦å¯¹ä¸ä¸Šäº†(Peerâ€™s Certificate issuer is not recognized.)</p>

<h3 id="å¸¦è¯ä¹¦å»è®¿é—®api-server">å¸¦è¯ä¹¦å»è®¿é—®<code class="highlighter-rouge">api-server</code></h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre>curl <span class="nt">-s</span> <span class="nv">$APISERVER</span>/version  <span class="se">\</span>
<span class="nt">--header</span> <span class="s2">"Authorization: Bearer </span><span class="nv">$TOKEN</span><span class="s2">"</span> <span class="se">\</span>
<span class="nt">--cacert</span> ca.crt 
<span class="o">{</span>
  <span class="s2">"major"</span>: <span class="s2">"1"</span>,
  <span class="s2">"minor"</span>: <span class="s2">"11"</span>,
  <span class="s2">"gitVersion"</span>: <span class="s2">"v1.11.5"</span>,
  <span class="s2">"gitCommit"</span>: <span class="s2">"753b2dbc622f5cc417845f0ff8a77f539a4213ea"</span>,
  <span class="s2">"gitTreeState"</span>: <span class="s2">"clean"</span>,
  <span class="s2">"buildDate"</span>: <span class="s2">"2018-11-26T14:31:35Z"</span>,
  <span class="s2">"goVersion"</span>: <span class="s2">"go1.10.3"</span>,
  <span class="s2">"compiler"</span>: <span class="s2">"gc"</span>,
  <span class="s2">"platform"</span>: <span class="s2">"linux/amd64"</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>é‚£è¿™æ ·æ€è·¯å°±å¾ˆæ˜ç¡®äº†,curlçš„æ—¶å€™å¸¦ä¸Šæ­£ç¡®çš„è¯ä¹¦(ca.crt)å’Œè¯·æ±‚å¤´å°±è¡Œäº†.</p>

<h2 id="ä½¿ç”¨curlè®¿é—®å¸¸è§api">ä½¿ç”¨curlè®¿é—®å¸¸è§API</h2>

<p>è¿™é‡Œå…ˆè¦ä»‹ç»ä¸€ä¸ªæ¦‚å¿µ<code class="highlighter-rouge">selfLink</code>.åœ¨<code class="highlighter-rouge">kubernetes</code>é‡Œé¢,æ‰€æœ‰äº‹ç‰©çš†èµ„æº/å¯¹è±¡.<code class="highlighter-rouge">selfLink</code>å°±æ˜¯æ¯ä¸€ä¸ªèµ„æºå¯¹åº”çš„<code class="highlighter-rouge">api-server</code>åœ°å€.<code class="highlighter-rouge">selfLink</code>è·Ÿèµ„æºæ˜¯ä¸€ä¸€å¯¹åº”çš„.</p>

<p><code class="highlighter-rouge">selfLink</code>æ˜¯æœ‰è§„å¾‹çš„,ç”±<code class="highlighter-rouge">namespace</code>,<code class="highlighter-rouge">type</code>,<code class="highlighter-rouge">apiVersion</code>,<code class="highlighter-rouge">name</code>ç­‰ç»„æˆ.</p>

<h3 id="get-node"><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.14/#list-node-v1-core">get node</a></h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>kubectl get no
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>curl <span class="se">\</span>
<span class="nt">-s</span> <span class="nv">$APISERVER</span>/api/v1/nodes?watch <span class="se">\</span>
<span class="nt">--header</span> <span class="s2">"Authorization: Bearer </span><span class="nv">$TOKEN</span><span class="s2">"</span> <span class="se">\</span>
<span class="nt">--cacert</span>  ca.crt
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="get-pod"><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.14/#list-pod-v1-core">get pod</a></h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>kubectl get po -n kube-system -w
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>curl <span class="se">\</span>
<span class="nt">-s</span> <span class="nv">$APISERVER</span>/api/v1/namespaces/kube-system/pods?watch <span class="se">\</span>
<span class="nt">--header</span> <span class="s2">"Authorization: Bearer </span><span class="nv">$TOKEN</span><span class="s2">"</span> <span class="se">\</span>
<span class="nt">--cacert</span>  ca.crt
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="get-pod-log"><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.14/#read-log-pod-v1-core">get pod log</a></h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>kubectl logs  -f -c logtail  -n kube-system  logtail-ds-vvpfr
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>curl <span class="se">\</span>
<span class="nt">-s</span> <span class="nv">$APISERVER</span><span class="s2">"/api/v1/namespaces/kube-system/pods/logtail-ds-vvpfr/log?container=logtail&amp;follow"</span> <span class="se">\</span>
<span class="nt">--header</span> <span class="s2">"Authorization: Bearer </span><span class="nv">$TOKEN</span><span class="s2">"</span> <span class="se">\</span>
<span class="nt">--cacert</span>  ca.crt
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å®Œæ•´APIè§<a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.14/">kubernetes API</a></p>

<h2 id="åè®°ä½¿ç”¨javascriptå®¢æˆ·ç«¯è®¿é—®-api-service">åè®°(ä½¿ç”¨JavaScriptå®¢æˆ·ç«¯è®¿é—® api service)</h2>

<p>æœ€è¿‘(2019-08-23)åœ¨éƒ¨ç½² kubeflow çš„æ—¶å€™,å‘ç°é‡Œé¢æœ‰ä¸ªç»„ä»¶æ˜¯ç”¨ nodejs å»è¯·æ±‚ api service çš„,è§‚å¯Ÿäº†ä¸€ä¸‹ä»£ç ,åŠ è½½é…ç½®çš„åœ°æ–¹å¤§è‡´å¦‚æ­¤.</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
</pre></td><td class="rouge-code"><pre>
<span class="kr">public</span> <span class="nx">loadFromDefault</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">KUBECONFIG</span> <span class="o">&amp;&amp;</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">KUBECONFIG</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">const</span> <span class="nx">files</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">KUBECONFIG</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">delimiter</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">loadFromFile</span><span class="p">(</span><span class="nx">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">files</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">const</span> <span class="nx">kc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">KubeConfig</span><span class="p">();</span>
                <span class="nx">kc</span><span class="p">.</span><span class="nx">loadFromFile</span><span class="p">(</span><span class="nx">files</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">mergeConfig</span><span class="p">(</span><span class="nx">kc</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kd">const</span> <span class="nx">home</span> <span class="o">=</span> <span class="nx">findHomeDir</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">home</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">const</span> <span class="nx">config</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">home</span><span class="p">,</span> <span class="dl">'</span><span class="s1">.kube</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">config</span><span class="dl">'</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">fileExists</span><span class="p">(</span><span class="nx">config</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">loadFromFile</span><span class="p">(</span><span class="nx">config</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">platform</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">win32</span><span class="dl">'</span> <span class="o">&amp;&amp;</span> <span class="nx">shelljs</span><span class="p">.</span><span class="nx">which</span><span class="p">(</span><span class="dl">'</span><span class="s1">wsl.exe</span><span class="dl">'</span><span class="p">))</span> <span class="p">{</span>
            <span class="c1">// TODO: Handle if someome set $KUBECONFIG in wsl here...</span>
            <span class="k">try</span> <span class="p">{</span>
                <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">execa</span><span class="p">.</span><span class="nx">sync</span><span class="p">(</span><span class="dl">'</span><span class="s1">wsl.exe</span><span class="dl">'</span><span class="p">,</span> <span class="p">[</span><span class="dl">'</span><span class="s1">cat</span><span class="dl">'</span><span class="p">,</span> <span class="nx">shelljs</span><span class="p">.</span><span class="nx">homedir</span><span class="p">()</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">/.kube/config</span><span class="dl">'</span><span class="p">]);</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">code</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">loadFromString</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">stdout</span><span class="p">);</span>
                    <span class="k">return</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// Falling back to alternative auth</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">fileExists</span><span class="p">(</span><span class="nx">Config</span><span class="p">.</span><span class="nx">SERVICEACCOUNT_TOKEN_PATH</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">loadFromCluster</span><span class="p">();</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">loadFromClusterAndUser</span><span class="p">(</span>
            <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">cluster</span><span class="dl">'</span><span class="p">,</span> <span class="na">server</span><span class="p">:</span> <span class="dl">'</span><span class="s1">http://localhost:8080</span><span class="dl">'</span> <span class="p">}</span> <span class="k">as</span> <span class="nx">Cluster</span><span class="p">,</span>
            <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">user</span><span class="dl">'</span> <span class="p">}</span> <span class="k">as</span> <span class="nx">User</span><span class="p">,</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">......</span>


    <span class="kr">public</span> <span class="nx">loadFromCluster</span><span class="p">(</span><span class="na">pathPrefix</span><span class="p">:</span> <span class="nx">string</span> <span class="o">=</span> <span class="dl">''</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">host</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">KUBERNETES_SERVICE_HOST</span><span class="p">;</span>
        <span class="kd">const</span> <span class="nx">port</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">KUBERNETES_SERVICE_PORT</span><span class="p">;</span>
        <span class="kd">const</span> <span class="nx">clusterName</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">inCluster</span><span class="dl">'</span><span class="p">;</span>
        <span class="kd">const</span> <span class="nx">userName</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">inClusterUser</span><span class="dl">'</span><span class="p">;</span>
        <span class="kd">const</span> <span class="nx">contextName</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">inClusterContext</span><span class="dl">'</span><span class="p">;</span>

        <span class="kd">let</span> <span class="nx">scheme</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">https</span><span class="dl">'</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">port</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">80</span><span class="dl">'</span> <span class="o">||</span> <span class="nx">port</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">8080</span><span class="dl">'</span> <span class="o">||</span> <span class="nx">port</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">8001</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">scheme</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">http</span><span class="dl">'</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">clusters</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="na">name</span><span class="p">:</span> <span class="nx">clusterName</span><span class="p">,</span>
                <span class="na">caFile</span><span class="p">:</span> <span class="s2">`</span><span class="p">${</span><span class="nx">pathPrefix</span><span class="p">}${</span><span class="nx">Config</span><span class="p">.</span><span class="nx">SERVICEACCOUNT_CA_PATH</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span>
                <span class="na">server</span><span class="p">:</span> <span class="s2">`</span><span class="p">${</span><span class="nx">scheme</span><span class="p">}</span><span class="s2">://</span><span class="p">${</span><span class="nx">host</span><span class="p">}</span><span class="s2">:</span><span class="p">${</span><span class="nx">port</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span>
                <span class="na">skipTLSVerify</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">];</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">users</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="na">name</span><span class="p">:</span> <span class="nx">userName</span><span class="p">,</span>
                <span class="na">authProvider</span><span class="p">:</span> <span class="p">{</span>
                    <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">tokenFile</span><span class="dl">'</span><span class="p">,</span>
                    <span class="na">config</span><span class="p">:</span> <span class="p">{</span>
                        <span class="na">tokenFile</span><span class="p">:</span> <span class="s2">`</span><span class="p">${</span><span class="nx">pathPrefix</span><span class="p">}${</span><span class="nx">Config</span><span class="p">.</span><span class="nx">SERVICEACCOUNT_TOKEN_PATH</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">},</span>
            <span class="p">},</span>
        <span class="p">];</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">contexts</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="na">cluster</span><span class="p">:</span> <span class="nx">clusterName</span><span class="p">,</span>
                <span class="na">name</span><span class="p">:</span> <span class="nx">contextName</span><span class="p">,</span>
                <span class="na">user</span><span class="p">:</span> <span class="nx">userName</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">];</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">currentContext</span> <span class="o">=</span> <span class="nx">contextName</span><span class="p">;</span>
    <span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å¯ä»¥çœ‹åˆ°,åŠ è½½é…ç½®æ˜¯æœ‰å…ˆåé¡ºåºçš„. sa æ’åœ¨æ¯”è¾ƒé åçš„ä¼˜å…ˆçº§.</p>

<p>host å’Œ port é€šè¿‡è¯»å–ç›¸åº” env å¾—å‡º(å®é™…ä¸Š,å°±ç®—åœ¨yamlæ²¡æœ‰é…ç½®ENV, kubernetes æœ¬èº«ä¹Ÿä¼šæ³¨å…¥å¤§é‡ENV,è¿™äº›ENVå¤§å¤šæ˜¯svcçš„ipåœ°å€å’Œç«¯å£ç­‰)</p>

<p>è€Œä¸”é»˜è®¤çš„å®¢æˆ·ç«¯ <code class="highlighter-rouge">skipTLSVerify: false,</code></p>

<p>é‚£ä¹ˆä½¿ç”¨é»˜è®¤çš„å®¢æˆ·ç«¯,è¦å–æ¶ˆSSLéªŒè¯å’‹åŠå‘¢?è¿™é‡Œæä¾›ä¸€ä¸ªæ¯”è¾ƒè ¢ä½†æ˜¯ä¸‡æ— ä¸€å¤±çš„åŠæ³•:</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">k8s</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@kubernetes/client-node</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Cluster</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@kubernetes/client-node/dist/config_types</span><span class="dl">'</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">kubeConfig</span><span class="p">.</span><span class="nx">loadFromDefault</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">context</span> <span class="o">=</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">kubeConfig</span><span class="p">.</span><span class="nx">getContextObject</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">kubeConfig</span><span class="p">.</span><span class="nx">getCurrentContext</span><span class="p">());</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">context</span> <span class="o">&amp;&amp;</span> <span class="nx">context</span><span class="p">.</span><span class="nx">namespace</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">namespace</span> <span class="o">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">namespace</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">let</span> <span class="nx">oldCluster</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">kubeConfig</span><span class="p">.</span><span class="nx">getCurrentCluster</span><span class="p">()</span>
    <span class="kd">let</span> <span class="nx">cluster</span><span class="p">:</span> <span class="nx">Cluster</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">name</span><span class="p">:</span> <span class="nx">oldCluster</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
      <span class="na">caFile</span><span class="p">:</span> <span class="nx">oldCluster</span><span class="p">.</span><span class="nx">caFile</span><span class="p">,</span>
      <span class="na">server</span><span class="p">:</span> <span class="nx">oldCluster</span><span class="p">.</span><span class="nx">server</span><span class="p">,</span>
      <span class="na">skipTLSVerify</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="nx">kubeConfig</span><span class="p">.</span><span class="nx">clusters</span> <span class="o">=</span> <span class="p">[</span><span class="nx">cluster</span><span class="p">]</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">coreAPI</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">kubeConfig</span><span class="p">.</span><span class="nx">makeApiClient</span><span class="p">(</span><span class="nx">k8s</span><span class="p">.</span><span class="nx">Core_v1Api</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">customObjectsAPI</span> <span class="o">=</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">kubeConfig</span><span class="p">.</span><span class="nx">makeApiClient</span><span class="p">(</span><span class="nx">k8s</span><span class="p">.</span><span class="nx">Custom_objectsApi</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥</h2>
<ol>
  <li><a href="https://kubernetes.io/docs/tasks/administer-cluster/access-cluster-api/">Access Clusters Using the Kubernetes API</a></li>
  <li><a href="https://medium.com/@nieldw/curling-the-kubernetes-api-server-d7675cfc398c">cURLing the Kubernetes API server</a></li>
</ol>

:ET