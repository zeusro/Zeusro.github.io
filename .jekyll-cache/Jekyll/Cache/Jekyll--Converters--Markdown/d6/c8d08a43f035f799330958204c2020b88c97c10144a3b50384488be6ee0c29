I"œ<h2 id="ç¯å¢ƒ">ç¯å¢ƒ:</h2>

<ol>
  <li>kubernetesç‰ˆæœ¬: é˜¿é‡Œäº‘v1.11.5</li>
  <li>èŠ‚ç‚¹ç³»ç»Ÿ CentOS Linux 7 (Core)</li>
  <li>èŠ‚ç‚¹å®¹å™¨ç‰ˆæœ¬ docker://17.6.2</li>
</ol>

<h2 id="æ¦‚å¿µä»‹ç»">æ¦‚å¿µä»‹ç»</h2>

<h3 id="x-forwarded-for">X-Forwarded-For</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>X-Forwarded-For: &lt;client&gt;, &lt;proxy1&gt;, &lt;proxy2&gt;
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="remote_addr">remote_addr</h3>

<p>remote_addrä»£è¡¨å®¢æˆ·ç«¯çš„IPï¼Œä½†å®ƒçš„å€¼ä¸æ˜¯ç”±å®¢æˆ·ç«¯æä¾›çš„ï¼Œè€Œæ˜¯æœåŠ¡ç«¯æ ¹æ®å®¢æˆ·ç«¯çš„ipæŒ‡å®šçš„ï¼Œå½“ä½ çš„æµè§ˆå™¨è®¿é—®æŸä¸ªç½‘ç«™æ—¶ï¼Œå‡è®¾ä¸­é—´æ²¡æœ‰ä»»ä½•ä»£ç†ï¼Œé‚£ä¹ˆç½‘ç«™çš„webæœåŠ¡å™¨ï¼ˆNginxï¼ŒApacheç­‰ï¼‰å°±ä¼šæŠŠremote_addrè®¾ä¸ºä½ çš„æœºå™¨IPï¼Œå¦‚æœä½ ç”¨äº†æŸä¸ªä»£ç†ï¼Œé‚£ä¹ˆä½ çš„æµè§ˆå™¨ä¼šå…ˆè®¿é—®è¿™ä¸ªä»£ç†ï¼Œç„¶åå†ç”±è¿™ä¸ªä»£ç†è½¬å‘åˆ°ç½‘ç«™ï¼Œè¿™æ ·webæœåŠ¡å™¨å°±ä¼šæŠŠremote_addrè®¾ä¸ºè¿™å°ä»£ç†æœºå™¨çš„IPã€‚</p>

<h2 id="å†…éƒ¨è¯·æ±‚podå¯¹podè¯·æ±‚">å†…éƒ¨è¯·æ±‚(Podå¯¹Podè¯·æ±‚)</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>podA--&gt;podB
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¿™æ—¶åªæœ‰<code class="highlighter-rouge">getRemoteAddr</code>èƒ½å¤Ÿè·å–IP,å…¶ä½™headerå…¨ç©º.podBè·å¾—çš„clientIPä¸ºpodAçš„podIP(è™šæ‹ŸIP)</p>

<p>The client_address is always the client podâ€™s IP address, whether the client pod and server pod are in the same node or in different nodes.</p>

<h2 id="å¤–éƒ¨è¯·æ±‚">å¤–éƒ¨è¯·æ±‚</h2>

<h3 id="nodeport-svc">Nodeport svc</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>client--&gt;svc--&gt;pod
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="externaltrafficpolicy-cluster">externalTrafficPolicy: Cluster</h4>

<p>svc.specè®¾ç½®<code class="highlighter-rouge">externalTrafficPolicy: Cluster</code>,æ„æ€æ˜¯æ‰€æœ‰èŠ‚ç‚¹éƒ½ä¼šå¯åŠ¨<code class="highlighter-rouge">kube-proxy</code>,å¤–éƒ¨æµé‡å¯èƒ½è½¬å‘å¤š1æ¬¡.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>          client
             \ ^
              \ \
               v \
   node 1 &lt;--- node 2
    | ^   SNAT
    | |   ---&gt;
    v |
 endpoint
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¿™æ—¶æµé‡é€šè¿‡node2çš„è½¬å‘,app è·å¾—çš„clientIPä¸å®š,æœ‰å¯èƒ½æ˜¯<code class="highlighter-rouge">node 2</code> çš„IP,ä¹Ÿæœ‰å¯èƒ½æ˜¯å®¢æˆ·ç«¯çš„IP</p>

<h4 id="externaltrafficpolicy-local">externalTrafficPolicy: Local</h4>

<p>svc.specè®¾ç½®<code class="highlighter-rouge">externalTrafficPolicy: Local</code>,åœ¨è¿è¡Œpodçš„èŠ‚ç‚¹ä¸Šå¯åŠ¨<code class="highlighter-rouge">kube-proxy</code>,å¤–éƒ¨æµé‡ç›´è¾¾èŠ‚ç‚¹.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>        client
       ^ /   \
      / /     \
     / v       X
   node 1     node 2
    ^ |
    | |
    | v
 endpoint
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¿™æ—¶,åªæœ‰è¿è¡Œäº†podçš„èŠ‚ç‚¹æ‰ä¼šæœ‰å¯¹åº”çš„proxy,é¿å…äº†ä¸­é—´å•†(node 2)æŒ£å·®ä»·</p>

<p><code class="highlighter-rouge">clientIP</code>ä¸º<code class="highlighter-rouge">remote_addr</code></p>

<h3 id="loadbalancer-svc">LoadBalancer svc</h3>

<p>svc.specè®¾ç½®<code class="highlighter-rouge">externalTrafficPolicy: Local</code>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>                      client
                        |
                      lb VIP
                     / ^
                    v /
health check ---&gt;   node 1   node 2 &lt;--- health check
        200  &lt;---   ^ |             ---&gt; 500
                    | V
                 endpoint
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="/img/in-post/get-client-ip-in-kubernetes/15450327712333_zh-CN.png" alt="image" /></p>

<p>SLBç›‘å¬HTTP:å–<code class="highlighter-rouge">X-Forwarded-For</code>å³å¯(ä»SLBè·å¾—å®¢æˆ·ç«¯IP).</p>

<p>SLBç›‘å¬TCP,åˆ™å–<code class="highlighter-rouge">remote_addr</code></p>

<p><code class="highlighter-rouge">externalTrafficPolicy: Cluster</code>çš„æƒ…å†µå°±ä¸ç”¨è¯´äº†,æ²¡æœ‰æ„ä¹‰.</p>

<h3 id="ingress">ingress</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>client--&gt;slb--&gt;ingress svc--&gt;ingress pod--&gt;app svc--&gt;pod
</pre></td></tr></tbody></table></code></pre></div></div>

<p>é¦–å…ˆéœ€è¦è®¾ç½®<code class="highlighter-rouge">ingress</code>çš„svcç±»å‹ä¸º<code class="highlighter-rouge">Nodeport</code>/<code class="highlighter-rouge">LoadBalancer</code>,å¹¶ä¸”<code class="highlighter-rouge">externalTrafficPolicy: Local</code></p>

<p>app svc typeä¸º<code class="highlighter-rouge">ClusterIP</code>/<code class="highlighter-rouge">NodePort</code>/<code class="highlighter-rouge">LoadBalancer</code>éƒ½æ— æ‰€è°“.</p>

<p>è¿™ä¸ªæ—¶å€™,<code class="highlighter-rouge">X-Forwarded-For</code>çš„å€¼å³ä¸º<code class="highlighter-rouge">clientIP</code></p>

<p><code class="highlighter-rouge">remote_addr</code>ä¸º<code class="highlighter-rouge">ingress pod</code> Virtual IP</p>

<h2 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥:</h2>

<ol>
  <li><a href="https://kubernetes.io/docs/tutorials/services/source-ip/">source-ip</a></li>
  <li><a href="https://imququ.com/post/x-forwarded-for-header-in-http.html">HTTP è¯·æ±‚å¤´ä¸­çš„ X-Forwarded-For</a></li>
  <li><a href="https://help.aliyun.com/document_detail/54007.html?spm=5176.11065259.1996646101.searchclickresult.610a1293EtcJUu">å¦‚ä½•è·å–å®¢æˆ·ç«¯çœŸå®IP</a></li>
  <li><a href="https://ieevee.com/tech/2017/09/18/k8s-svc-src.html">æºåœ°å€å®¡è®¡ï¼šè¿½è¸ª kubernetes æœåŠ¡çš„SNAT</a></li>
  <li><a href="https://ieevee.com/tech/2017/01/20/k8s-service.html">è°ˆè°ˆkubernetsçš„serviceç»„ä»¶çš„Virtual IP</a></li>
</ol>
:ET