I"Ÿ9<p>ä½¿ç”¨routingæ˜ç¡®æ•°æ®å¯¹åº”çš„åˆ†ç‰‡ä½ç½®</p>

<p><a href="https://blog.csdn.net/cnweike/article/details/38531997">Elasticsearchçš„è·¯ç”±ï¼ˆRoutingï¼‰ç‰¹æ€§</a></p>

<h2 id="æ€§èƒ½å‡ä½çš„åŸå› ">æ€§èƒ½å‡ä½çš„åŸå› </h2>

<ol>
  <li>Your clients are simply sending too many queries too quickly in a fast burst, overwhelming the queue. You can monitor this with Node Stats over time to see if itâ€™s bursty or smooth</li>
  <li>Youâ€™ve got some very slow queries which get â€œstuckâ€ for a long time, eating up threads and causing the queue to back up. You can enable the slow log to see if there are queries that are taking an exceptionally long time, then try to tune those</li>
  <li>There may potentially be â€œunendingâ€ scripts written in Groovy or something. E.g. a loop that never exits, causing the thread to spin forever.</li>
  <li>Your hardware may be under-provisioned for your workload, and bottlenecking on some resource (disk, cpu, etc)</li>
  <li>A temporary hiccup from your iSCSI target, which causes all the in-flight operations to block waiting for the disks to come back. It wouldnâ€™t take a big latency hiccup to seriously backup a busy clusterâ€¦ ES generally expects disks to always be available.</li>
  <li>Heavy garbage collections could cause problems too. Check Node Stats to see if there are many/long old gen GCs running</li>
</ol>

<p>è¿™æ®µEæ–‡ï¼Œæ— éå°±æ˜¯è¯´ï¼Œä½ çš„æœºå™¨å¤ªlowï¼Œä½ æŸ¥çš„è¿‡å¤š, <code class="highlighter-rouge">Mysql</code> çš„ç»éªŒåŒæ ·é€‚ç”¨äºESã€‚</p>

<h2 id="èŠ‚ç‚¹çš„é€‰æ‹©">èŠ‚ç‚¹çš„é€‰æ‹©</h2>

<p>è‡ªå·±ç©å°±åˆ«æ•´é‚£ä¹ˆå¤šèŠ‚ç‚¹äº†,<code class="highlighter-rouge">Elasticsearch</code>æ˜¯å†…å­˜æ€æ‰‹.</p>

<p>èµ„æºç´§å¼ çš„è¯ï¼Œ<code class="highlighter-rouge">coordinating</code> , <code class="highlighter-rouge">data</code> å’Œ <code class="highlighter-rouge">ingest</code> å¯ä»¥åˆèµ·æ¥ã€‚</p>

<h3 id="coordinating">coordinating</h3>

<p>åè°ƒèŠ‚ç‚¹æ˜¯è¯·æ±‚çš„å…¥å£</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>node.master:false
node.data:false
node.ingest:false
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="master">master</h3>

<p>é€‰ä¸»,å†³å®šåˆ†ç‰‡ä½ç½®</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>node.master:true
node.data:false
node.ingest:false
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="data">data</h3>

<p>å­˜æ”¾åˆ†ç‰‡çš„èŠ‚ç‚¹</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>node.master:false
node.data:true
node.ingest:false
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="ingest">ingest</h3>

<p>ingestèŠ‚ç‚¹è´Ÿè´£å¤„ç†pipeline</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>node.master:false
node.data:false
node.ingest:true
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="ç³»ç»Ÿé…ç½®ä¼˜åŒ–">ç³»ç»Ÿé…ç½®ä¼˜åŒ–</h2>

<pre><code class="language-YML">thread_pool:
    bulk:
        queue_size: 2000
    search:
        queue_size: 2000
indices:
  query:
    bool:
      max_clause_count: 50000
  recovery:
    max_bytes_per_sec:
</code></pre>

<p>queue_size æ˜¯å¹¶å‘æŸ¥è¯¢çš„é™åˆ¶,é»˜è®¤æ˜¯1000,ä¸åŒçš„ç‰ˆæœ¬åç§°å¯èƒ½ç•¥æœ‰åŒºåˆ«,çº¿ç¨‹æ± çš„å‚æ•°å¯ä»¥ç›´æ¥é™„åœ¨å¯åŠ¨å‚æ•°é‡Œé¢(æ¯•ç«ŸæŒ‚è½½é…ç½®æ–‡ä»¶å¯¹æˆ‘æ¥è¯´ä¹Ÿæ˜¯ä¸€ç§éº»çƒ¦)</p>

<p>å‚è€ƒ:</p>

<ol>
  <li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/settings.html">é…ç½®é›†ç¾¤</a></li>
  <li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-update-settings.html">æ›´æ–°é›†ç¾¤é…ç½®</a></li>
  <li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.5/modules-threadpool.html">çº¿ç¨‹æ± é…ç½®</a></li>
</ol>

<h2 id="indexé…ç½®ä¼˜åŒ–">Indexé…ç½®ä¼˜åŒ–</h2>

<h3 id="shard">shard</h3>

<p>å»ºè®®åœ¨å°è§„æ ¼èŠ‚ç‚¹ä¸‹å•shardå¤§å°ä¸è¦è¶…è¿‡30GBã€‚æ›´é«˜è§„æ ¼çš„èŠ‚ç‚¹å•shardå¤§å°ä¸è¦è¶…è¿‡50GBã€‚</p>

<p>å¯¹äºæ—¥å¿—åˆ†æåœºæ™¯æˆ–è€…è¶…å¤§ç´¢å¼•ï¼Œå»ºè®®å•shardå¤§å°ä¸è¦è¶…è¿‡100GBã€‚</p>

<p>shardçš„ä¸ªæ•°ï¼ˆåŒ…æ‹¬å‰¯æœ¬ï¼‰è¦å°½å¯èƒ½åŒ¹é…èŠ‚ç‚¹æ•°ï¼Œç­‰äºèŠ‚ç‚¹æ•°ï¼Œæˆ–è€…æ˜¯èŠ‚ç‚¹æ•°çš„æ•´æ•°å€ã€‚</p>

<p>é€šå¸¸æˆ‘ä»¬å»ºè®®å•èŠ‚ç‚¹ä¸ŠåŒä¸€ç´¢å¼•çš„shardä¸ªæ•°ä¸è¦è¶…5ä¸ªã€‚</p>

<h2 id="æŸ¥è¯¢ä¼˜åŒ–">æŸ¥è¯¢ä¼˜åŒ–</h2>

<p>å¯¹äº _all è¿™é¡¹å‚æ•°ï¼Œå¦‚æœåœ¨ä¸šåŠ¡ä½¿ç”¨ä¸Šæ²¡æœ‰å¿…è¦ï¼Œæˆ‘ä»¬é€šå¸¸çš„å»ºè®®æ˜¯ç¦æ­¢æˆ–è€…æœ‰é€‰æ‹©æ€§çš„æ·»åŠ ã€‚</p>

<h3 id="åªé€‰å–å¿…é¡»çš„å­—æ®µ">åªé€‰å–å¿…é¡»çš„å­—æ®µ</h3>

<p>å°±åƒåœ¨å…³ç³»å‹æ•°æ®åº“é‡Œé¢,ä¸è¦<code class="highlighter-rouge">select * </code>ä¸€æ ·.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>GET /product/goods/109524071?filter_path=_source.zdid
{
  "_source" : {
    "zdid" : 48
  }
}
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ç±»ä¼¼çš„ç”¨æ³•è¿˜æœ‰<code class="highlighter-rouge">_source</code>,ä½†æ˜¯ä¸<code class="highlighter-rouge">filter_path</code>ä¸åŒçš„åœ¨äº,è¿”å›çš„ç»“æœä¼šå¸¦ä¸Šæ–‡æ¡£æœ¬èº«çš„é»˜è®¤å­—æ®µ</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre>GET /product/goods/109524071?_source_include=zdid
{
  "_index" : "product",
  "_type" : "goods",
  "_id" : "109524071",
  "_version" : 4,
  "found" : true,
  "_source" : {
    "zdid" : 48
  }
}
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>_source=false
_source_include=zdid
_source_exclude
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>æ³¨æ„:_sourceå’Œfilter_pathä¸èƒ½ä¸€èµ·ç”¨</strong></p>

<h3 id="æ–°å»ºç´¢å¼•æ—¶å…³é—­ç´¢å¼•æ˜ å°„çš„è‡ªåŠ¨æ˜ å°„åŠŸèƒ½">æ–°å»ºç´¢å¼•æ—¶å…³é—­ç´¢å¼•æ˜ å°„çš„è‡ªåŠ¨æ˜ å°„åŠŸèƒ½</h3>

<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.5/indices-aliases.html">indexåˆ«å</a></p>

<h2 id="å…¶ä»–ç»éªŒ">å…¶ä»–ç»éªŒ</h2>

<p>æŒ‰ç…§å®é™…ç»éªŒ,elasticsearchå¤šåŠæ˜¯indexçš„æ—¶å€™å°‘,searchçš„æ—¶å€™å¤š,æ‰€ä»¥é’ˆå¯¹searchå»åšä¼˜åŒ–æ¯”è¾ƒåˆé€‚.</p>

<h3 id="æ—¥å¿—çš„æœ€ä½³å®è·µ">æ—¥å¿—çš„æœ€ä½³å®è·µ</h3>

<p>å¦‚æœæ—¥å¿—ä¸¢äº†ä¹Ÿæ— æ‰€è°“,å»ºè®®ç”¨1èŠ‚ç‚¹0å‰¯æœ¬åˆ†ç‰‡å‚¨å­˜æ—¥å¿—.</p>

<p>æ—¥å¿— index ç”¨ <code class="highlighter-rouge">xx-&lt;date&gt;</code> ,è¿™æ ·åˆ é™¤çš„æ—¶å€™ç›´æ¥åˆ  index å°±è¡Œ</p>

<p>delete by query çš„æˆ‘è¡¨ç¤ºæ¯æ¬¡éƒ½æƒ³æ­»â€¦</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre>POST /tracing/_delete_by_query?conflicts=proceed
{
	"query": {
		"range": {
			"@timestamp": {
				"lt": "now-90d",
				"format": "epoch_millis"
			}
		}
	}
}

GET /_tasks?&amp;actions=*delete*
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="æ•…éšœç»´æŠ¤">æ•…éšœç»´æŠ¤</h2>

<h3 id="unassigned-shards">Unassigned Shards</h3>

<p><code class="highlighter-rouge">è§£å†³æ–¹æ¡ˆ:</code>æ–°å»ºä¸€ä¸ª<code class="highlighter-rouge">number_of_replicas</code>ä¸º0çš„æ–°index,ç„¶åç”¨<code class="highlighter-rouge">_reindex</code>.è¿ç§»å®Œæˆä¹‹å,æŠŠ<code class="highlighter-rouge">number_of_replicas</code>æ”¹å›å».<code class="highlighter-rouge">reindex</code>æœ‰ä¸ª<code class="highlighter-rouge">size</code>çš„å‚æ•°,æŒ‰éœ€é…ç½®æˆ–è®¸æ›´å¿«äº›.</p>

<p><strong>æ³¨æ„</strong>å¯ä»¥é€šè¿‡<code class="highlighter-rouge">GET _tasks?actions=indices:data/write/reindex?detailed</code>æŸ¥çœ‹ç›¸å…³ä»»åŠ¡</p>

<p>å‚è€ƒ</p>
<ol>
  <li><a href="https://my.oschina.net/TOW/blog/1928075">Elasticsearch Reindex æ€§èƒ½æå‡10å€</a></li>
  <li><a href="https://www.jianshu.com/p/542ed5a5bdfc">è§£å†³elasticsearché›†ç¾¤Unassigned Shards æ— æ³•rerouteçš„é—®é¢˜</a></li>
  <li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/tasks.html">tasks API</a></li>
</ol>

<h3 id="reindex">reindex</h3>

<p>reindexä¹Ÿæ˜¯æœ‰æŠ€å·§çš„ã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="c"># ç¦ç”¨å‰¯æœ¬</span>
put geonames/_settings
<span class="o">{</span>
 
    <span class="s2">"settings"</span> : <span class="o">{</span>
      <span class="s2">"index"</span> : <span class="o">{</span>
        <span class="s2">"number_of_replicas"</span> : <span class="s2">"0"</span>
    <span class="o">}</span>
  
<span class="o">}</span>
<span class="o">}</span>
<span class="c"># ç¦ç”¨åˆ·æ–°æœŸé—´ï¼Œ_countç»“æœä¸æ›´æ–°</span>
<span class="nv">json</span><span class="o">=</span><span class="s1">'{"index":{"refresh_interval":"-1"}}'</span>
curl <span class="nt">-XPUT</span> 0.0.0.0:9200/geonames/_settings <span class="nt">-H</span> <span class="s1">'Content-Type: application/json'</span> <span class="nt">-d</span> <span class="nv">$json</span>

<span class="c"># ä¸­é€”æƒ³å–æ¶ˆä¹Ÿè¡Œ</span>
curl <span class="nt">-XPOST</span> 0.0.0.0:9200/_tasks/mHCg6HqYTqqd12nIDFDk1w:2977/_cancel

<span class="c"># æ¢å¤åˆ·æ–°æœºåˆ¶</span>
<span class="nv">json</span><span class="o">=</span><span class="s1">'{"index":{"refresh_interval":null}}'</span>
curl <span class="nt">-XPUT</span> 0.0.0.0:9200/geonames/_settings <span class="nt">-H</span> <span class="s1">'Content-Type: application/json'</span> <span class="nt">-d</span> <span class="nv">$json</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="gc-overhead">gc overhead</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>[2019-01-04T08:41:09,538][INFO ][o.e.m.j.JvmGcMonitorService] [elasticsearch-onekey-3] [gc][159] overhead, spent [276ms] collecting in the last [1s]
</pre></td></tr></tbody></table></code></pre></div></div>

<p><code class="highlighter-rouge">è§£å†³æ–¹æ¡ˆ/é—®é¢˜æ ¹æº:</code>é›†ç¾¤è´Ÿè·è¿‡é‡,å®•æœºäº†</p>

<ul>
  <li>indexé•¿æ—¶é—´yellow</li>
</ul>

<p><code class="highlighter-rouge">è§£å†³æ–¹æ¡ˆ/é—®é¢˜æ ¹æº:</code>å…ˆæŠŠ<code class="highlighter-rouge">number_of_replicas</code>è°ƒæˆ0,å†è°ƒå›å»,æ‰‹åŠ¨è§¦å‘åŒæ­¥.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>put geonames/_settings
{
 
    "settings" : {
      "index" : {
        "number_of_replicas" : "0"
    }
  
}
}
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>æ»šåŠ¨é‡å¯</li>
</ul>

<p><a href="https://www.elastic.co/guide/en/elasticsearch/guide/current/_rolling_restarts.html">_rolling_restarts</a></p>

<ul>
  <li>æ…¢æ—¥å¿—åˆ†æ</li>
</ul>

<p>æ…¢æ—¥å¿—åˆ†æœç´¢å’Œç´¢å¼•ä¸¤ç§,å¹¶ä¸”å¯ä»¥ä»index,æˆ–è€…clusterçº§åˆ«è¿›è¡Œè®¾ç½®</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre>PUT _settings
<span class="o">{</span>
        <span class="s2">"index.indexing.slowlog.threshold.index.debug"</span> : <span class="s2">"10ms"</span>,
        <span class="s2">"index.indexing.slowlog.threshold.index.info"</span> : <span class="s2">"50ms"</span>,
        <span class="s2">"index.indexing.slowlog.threshold.index.warn"</span> : <span class="s2">"100ms"</span>,
        <span class="s2">"index.search.slowlog.threshold.fetch.debug"</span> : <span class="s2">"100ms"</span>,
        <span class="s2">"index.search.slowlog.threshold.fetch.info"</span> : <span class="s2">"200ms"</span>,
        <span class="s2">"index.search.slowlog.threshold.fetch.warn"</span> : <span class="s2">"500ms"</span>,
        <span class="s2">"index.search.slowlog.threshold.query.debug"</span> : <span class="s2">"100ms"</span>,
        <span class="s2">"index.search.slowlog.threshold.query.info"</span> : <span class="s2">"200ms"</span>,
        <span class="s2">"index.search.slowlog.threshold.query.warn"</span> : <span class="s2">"1s"</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å‚è€ƒé“¾æ¥:</p>

<ol>
  <li><a href="http://www.fblinux.com/?p=1334">ES æ…¢æŸ¥è¯¢æ”¶é›†æ€»ç»“</a></li>
  <li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-reroute.html">ä½¿ç”¨rerouteæ‰‹åŠ¨è½¬ç§»åˆ†ç‰‡</a></li>
</ol>

<h3 id="no-alive-nodes-found-in-your-cluster">No alive nodes found in your cluster</h3>

<p>è¿™ä¸ªè¦å…·ä½“åˆ†æï¼Œçœ‹çœ‹ESçš„æ—¥å¿—ã€‚æœ‰å¯èƒ½æ˜¯å¹¶å‘è¿æ¥æ•°1000é™åˆ¶å¯¼è‡´çš„é—®é¢˜ã€‚</p>

<h2 id="å‚è€ƒå·¥å…·">å‚è€ƒå·¥å…·</h2>

<p><a href="http://www.elastichq.org/">elasticHQ</a></p>

<h2 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥:</h2>
<ol>
  <li><a href="https://zhuanlan.zhihu.com/p/29449979">å¦‚ä½•ä½¿ç”¨Elasticsearchæ„å»ºä¼ä¸šçº§æœç´¢æ–¹æ¡ˆï¼Ÿ</a></li>
  <li><a href="https://mp.weixin.qq.com/s/K44-L0rclaIM40hma55pPQ">æ»´æ»´Elasticsearchå¤šé›†ç¾¤æ¶æ„å®è·µ</a></li>
  <li><a href="https://www.infoq.cn/article/IfwCVj-qJ4TU0dmBZ177">ä»å¹³å°åˆ°ä¸­å°ï¼šElaticsearch åœ¨èš‚èšé‡‘æœçš„å®è·µç»éªŒ</a></li>
  <li><a href="https://blog.csdn.net/laoyang360/article/details/83048087">ä¸ºä»€ä¹ˆElasticsearchæŸ¥è¯¢å˜å¾—è¿™ä¹ˆæ…¢äº†ï¼Ÿ</a></li>
  <li><a href="https://www.dongwm.com/post/elasticsearch-performance-tuning-practice-at-douban/#%E5%89%8D%E8%A8%80">é€šè¿‡æŸç“£çœŸå®æ¡ˆä¾‹çœ‹Elasticsearchä¼˜åŒ–</a></li>
  <li><a href=""></a></li>
</ol>
:ET