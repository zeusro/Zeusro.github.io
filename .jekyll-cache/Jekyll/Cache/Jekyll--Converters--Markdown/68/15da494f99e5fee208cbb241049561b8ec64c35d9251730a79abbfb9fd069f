I"åf<h2 id="å‰è¨€">å‰è¨€</h2>

<p>æ¥æ”¶åˆ° Gogs çš„web hook ä¹‹å,Jenkinså¯¹Java é¡¹ç›®è¿›è¡Œè‡ªåŠ¨æ„å»º/æµ‹è¯•, æœ€åå°†åº”ç”¨å®¹å™¨åŒ–,æ¨é€åˆ°ç§æœ‰ docker æº(é˜¿é‡Œäº‘)</p>

<h2 id="å‰æœŸå‡†å¤‡">å‰æœŸå‡†å¤‡</h2>

<ol>
  <li>gitea/Gogs</li>
  <li>Jenkins
    <ol>
      <li>Mask Passwords Plugin</li>
      <li>Generic Webhook Trigger</li>
      <li>Gogs plugin</li>
      <li>Maven Integration plugin</li>
      <li>Gradle Plugin</li>
    </ol>
  </li>
</ol>

<p>ä¹Ÿè®¸å¯ç”¨åˆ°çš„ Jenkins æ’ä»¶:</p>
<ol>
  <li>Deploy to container Plugin</li>
  <li>Docker Plugin</li>
</ol>

<h2 id="javaé¡¹ç›®çš„é…ç½®">javaé¡¹ç›®çš„é…ç½®</h2>

<p>è‡ªå®šä¹‰ç§æœ‰æ¡†æ¶ä¾èµ–,é‚£ä¹ˆå‰ç½®å·¥ä½œéœ€è¦å…ˆæ›´æ–°Jenkinsç¯å¢ƒçš„ä¾èµ–,æ‰“åŒ…åˆ° maven local é‡Œé¢.gradle åŒç†(gradleå¯ä»¥æŒ‡å®šå…ˆè¯»å–æœ¬åœ° maven ä¾èµ–,æ‰€ä»¥éƒ½ä¸€æ ·).</p>

<h3 id="mavenæ’ä»¶çš„é€‰æ‹©1dockerfile-maven-extension">mavenæ’ä»¶çš„é€‰æ‹©(1):dockerfile-maven-extension</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>æˆ‘å¯¹è¿™ä¸ªæ’ä»¶æ¯”è¾ƒç†Ÿ,æ‰€ä»¥æˆ‘ä¸€èˆ¬ç”¨è¿™ä¸ª.ä¸è¿‡è¿™æ’ä»¶æœ‰ä¸ªé™åˆ¶, **dockerfile å¿…é¡»æ”¾åœ¨æ¨¡å—æ ¹ç›®å½•é‡Œé¢.**

åˆ‡æ¢åˆ°æ¨¡å—æ‰€åœ¨çš„ç›®å½•,ç„¶åæ‰§è¡Œ`mvn install dockerfile:build -Dmaven.test.skip=true`,æºä»£ç æ²¡é—®é¢˜çš„è¯å°±å¯ä»¥åœ¨ docker image lsé‡Œé¢çœ‹åˆ° **${docker.image.host}/${docker.image.image}:${project.version}** è¿™ä¸ªæ–°é•œåƒçš„äº§ç”Ÿ.
</pre></td></tr></tbody></table></code></pre></div></div>

<p>pom.xml</p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre></td><td class="rouge-code"><pre>	<span class="nt">&lt;properties&gt;</span>
		<span class="nt">&lt;docker.image.host&gt;</span>${docker-registry}<span class="nt">&lt;/docker.image.host&gt;</span>
		<span class="nt">&lt;docker.image.image&gt;</span>${imagename}<span class="nt">&lt;/docker.image.image&gt;</span>
		<span class="nt">&lt;project.build.sourceEncoding&gt;</span>UTF-8<span class="nt">&lt;/project.build.sourceEncoding&gt;</span>
		<span class="nt">&lt;project.reporting.outputEncoding&gt;</span>UTF-8<span class="nt">&lt;/project.reporting.outputEncoding&gt;</span>
		<span class="nt">&lt;java.version&gt;</span>1.8<span class="nt">&lt;/java.version&gt;</span>
	<span class="nt">&lt;/properties&gt;</span>

<span class="nt">&lt;build&gt;</span>
		<span class="nt">&lt;extensions&gt;</span>
			<span class="nt">&lt;extension&gt;</span>
				<span class="nt">&lt;groupId&gt;</span>com.spotify<span class="nt">&lt;/groupId&gt;</span>
				<span class="nt">&lt;artifactId&gt;</span>dockerfile-maven-extension<span class="nt">&lt;/artifactId&gt;</span>
				<span class="nt">&lt;version&gt;</span>1.4.0<span class="nt">&lt;/version&gt;</span>
			<span class="nt">&lt;/extension&gt;</span>
		<span class="nt">&lt;/extensions&gt;</span>
		<span class="nt">&lt;plugins&gt;</span>
			<span class="nt">&lt;plugin&gt;</span>
				<span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
				<span class="nt">&lt;artifactId&gt;</span>spring-boot-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
			<span class="nt">&lt;/plugin&gt;</span>
			<span class="nt">&lt;plugin&gt;</span>
				<span class="nt">&lt;groupId&gt;</span>com.spotify<span class="nt">&lt;/groupId&gt;</span>
				<span class="nt">&lt;artifactId&gt;</span>dockerfile-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
				<span class="nt">&lt;version&gt;</span>1.4.0<span class="nt">&lt;/version&gt;</span>
				<span class="nt">&lt;configuration&gt;</span>
					<span class="nt">&lt;repository&gt;</span>${docker.image.host}/${docker.image.image}<span class="nt">&lt;/repository&gt;</span>
					<span class="nt">&lt;tag&gt;</span>${project.version}<span class="nt">&lt;/tag&gt;</span>
					<span class="nt">&lt;buildArgs&gt;</span>
						<span class="nt">&lt;JAR_FILE&gt;</span>target/${project.build.finalName}.jar<span class="nt">&lt;/JAR_FILE&gt;</span>
					<span class="nt">&lt;/buildArgs&gt;</span>
				<span class="nt">&lt;/configuration&gt;</span>
				<span class="nt">&lt;dependencies&gt;</span>
					<span class="nt">&lt;dependency&gt;</span>
						<span class="nt">&lt;groupId&gt;</span>org.codehaus.plexus<span class="nt">&lt;/groupId&gt;</span>
						<span class="nt">&lt;artifactId&gt;</span>plexus-archiver<span class="nt">&lt;/artifactId&gt;</span>
						<span class="nt">&lt;version&gt;</span>3.4<span class="nt">&lt;/version&gt;</span>
					<span class="nt">&lt;/dependency&gt;</span>
					<span class="nt">&lt;dependency&gt;</span>
						<span class="nt">&lt;groupId&gt;</span>javax.activation<span class="nt">&lt;/groupId&gt;</span>
						<span class="nt">&lt;artifactId&gt;</span>javax.activation-api<span class="nt">&lt;/artifactId&gt;</span>
						<span class="nt">&lt;version&gt;</span>1.2.0<span class="nt">&lt;/version&gt;</span>
					<span class="nt">&lt;/dependency&gt;</span>
				<span class="nt">&lt;/dependencies&gt;</span>
			<span class="nt">&lt;/plugin&gt;</span>
		<span class="nt">&lt;/plugins&gt;</span>
	<span class="nt">&lt;/build&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="mavenæ’ä»¶çš„é€‰æ‹©2maven-dependency-plugin--docker-maven-plugin">mavenæ’ä»¶çš„é€‰æ‹©(2):maven-dependency-plugin + docker-maven-plugin</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>è¿™2ä¸ªæ’ä»¶æ¯”è¾ƒå¤æ‚,ä¸»è¦å› ä¸ºå®ƒæŠŠ dockerfile æ”¾åˆ°äº†é¡¹ç›®çš„ docker ç›®å½•,å¯¼è‡´éœ€è¦copy-resourcesè¿™ä¸€æ­¥

åˆ‡æ¢åˆ°æ¨¡å—æ‰€åœ¨çš„ç›®å½•,ç„¶åæ‰§è¡Œ `mvn ` 
</pre></td></tr></tbody></table></code></pre></div></div>

<p>pom.xml</p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
</pre></td><td class="rouge-code"><pre>
<span class="nt">&lt;build&gt;</span>
		<span class="nt">&lt;plugins&gt;</span>
			<span class="nt">&lt;plugin&gt;</span>
				<span class="nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="nt">&lt;/groupId&gt;</span>
				<span class="nt">&lt;artifactId&gt;</span>maven-jar-plugin<span class="nt">&lt;/artifactId&gt;</span>
				<span class="nt">&lt;version&gt;</span>2.6<span class="nt">&lt;/version&gt;</span>
				<span class="nt">&lt;configuration&gt;</span>
					<span class="nt">&lt;skip&gt;</span>true<span class="nt">&lt;/skip&gt;</span>
					<span class="nt">&lt;archive&gt;</span>
						<span class="nt">&lt;manifest&gt;</span>
							<span class="nt">&lt;addClasspath&gt;</span>true<span class="nt">&lt;/addClasspath&gt;</span>
							<span class="nt">&lt;classpathPrefix&gt;</span>lib/<span class="nt">&lt;/classpathPrefix&gt;</span>
							<span class="nt">&lt;mainClass&gt;</span>com.amiba.zwd.pic.web.ZwdPicWebApplication<span class="nt">&lt;/mainClass&gt;</span>
						<span class="nt">&lt;/manifest&gt;</span>
					<span class="nt">&lt;/archive&gt;</span>
					<span class="nt">&lt;outputDirectory&gt;</span>target/release<span class="nt">&lt;/outputDirectory&gt;</span>
				<span class="nt">&lt;/configuration&gt;</span>
			<span class="nt">&lt;/plugin&gt;</span>
			<span class="nt">&lt;plugin&gt;</span>
				<span class="nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="nt">&lt;/groupId&gt;</span>
				<span class="nt">&lt;artifactId&gt;</span>maven-dependency-plugin<span class="nt">&lt;/artifactId&gt;</span>
				<span class="nt">&lt;version&gt;</span>2.1<span class="nt">&lt;/version&gt;</span>
				<span class="nt">&lt;executions&gt;</span>
					<span class="nt">&lt;execution&gt;</span>
						<span class="nt">&lt;id&gt;</span>copy-dependencies<span class="nt">&lt;/id&gt;</span>
						<span class="nt">&lt;phase&gt;</span>package<span class="nt">&lt;/phase&gt;</span>
						<span class="nt">&lt;goals&gt;</span>
							<span class="nt">&lt;goal&gt;</span>copy-dependencies<span class="nt">&lt;/goal&gt;</span>
						<span class="nt">&lt;/goals&gt;</span>
						<span class="nt">&lt;configuration&gt;</span>
							<span class="nt">&lt;includeScope&gt;</span>compile<span class="nt">&lt;/includeScope&gt;</span>
							<span class="nt">&lt;outputDirectory&gt;</span>target/release/lib<span class="nt">&lt;/outputDirectory&gt;</span>
						<span class="nt">&lt;/configuration&gt;</span>
					<span class="nt">&lt;/execution&gt;</span>
				<span class="nt">&lt;/executions&gt;</span>
			<span class="nt">&lt;/plugin&gt;</span>
			<span class="nt">&lt;plugin&gt;</span>
				<span class="nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="nt">&lt;/groupId&gt;</span>
				<span class="nt">&lt;artifactId&gt;</span>maven-resources-plugin<span class="nt">&lt;/artifactId&gt;</span>
				<span class="nt">&lt;version&gt;</span>2.6<span class="nt">&lt;/version&gt;</span>
				<span class="nt">&lt;executions&gt;</span>
					<span class="nt">&lt;execution&gt;</span>
						<span class="nt">&lt;id&gt;</span>text<span class="nt">&lt;/id&gt;</span>
						<span class="nt">&lt;phase&gt;</span>package<span class="nt">&lt;/phase&gt;</span>
						<span class="nt">&lt;goals&gt;</span>
							<span class="nt">&lt;goal&gt;</span>copy-resources<span class="nt">&lt;/goal&gt;</span>
						<span class="nt">&lt;/goals&gt;</span>
						<span class="nt">&lt;configuration&gt;</span>
							<span class="nt">&lt;outputDirectory&gt;</span>target/release<span class="nt">&lt;/outputDirectory&gt;</span>
							<span class="nt">&lt;encoding&gt;</span>UTF-8<span class="nt">&lt;/encoding&gt;</span>
							<span class="nt">&lt;resources&gt;</span>
								<span class="nt">&lt;resource&gt;</span>
									<span class="nt">&lt;directory&gt;</span>config<span class="nt">&lt;/directory&gt;</span>
									<span class="nt">&lt;includes&gt;</span>
										<span class="nt">&lt;include&gt;</span>*.*<span class="nt">&lt;/include&gt;</span>
									<span class="nt">&lt;/includes&gt;</span>
									<span class="nt">&lt;targetPath&gt;</span>config<span class="nt">&lt;/targetPath&gt;</span>
								<span class="nt">&lt;/resource&gt;</span>
								<span class="nt">&lt;resource&gt;</span>
									<span class="nt">&lt;directory&gt;</span>bin<span class="nt">&lt;/directory&gt;</span>
									<span class="nt">&lt;includes&gt;</span>
										<span class="nt">&lt;include&gt;</span>*.*<span class="nt">&lt;/include&gt;</span>
									<span class="nt">&lt;/includes&gt;</span>
									<span class="nt">&lt;targetPath&gt;</span>bin<span class="nt">&lt;/targetPath&gt;</span>
								<span class="nt">&lt;/resource&gt;</span>
								<span class="nt">&lt;resource&gt;</span>
									<span class="nt">&lt;directory&gt;</span>src/main/docker<span class="nt">&lt;/directory&gt;</span>
								<span class="nt">&lt;/resource&gt;</span>
							<span class="nt">&lt;/resources&gt;</span>
						<span class="nt">&lt;/configuration&gt;</span>
					<span class="nt">&lt;/execution&gt;</span>
				<span class="nt">&lt;/executions&gt;</span>
			<span class="nt">&lt;/plugin&gt;</span>
			<span class="nt">&lt;plugin&gt;</span>
				<span class="nt">&lt;groupId&gt;</span>com.spotify<span class="nt">&lt;/groupId&gt;</span>
				<span class="nt">&lt;artifactId&gt;</span>docker-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
				<span class="nt">&lt;version&gt;</span>0.4.13<span class="nt">&lt;/version&gt;</span>
				<span class="nt">&lt;executions&gt;</span>
					<span class="nt">&lt;execution&gt;</span>
						<span class="nt">&lt;phase&gt;</span>package<span class="nt">&lt;/phase&gt;</span>
						<span class="nt">&lt;goals&gt;</span>
							<span class="nt">&lt;goal&gt;</span>build<span class="nt">&lt;/goal&gt;</span>
						<span class="nt">&lt;/goals&gt;</span>
						<span class="nt">&lt;configuration&gt;</span>
							<span class="nt">&lt;imageName&gt;</span>${project.artifactId}:${project.version}<span class="nt">&lt;/imageName&gt;</span>
						<span class="nt">&lt;/configuration&gt;</span>
					<span class="nt">&lt;/execution&gt;</span>
				<span class="nt">&lt;/executions&gt;</span>
				<span class="nt">&lt;configuration&gt;</span>
					<span class="nt">&lt;dockerDirectory&gt;</span>target/release<span class="nt">&lt;/dockerDirectory&gt;</span>
				<span class="nt">&lt;/configuration&gt;</span>
			<span class="nt">&lt;/plugin&gt;</span>
		<span class="nt">&lt;/plugins&gt;</span>
	<span class="nt">&lt;/build&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="gradleæ’ä»¶çš„é€‰æ‹©compalantirdocker">gradleæ’ä»¶çš„é€‰æ‹©:com.palantir.docker</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>gradle &lt;module&gt;:build -x test --debug  &lt;module&gt;:docker

gradleæ¯” maven å¥½çš„åœ°æ–¹å°±åœ¨äºç®€æ´é«˜æ•ˆ,è€Œä¸”å¯ä»¥ç»§ç»­å¤ç”¨ mavenlocal å’Œ maven çš„è¿œç¨‹ä»“åº“.
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre></td><td class="rouge-code"><pre><span class="na">apply plugin</span><span class="pi">:</span> <span class="s1">'</span><span class="s">com.palantir.docker'</span>
<span class="na">apply plugin</span><span class="pi">:</span> <span class="s1">'</span><span class="s">application'</span>
<span class="na">apply plugin</span><span class="pi">:</span> <span class="s1">'</span><span class="s">org.springframework.boot'</span>


<span class="s">group = '${docker-registry}'</span>
<span class="s">version = project.findProperty('projVersion') ?</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3.0.7'</span>
<span class="s">mainClassName = 'com.zeusro.SBApplication'</span>

<span class="s">buildscript {</span>
    <span class="s">ext {</span>
        <span class="s">springBootVersion = '2.0.4.RELEASE'</span>
    <span class="s">}</span>
    <span class="s">repositories {</span>
        <span class="s">mavenLocal()</span>
        <span class="s">maven { url 'https://maven.aliyun.com/nexus/content/groups/public/' }</span>
        <span class="s">maven { url 'https://maven.aliyun.com/nexus/content/repositories/jcenter' }</span>
        <span class="s">maven { url "https://plugins.gradle.org/m2/" }</span>
    <span class="s">}</span>
    <span class="s">dependencies {</span>
        <span class="s">classpath("org.springframework.boot:spring-boot-gradle-plugin:${springBootVersion}")</span>
        <span class="s">classpath('gradle.plugin.com.palantir.gradle.docker:gradle-docker:0.19.2')</span>
    <span class="s">}</span>
<span class="err">}</span>


<span class="s">tasks.withType(JavaCompile) {</span>
<span class="err">	</span><span class="s">options.encoding = 'UTF-8'</span>
<span class="err">}</span>
<span class="s">dependencies {</span>
    
    <span class="s">compile 'org.mybatis.spring.boot:mybatis-spring-boot-starter:1.3.0'</span>
    <span class="s">compile group</span><span class="pi">:</span> <span class="s1">'</span><span class="s">org.springframework.boot'</span><span class="err">,</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">spring-boot-starter-thymeleaf'</span><span class="err">,</span> <span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2.0.4.RELEASE'</span>
    <span class="na">testCompile group</span><span class="pi">:</span> <span class="s1">'</span><span class="s">org.springframework.boot'</span><span class="err">,</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">spring-boot-starter-test'</span><span class="err">,</span> <span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2.0.4.RELEASE'</span>
    <span class="na">compile group</span><span class="pi">:</span> <span class="s1">'</span><span class="s">org.springframework.data'</span><span class="err">,</span> <span class="na">name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">spring-data-redis'</span><span class="err">,</span> <span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2.0.6.RELEASE'</span>
    <span class="s">compile 'net.sourceforge.nekohtml:nekohtml:1.9.21'</span>
<span class="err">}</span>

<span class="s">docker {</span>
    <span class="s">dockerfile file('Dockerfile') //DockerFileè·¯å¾„</span>
    <span class="s">name "${project.group}/${jar.baseName}:${jar.version}"</span>
    <span class="s">files jar.archivePath</span>
    <span class="s">buildArgs(['JAR_FILE'</span><span class="pi">:</span> <span class="s2">"</span><span class="s">${jar.archiveName}"</span><span class="err">]</span><span class="s">)</span>
<span class="err">}</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="è‡ªåŠ¨åŒ–æ„å»ºçš„ç†å¿µ">è‡ªåŠ¨åŒ–æ„å»ºçš„ç†å¿µ</h2>

<p>æºä»£ç åˆ†ä¸º master å’Œ developåˆ†æ”¯</p>

<p>develop å¯¹åº” docker imageçš„ latest ç‰ˆæœ¬,è¡¨ç¤ºæ¯æ—¥æ›´æ–°;</p>

<p>master æå–gradle çš„ version ä½œä¸ºtag, è¡¨ç¤ºä¸€ç§ç¨³å®šçš„å‘å¸ƒ.master è§¦å‘æœ‰2ç§æœºåˆ¶,ä¸€ç§æ˜¯ tag event,ä¸€ç§æ˜¯merge/push event.å› ä¸º tag äº‹ä»¶éœ€è¦è‡ªå·±å†™ä¸€äº› gitçš„æ“ä½œ,æˆ‘ä¸€èˆ¬å·æ‡’,é€‰æ‹© merge/push event ä½œä¸ºè§¦å‘.</p>

<p>æœ¬æ–‡å°†å…ˆåä»‹ç»2ç§è§¦å‘æ–¹å¼åœ¨ Jenkins é…ç½®ä¸Šé¢çš„ç»†å¾®å·®åˆ«.</p>

<h2 id="jenkins-çš„é…ç½®">Jenkins çš„é…ç½®</h2>

<h3 id="åˆ›å»ºçš„æ—¶å€™é€‰æ‹©-maven-job">åˆ›å»ºçš„æ—¶å€™é€‰æ‹© maven job</h3>

<h3 id="é…ç½®è§¦å‘å™¨">é…ç½®è§¦å‘å™¨</h3>

<p>è¿™é‡Œå…ˆä»‹ç»ä¸€ä¸‹Generic Webhook Trigger è¿™ä¸ªæ’ä»¶.</p>

<p>Generic Webhook Triggerä¸»è¦æœ‰ï¼š Post content parametersã€ Header parametersã€Request parameterså’ŒOptional filterè¿™å‡ ä¸ªç»„æˆã€‚</p>

<p>å…¶ä¸­ï¼ŒPost content parametersæ˜¯å¯¹POSTè¯·æ±‚æ•°æ®çš„å¤„ç†ï¼Œå…¶ä»– Header parametersã€Request parametersç±»ä¼¼ï¼Œåœ¨ä¼—å¤šå˜é‡ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç­›é€‰åˆ°ä¸€ä¸ªå…·æœ‰æ ‡è¯†åˆ†æ”¯çš„å˜é‡ï¼Œrefã€‚</p>

<p>å½“æˆ‘ä»¬pushåˆ°developæ—¶ï¼ŒWebHookæ¨é€çš„ä¿¡æ¯ä¸­ï¼Œrefä¸ºrefs/heads/developï¼Œè€Œpushåˆ°masteræ˜¯refåˆ™ä¸ºrefs/heads/masterï¼Œæ‰€ä»¥ä½¿ç”¨Generic Webhook Trigger Pluginåˆ™å¯ä»¥é€šè¿‡æ­£åˆ™å¯¹æ¨é€å†…å®¹ä¸­çš„refè¿›è¡ŒåŒ¹é…æ„å»º.</p>

<p>å¦‚æœæ˜¯master merge/push äº‹ä»¶çš„è¯,Expressionå¡«<code class="highlighter-rouge">^(refs/heads/master)$</code>;</p>

<p>develop merge/push äº‹ä»¶çš„è¯,Expressionå¡«<code class="highlighter-rouge">^(refs/heads/develop)$</code>;</p>

<p>è¿™ä¸ª Optional filter å¾ˆå…³é”®.</p>

<p><img src="/img/in-post/gogs-Jenkins-java-docker/006mOQRagy1ftoe5v08qvj30z50n7abz.jpg" alt="image" /></p>

<p>å¦‚æœæ˜¯ git çš„ tag äº‹ä»¶çš„è¯,åˆ™æ˜¯</p>

<p><img src="/img/in-post/gogs-Jenkins-java-docker/tag1.png" alt="image" /></p>

<p><img src="/img/in-post/gogs-Jenkins-java-docker/tag2.png" alt="image" /></p>

<p>å‚è€ƒ:
<a href="https://blog.csdn.net/xlgen157387/article/details/76216351">ä½¿ç”¨Generic Webhook Triggeræ’ä»¶å®ç°Jenkins+WebHooksï¼ˆç äº‘ï¼‰æŒç»­é›†æˆâ€“æŒ‡å®šå…·ä½“é¡¹ç›®å’Œåˆ†æ”¯è¿›è¡Œé›†æˆ</a></p>

<h3 id="mask-password-çš„è®¾ç½®é€‰é…">MasK password çš„è®¾ç½®(é€‰é…)</h3>

<p>å…¨å±€è®¾ç½®</p>

<p><img src="/img/in-post/gogs-Jenkins-java-docker/QQæˆªå›¾20180817201130.png" alt="image" /></p>

<p><img src="/img/in-post/gogs-Jenkins-java-docker/QQæˆªå›¾20180817200417.png" alt="image" /></p>

<h3 id="maven-æ„å»º">maven æ„å»º</h3>

<p><img src="/img/in-post/gogs-Jenkins-java-docker/QQæˆªå›¾20180817201545.png" alt="image" /></p>

<p>Post Stepsçš„å†…å®¹æ˜¯æ‰§è¡ŒShell</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>cd xxxx
mvn versions:set -DnewVersion=latest
cd ..
mvn clean package
cd xxxx
mvn install dockerfile:build -Dmaven.test.skip=true
export image=abcde/sadasdf
docker login --username=aaaaaa --password=${DOCKER_PUSH} registry.docker.com
docker push $image:latest;
</pre></td></tr></tbody></table></code></pre></div></div>

<p>è¿™é‡ŒæŒ‰éœ€é…ç½®å³å¯.<code class="highlighter-rouge">DOCKER_PUSH</code>å¯¹åº”ç³»ç»Ÿé…ç½®çš„mask password.</p>

<h3 id="gradleæ„å»º">gradleæ„å»º</h3>

<p>åˆ›å»ºä¸€ä¸ª<code class="highlighter-rouge">free style</code>çš„Jenkins job.æ„å»ºæ­¥éª¤å…ˆå¢åŠ <code class="highlighter-rouge">Invoke Gradle script</code></p>

<p><img src="/img/in-post/gogs-Jenkins-java-docker/QQæˆªå›¾20180817203704.png" alt="image" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="c">#è¿™ä¸ªæ­£åˆ™åªé€‚ç”¨äºç‰ˆæœ¬å·å½¢ä¼¼1.0.1è¿™ç§,æŒ‰éœ€å®šåˆ¶å³å¯.</span>
<span class="nv">version</span><span class="o">=</span><span class="sb">`</span>docker image <span class="nb">ls</span> &lt;imagename&gt; |grep <span class="nt">-Eo</span> <span class="s1">'([0-9]{0,2}\.){2}[0-9]+'</span>| <span class="nb">head</span> <span class="nt">-1</span><span class="sb">`</span> 
docker login <span class="nt">--username</span><span class="o">=</span>aaaaaa <span class="nt">--password</span><span class="o">=</span><span class="k">${</span><span class="nv">DOCKER_PUSH</span><span class="k">}</span> registry.docker.com
docker push <span class="nv">$image</span>:<span class="nv">$version</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="giteagogs-çš„é…ç½®">gitea/gogs çš„é…ç½®</h2>

<p>åŠ ä¸€ä¸ª gogså‹çš„ web hook,è§¦å‘ç±»å‹æŒ‰ç…§å®é™…éœ€è¦é…ç½®å°±è¡Œ. åœ°å€å¡« Jenkins jobé‡Œé¢å†™çš„ url.å½¢ä¼¼http://[host]/generic-webhook-trigger/invoke?token=abc123</p>

<p>ä¸‹å›¾ä¸­èº«ä»½éªŒè¯ä»¤ç‰Œæ‰“çš„é©¬èµ›å…‹å°±æ˜¯äº†.</p>

<p><img src="/img/in-post/gogs-Jenkins-java-docker/QQ20180817-173620.png" alt="image" /></p>

<p>å¦‚æœä½ è¿˜å«Œä¸å¤Ÿå®‰å…¨ï¼Œå¯ä»¥åœ¨ä¸ºè§¦å‘æ„å»ºæ·»åŠ ä¸€ä¸ªSecretï¼Œå¯¹åº”çš„jenkinsè®¾ç½®å¤„å¦‚ä¸‹å›¾ï¼š
<img src="/img/in-post/gogs-Jenkins-java-docker/006mOQRagy1ftswi8yepfj31940aot94.jpg" alt="image" /></p>

<p>äº‹ä»¶çš„å°±æŒ‰ç…§å®é™…éœ€è¦äº†,æˆ‘ä¸€èˆ¬å‹¾é€‰merger/tagè¿™2ç±»äº‹ä»¶.æœ€åç‚¹å‡»æµ‹è¯•web hookæ£€æŸ¥ä¸€ä¸‹Jenkinsçš„æ„å»ºå°±å¥½äº†.</p>

<p><img src="/img/in-post/gogs-Jenkins-java-docker/006mOQRagy1ftswl83ae2j311h07hweq.jpg" alt="image" /></p>

<p>é¢å¤–è¯´æ˜ä¸€ç‚¹,æ„å»ºåŒä¸€ä¸ªä»“åº“developå’Œmasteråˆ†æ”¯å¯¹åº”çš„2ä¸ªJenkins jobå¯ä»¥å¡«åŒä¸€ä¸ªurl,å› ä¸ºæˆ‘ä»¬ç”¨äº†<code class="highlighter-rouge">Generic Webhook Trigger </code>,æ»¡è¶³æ¡ä»¶æ‰ä¼šè§¦å‘æ„å»º</p>

<h2 id="å…¶ä»–æ³¨æ„äº‹é¡¹">å…¶ä»–æ³¨æ„äº‹é¡¹ï¼š</h2>

<h3 id="gradleç›¸å…³é—®é¢˜">gradleç›¸å…³é—®é¢˜</h3>

<p>gradleé¡¹ç›®æ¥å…¥jenkinsï¼Œå› ä¸ºdevelopåˆ†æ”¯å¯¹åº”çš„é¡¹ç›®ç‰ˆæœ¬è¦ä¸ºlatestï¼Œè¿™ä¸ªé•œåƒæ„å»ºå‡ºæ¥çš„æ‰ä¸ºlatestï¼Œæ‰€ä»¥éœ€è¦ä¸ºbuild.gradleæ·»åŠ versionè®¾ç½®ï¼Œå¦‚ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>if (project.hasProperty('projVersion')) {
  project.version = project.projVersion
} else {
  project.version = '10.0.0'
}
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ„å»ºæ—¶ä¾¿å¯ä»¥åŠ¨æ€æ”¹å˜ç‰ˆæœ¬äº†ã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>gradle <span class="nt">-PprojVersion</span><span class="o">=</span>latest build
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="mavenç›¸å…³é—®é¢˜">mavenç›¸å…³é—®é¢˜</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>	<span class="c"># è¿™æ ·æ„å»ºå‡ºæ¥çš„jaråŒ…æ˜¯å¸¦latestç»“å°¾çš„</span>
	mvn versions:set <span class="nt">-DnewVersion</span><span class="o">=</span>latest
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="å…¶ä»–ä¾èµ–çš„é—®é¢˜">å…¶ä»–ä¾èµ–çš„é—®é¢˜</h3>

<p>éœ€è¦å¯¼å…¥æœ¬åœ°jaræ—¶ï¼Œæœ‰ä¸¤ç§æ–¹æ³•ï¼š</p>
<ol>
  <li>ä¼ ç»Ÿæ–¹æ³•ï¼Œç›´æ¥æ‹‰åˆ°jenkinsæ‰€åœ¨æœåŠ¡å™¨ï¼Œè¿›è¡Œæ‰‹åŠ¨å¯¼åŒ…ã€‚</li>
  <li>åˆ›å»ºJenkinsé¡¹ç›®ï¼Œè¿›è¡Œè‡ªåŠ¨æ„å»ºå¹¶æ‰§è¡Œå¯¼å…¥ä»“åº“å‘½ä»¤ã€‚</li>
</ol>

<h2 id="ä»‹ç»ä¸€äº›ä¼˜åŒ–æŠ€å·§">ä»‹ç»ä¸€äº›ä¼˜åŒ–æŠ€å·§</h2>

<ul>
  <li>
    <p>è®¾ç½®Jenkinså›½å†…é•œåƒ
ã€ç³»ç»Ÿç®¡ç†ã€‘ã€ç®¡ç†æ’ä»¶ã€‘ã€é«˜çº§ã€‘å‡çº§ç«™ç‚¹é¡¹çš„çš„åœ°å€ä¿®æ”¹æˆ
https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/2.107/update-center.json</p>
  </li>
  <li>
    <p>gitlab-hookå®‰è£…å¤±è´¥çš„é—®é¢˜
https://stackoverflow.com/questions/44403642/jenkins-plugin-installation-failing</p>
  </li>
  <li>
    <p><a href="http://www.cnblogs.com/EasonJim/p/6373769.html">è®¾ç½® Jenkins ä¸ºä¸­æ–‡</a></p>
    <ol>
      <li>å®‰è£…Locale plugin</li>
      <li>Jenkins-&gt;ã€ç³»ç»Ÿç®¡ç†ã€‘-&gt;ã€ç³»ç»Ÿè®¾ç½®ã€‘-&gt;ã€Localeã€‘ï¼Œè¾“å…¥ï¼šzh_CN</li>
    </ol>
  </li>
</ul>

<h2 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥:</h2>
<ol>
  <li><a href="https://www.phpsong.com/3394.html">jenkins æ›´æ–°æ’ä»¶æº</a></li>
</ol>
:ET