I"ò><p>ÂùëÂ§™Â§ö‰∫Ü‰∏çËß£Èáä.Áõ¥Êé•Ë¥¥docker-compose.yaml Âêß</p>

<h2 id="3‰∏™agentÈúÄË¶ÅÂ•áÊï∞‰∏™agentË∑üÈÄâ‰∏ªÁÆóÊ≥ïÊúâÂÖ≥">3‰∏™agent(ÈúÄË¶ÅÂ•áÊï∞‰∏™agent,Ë∑üÈÄâ‰∏ªÁÆóÊ≥ïÊúâÂÖ≥)</h2>

<h3 id="agent1">agent1</h3>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="rouge-code"><pre><span class="c1"># </span>
<span class="na">consul-server1</span><span class="pi">:</span>
  <span class="na">image</span><span class="pi">:</span> <span class="s1">'</span><span class="s">consul:1.2.0'</span>
  <span class="na">command</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">agent</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">-bind={{</span><span class="nv"> </span><span class="s">GetInterfaceIP</span><span class="nv"> </span><span class="s">"eth0"</span><span class="nv"> </span><span class="s">}}'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">-client={{</span><span class="nv"> </span><span class="s">GetInterfaceIP</span><span class="nv"> </span><span class="s">"eth0"</span><span class="nv"> </span><span class="s">}}'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">-server'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">-node=consulserver1'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">-bootstrap-expect=3'</span>
  <span class="na">restart</span><span class="pi">:</span> <span class="s">always</span>
  <span class="na">hostname</span><span class="pi">:</span> <span class="s">consulserver1</span>
  <span class="na">network</span><span class="pi">:</span> <span class="s">host</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">8300:8300/tcp'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">8302:8302/udp'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">8302:8302/tcp'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">8600:8600/udp'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">8600:8600/tcp'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">8301:8301/tcp'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">8301:8301/udp'</span>
  <span class="na">volumes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">/consul/data:/consul/data'</span>
  <span class="na">environment</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">constraint:aliyun.node_index==1'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">CONSUL_CLIENT_INTERFACE=eth0'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">CONSUL_BIND_INTERFACE=eth0'</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="s">aliyun.auto_scaling.min_memory</span><span class="pi">:</span> <span class="s1">'</span><span class="s">0'</span>
    <span class="s">aliyun.auto_scaling.max_memory</span><span class="pi">:</span> <span class="s1">'</span><span class="s">95'</span>
    <span class="s">aliyun.scale</span><span class="pi">:</span> <span class="s1">'</span><span class="s">1'</span>
<span class="c1"># </span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="agent2">agent2</h3>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre></td><td class="rouge-code"><pre><span class="c1"># </span>
<span class="na">consul-server2</span><span class="pi">:</span>
  <span class="na">image</span><span class="pi">:</span> <span class="s1">'</span><span class="s">consul:1.2.0'</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">8300:8300/tcp'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">8302:8302/udp'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">8302:8302/tcp'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">8600:8600/udp'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">8600:8600/tcp'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">8301:8301/tcp'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">8301:8301/udp'</span> 
  <span class="na">command</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">agent</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">-bind={{</span><span class="nv"> </span><span class="s">GetInterfaceIP</span><span class="nv"> </span><span class="s">"eth0"</span><span class="nv"> </span><span class="s">}}'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">-client={{</span><span class="nv"> </span><span class="s">GetInterfaceIP</span><span class="nv"> </span><span class="s">"eth0"</span><span class="nv"> </span><span class="s">}}'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">-server'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">-retry-join=consulserver1'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">-node=consulserver2'</span>
  <span class="na">restart</span><span class="pi">:</span> <span class="s">always</span>
  <span class="na">hostname</span><span class="pi">:</span> <span class="s">consulserver2</span>
  <span class="na">network</span><span class="pi">:</span> <span class="s">host</span>
  <span class="na">volumes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">/consul/data:/consul/data'</span>
  <span class="na">environment</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">constraint:aliyun.node_index==2'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">CONSUL_CLIENT_INTERFACE=eth0'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">CONSUL_BIND_INTERFACE=eth0'</span>   
  <span class="na">labels</span><span class="pi">:</span>
    <span class="s">aliyun.auto_scaling.min_memory</span><span class="pi">:</span> <span class="s1">'</span><span class="s">0'</span>
    <span class="s">aliyun.auto_scaling.max_memory</span><span class="pi">:</span> <span class="s1">'</span><span class="s">95'</span>
    <span class="s">aliyun.scale</span><span class="pi">:</span> <span class="s1">'</span><span class="s">1'</span>
  <span class="na">memswap_limit</span><span class="pi">:</span> <span class="m">0</span>
  <span class="na">shm_size</span><span class="pi">:</span> <span class="m">0</span>
  <span class="na">memswap_reservation</span><span class="pi">:</span> <span class="m">0</span>
  <span class="na">kernel_memory</span><span class="pi">:</span> <span class="m">0</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">consul-server2</span>
<span class="c1"># </span>

</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="agent3">agent3</h3>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="rouge-code"><pre><span class="c1"># </span>
<span class="na">consul-server3</span><span class="pi">:</span>
  <span class="na">image</span><span class="pi">:</span> <span class="s1">'</span><span class="s">consul:1.2.0'</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">8300:8300/tcp'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">8302:8302/udp'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">8302:8302/tcp'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">8600:8600/udp'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">8600:8600/tcp'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">8301:8301/tcp'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">8301:8301/udp'</span>
  <span class="na">command</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">agent</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">-bind={{</span><span class="nv"> </span><span class="s">GetInterfaceIP</span><span class="nv"> </span><span class="s">"eth0"</span><span class="nv"> </span><span class="s">}}'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">-client={{</span><span class="nv"> </span><span class="s">GetInterfaceIP</span><span class="nv"> </span><span class="s">"eth0"</span><span class="nv"> </span><span class="s">}}'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">-server'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">-retry-join=consulserver1'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">-node=consulserver3'</span>  
  <span class="na">volumes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">/consul/data:/consul/data'</span>
  <span class="na">restart</span><span class="pi">:</span> <span class="s">always</span>
  <span class="na">network</span><span class="pi">:</span> <span class="s">host</span>
  <span class="na">hostname</span><span class="pi">:</span> <span class="s">consulserver3</span>
  <span class="na">environment</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">constraint:aliyun.node_index==3'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">CONSUL_CLIENT_INTERFACE=eth0'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">CONSUL_BIND_INTERFACE=eth0'</span>   
  <span class="na">labels</span><span class="pi">:</span>
    <span class="s">aliyun.scale</span><span class="pi">:</span> <span class="s1">'</span><span class="s">1'</span>
    <span class="s">aliyun.auto_scaling.max_memory</span><span class="pi">:</span> <span class="s1">'</span><span class="s">95'</span>
    <span class="s">aliyun.auto_scaling.min_memory</span><span class="pi">:</span> <span class="s1">'</span><span class="s">0'</span>
<span class="c1"># </span>

</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="‰∏Ä‰∏™-client">‰∏Ä‰∏™ client</h2>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre><span class="c1"># </span>
<span class="na">consul-client</span><span class="pi">:</span>
  <span class="na">image</span><span class="pi">:</span> <span class="s1">'</span><span class="s">consul:1.2.0'</span>
  <span class="na">expose</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">8500"</span>
  <span class="na">restart</span><span class="pi">:</span> <span class="s">always</span>    
  <span class="na">container_name</span><span class="pi">:</span> <span class="s">consul</span>  
  <span class="na">command</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">agent</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">-bind={{</span><span class="nv"> </span><span class="s">GetInterfaceIP</span><span class="nv"> </span><span class="s">"eth0"</span><span class="nv"> </span><span class="s">}}'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">-client={{</span><span class="nv"> </span><span class="s">GetInterfaceIP</span><span class="nv"> </span><span class="s">"eth0"</span><span class="nv"> </span><span class="s">}}'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">-ui'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">-retry-join=consulserver1'</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">-node=client'</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="s">aliyun.scale</span><span class="pi">:</span> <span class="s1">'</span><span class="s">1'</span>  
    <span class="s">aliyun.auto_scaling.max_memory</span><span class="pi">:</span> <span class="s1">'</span><span class="s">95'</span>
    <span class="s">aliyun.auto_scaling.min_memory</span><span class="pi">:</span> <span class="s1">'</span><span class="s">0'</span>      
    <span class="s">aliyun.routing.port_8500</span><span class="pi">:</span> <span class="s2">"</span><span class="s">https://abcd.com"</span>
  <span class="na">environment</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">constraint:aliyun.node_index==4'</span>
<span class="c1"># </span>

</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="Ê≥®ÊÑè">Ê≥®ÊÑè</h2>

<ol>
  <li>ÊúçÂä°ÁºñÊéíÈáåÈù¢ÂêØÂä®ÂèÇÊï∞ÈÇ£2‰∏™Â§ßÊã¨Âè∑Ë∑üjekyllËØ≠Ê≥ïÂÜ≤Á™Å,ÂÖ∑‰ΩìÁºñÊéíËßÅ<a href="https://github.com/zeusro/Zeusro.github.io/blob/master/_posts/2018-06-28-consul-on-aliyun-swarm.md">GithubÂéüÊñá</a></li>
  <li>Âõ†‰∏∫2Âíå3ÁöÑagentÈÖçÁöÑ<code class="highlighter-rouge">retry-join=consulserver1</code>,ÊâÄ‰ª•<code class="highlighter-rouge">consul-server1</code>‰∏ÄÂÆöË¶ÅÂÖàÂêØÂä®.ÁÑ∂ÂêéÂÜçÂêØÂä®2Âíå3,ÊúÄÂêéÂêØÂä® client.</li>
  <li>consul-clientÁî®‰∫ÜÈòøÈáå‰∫ëÁöÑÁÆÄÂçïË∑ØÁî±,ÊâÄ‰ª•Áõ¥Êé•ÊãøÂÆπÂô®ÁöÑ<code class="highlighter-rouge">8500</code>Á´ØÂè£Êù•Áî®Â∞±Ë°å.Â¶ÇÊûúÊòØÂÖ∂‰ªñÊñπÂºèÁöÑËØù,Ëá™Â∑±ÈÖåÊÉÖÈÖçÁΩÆ
    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s1">'</span><span class="s">80:8500'</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>ÂÖ∂‰ªñaliyunÁöÑÊ†áÁ≠æÂ∞±‰∏çËØ¥Êòé‰∫Ü,Ë∑ü‰∏ªÈ¢òÊó†ÂÖ≥.</li>
  <li>ÊúÄÂêéÊàëÂÜçË°•ÂÖÖ‰∏ÄÁÇπ,ÊàëËøô‰∏™ÈÖçÁΩÆÊòØ‰∏Ä‰∏™Êú∫Âô®ÈÉ®ÁΩ≤‰∏Ä‰∏™ agent, ÊúÄÂêéÊåëÁ¨¨ÂõõÂè∞Êú∫‰Ωú client ÁöÑ,Ê≤°ÊúâÈÇ£‰πàÂ§öÊú∫Âô®ÁöÑ,Âà´ÈóÆÊàëÊÄé‰πàÈÖç.Ëá™Â∑±‰π∞Êú∫Âô®ÂéªÈÖçÂ∞±Ë°å‰∫Ü.</li>
</ol>

<h2 id="k8s">k8s</h2>

<p>‰∫≤ÊµãÊääconsul:1.2.3ÂÆâË£ÖÂú®‰∫Ü1.11.2ÁöÑÈõÜÁæ§,ÂÖ∑‰ΩìËßÅ<a href="https://github.com/zeusro/deploy-consul-on-kubernetes">zeusro/deploy-consul-on-kubernetes</a></p>

<h2 id="ÂèÇËÄÉÈìæÊé•">ÂèÇËÄÉÈìæÊé•</h2>

<ol>
  <li>https://www.jianshu.com/p/f8746b81d65d</li>
  <li>https://www.consul.io/docs/guides/consul-containers.html</li>
  <li>https://my.oschina.net/jywm/blog/760183</li>
  <li>https://www.consul.io/docs/guides/outage.html</li>
  <li>https://www.consul.io/docs/agent/options.html#_bootstrap_expect</li>
  <li>http://dockone.io/question/786</li>
  <li>https://github.com/hashicorp/consul/issues/993</li>
  <li>https://github.com/hashicorp/consul/issues/454</li>
  <li>http://gaocegege.com/Blog/distributed%20system/try-consul</li>
</ol>
:ET