I"²m<h2 id="ä¸€äº›å®ç”¨å·¥å…·">ä¸€äº›å®ç”¨å·¥å…·</h2>

<ol>
  <li><a href="https://github.com/kubernetes/kompose">kompose</a></li>
</ol>

<p>å¯ç”¨äºè½¬åŒ–docker-composeæ–‡ä»¶,å¯¹äºåˆå­¦kubernetesçš„äººå¾ˆæœ‰å¸®åŠ©</p>

<h2 id="å®‰è£…ç±»å·¥å…·">å®‰è£…ç±»å·¥å…·</h2>

<ol>
  <li><a href="https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/">kubeadm</a></li>
  <li></li>
</ol>

<p>å‚è€ƒ:</p>
<ol>
  <li><a href="https://kubernetes.io/cn/docs/tasks/tls/certificate-rotation/">è¯ä¹¦è½®æ¢</a></li>
</ol>

<h2 id="è¿›é˜¶è°ƒåº¦">è¿›é˜¶è°ƒåº¦</h2>

<p>æ¯ä¸€ç§äº²å’Œåº¦éƒ½æœ‰2ç§è¯­å¢ƒ:preferred,required.preferredè¡¨ç¤ºå€¾å‘æ€§,requiredåˆ™æ˜¯å¼ºåˆ¶.</p>

<h3 id="ä½¿ç”¨äº²å’Œåº¦ç¡®ä¿èŠ‚ç‚¹åœ¨ç›®æ ‡èŠ‚ç‚¹ä¸Šè¿è¡Œ">ä½¿ç”¨äº²å’Œåº¦ç¡®ä¿èŠ‚ç‚¹åœ¨ç›®æ ‡èŠ‚ç‚¹ä¸Šè¿è¡Œ</h3>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>        <span class="na">nodeAffinity</span><span class="pi">:</span>
          <span class="na">requiredDuringSchedulingIgnoredDuringExecution</span><span class="pi">:</span>
            <span class="na">nodeSelectorTerms</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">matchExpressions</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">elasticsearch-test-ready</span>
                <span class="na">operator</span><span class="pi">:</span> <span class="s">Exists</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å‚è€ƒé“¾æ¥:</p>
<ol>
  <li><a href="https://kubernetes.io/blog/2017/03/advanced-scheduling-in-kubernetes/">advanced-scheduling-in-kubernetes</a></li>
  <li><a href="https://cizixs.com/2017/05/17/kubernetes-scheulder-affinity/">kubernetes-scheulder-affinity</a></li>
</ol>

<h3 id="ä½¿ç”¨åäº²å’Œåº¦ç¡®ä¿æ¯ä¸ªèŠ‚ç‚¹åªè·‘åŒä¸€ä¸ªåº”ç”¨">ä½¿ç”¨åäº²å’Œåº¦ç¡®ä¿æ¯ä¸ªèŠ‚ç‚¹åªè·‘åŒä¸€ä¸ªåº”ç”¨</h3>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre>      <span class="na">affinity</span><span class="pi">:</span>
        <span class="na">podAntiAffinity</span><span class="pi">:</span>
          <span class="na">requiredDuringSchedulingIgnoredDuringExecution</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">labelSelector</span><span class="pi">:</span>
              <span class="na">matchExpressions</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s1">'</span><span class="s">app'</span>
                <span class="na">operator</span><span class="pi">:</span> <span class="s">In</span>
                <span class="na">values</span><span class="pi">:</span>
                <span class="pi">-</span> <span class="s">nginx-test2</span>
            <span class="na">topologyKey</span><span class="pi">:</span> <span class="s2">"</span><span class="s">kubernetes.io/hostname"</span>
            <span class="na">namespaces</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">test</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre>      <span class="na">affinity</span><span class="pi">:</span>
        <span class="na">podAntiAffinity</span><span class="pi">:</span>
          <span class="na">preferredDuringSchedulingIgnoredDuringExecution</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">weight</span><span class="pi">:</span> <span class="m">100</span>
            <span class="na">podAffinityTerm</span><span class="pi">:</span>
              <span class="na">topologyKey</span><span class="pi">:</span> <span class="s2">"</span><span class="s">kubernetes.io/hostname"</span>
              <span class="na">namespaces</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="s">test</span>
              <span class="na">labelSelector</span><span class="pi">:</span>
                <span class="na">matchExpressions</span><span class="pi">:</span>
                <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s1">'</span><span class="s">app'</span>
                  <span class="na">operator</span><span class="pi">:</span> <span class="s">In</span>
                  <span class="na">values</span><span class="pi">:</span>
                   <span class="pi">-</span> <span class="s2">"</span><span class="s">nginx-test2"</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="tolerations-å’Œ-taint">tolerations å’Œ taint</h3>

<p>tolerations å’Œ taint æ€»æ˜¯ç»“å¯¹å­˜åœ¨, taint å°±åƒæ˜¯â€è™½ç„¶æˆ‘åˆè½,æŠ½çƒŸ,æœˆå…‰,ä½†æˆ‘è¿˜æ˜¯ä¸€ä¸ªå¥½å¥³äººâ€,è¿™ç§æ±¡ç‚¹(taint)ä¸€èˆ¬ä¼šè®©ä¸€èˆ¬ç”·æ€§(pod)æ•¬è€Œè¿œä¹‹,ä½†æ€»æœ‰å‡ ä¸ªè€å®äººèƒ½å¤Ÿå®¹å¿(tolerations).</p>

<h4 id="taint">taint</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>kubectl taint nodes xx  elasticsearch-test-ready<span class="o">=</span><span class="nb">true</span>:NoSchedule
kubectl taint nodes xx  elasticsearch-test-ready:NoSchedule-
</pre></td></tr></tbody></table></code></pre></div></div>

<p>masterèŠ‚ç‚¹æœ¬èº«å°±è‡ªå¸¦taint,æ‰€ä»¥æ‰ä¼šå¯¼è‡´æˆ‘ä»¬å‘å¸ƒçš„å®¹å™¨ä¸ä¼šåœ¨masterèŠ‚ç‚¹ä¸Šé¢è·‘.ä½†æ˜¯å¦‚æœè‡ªå®šä¹‰<code class="highlighter-rouge">taint</code>çš„è¯å°±è¦æ³¨æ„äº†!æ‰€æœ‰<code class="highlighter-rouge">DaemonSet</code>å’Œkube-system,éƒ½éœ€è¦å¸¦ä¸Šç›¸åº”çš„<code class="highlighter-rouge">tolerations</code>.ä¸ç„¶è¯¥èŠ‚ç‚¹ä¼šé©±é€æ‰€æœ‰ä¸å¸¦è¿™ä¸ª<code class="highlighter-rouge">tolerations</code>çš„å®¹å™¨,ç”šè‡³åŒ…æ‹¬ç½‘ç»œæ’ä»¶,kube-proxy,åæœç›¸å½“ä¸¥é‡,è¯·æ³¨æ„</p>

<p><code class="highlighter-rouge">taint</code>è·Ÿ<code class="highlighter-rouge">tolerations</code>æ˜¯ç»“å¯¹å¯¹åº”å­˜åœ¨çš„,æ“ä½œç¬¦ä¹Ÿä¸èƒ½ä¹±ç”¨</p>

<h4 id="tolerations">tolerations</h4>

<h5 id="noexecute">NoExecute</h5>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>      <span class="na">tolerations</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">elasticsearch-exclusive"</span>
          <span class="na">operator</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Equal"</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>
          <span class="na">effect</span><span class="pi">:</span> <span class="s2">"</span><span class="s">NoExecute"</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>kubectl taint node cn-shenzhen.xxxx  elasticsearch-exclusive=true:NoExecute</p>

<p>NoExecuteæ˜¯ç«‹åˆ»é©±é€ä¸æ»¡è¶³å®¹å¿æ¡ä»¶çš„pod,è¯¥æ“ä½œéå¸¸å‡¶é™©,è¯·åŠ¡å¿…å…ˆè¡Œç¡®è®¤ç³»ç»Ÿç»„ä»¶æœ‰å¯¹åº”é…ç½®tolerations.</p>

<p>ç‰¹åˆ«æ³¨æ„ç”¨<code class="highlighter-rouge">Exists</code>è¿™ä¸ªæ“ä½œç¬¦æ˜¯æ— æ•ˆçš„,å¿…é¡»ç”¨<code class="highlighter-rouge">Equal</code></p>

<h5 id="noschedule">NoSchedule</h5>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>      <span class="na">tolerations</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">elasticsearch-exclusive"</span>
          <span class="na">operator</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Exists"</span>
          <span class="na">effect</span><span class="pi">:</span> <span class="s2">"</span><span class="s">NoSchedule"</span>
        <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">elasticsearch-exclusive"</span>
          <span class="na">operator</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Equal"</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>
          <span class="na">effect</span><span class="pi">:</span> <span class="s2">"</span><span class="s">NoExecute"</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>kubectl taint node cn-shenzhen.xxxx  elasticsearch-exclusive=true:NoSchedule</p>

<p>æ˜¯å°½é‡ä¸å¾€è¿™ä¸Šé¢è°ƒåº¦,ä½†å®é™…ä¸Šè¿˜æ˜¯ä¼šæœ‰podåœ¨é‚£ä¸Šé¢è·‘</p>

<p><code class="highlighter-rouge">Exists</code>å’Œ<code class="highlighter-rouge">Exists</code>éšæ„ä½¿ç”¨,ä¸æ˜¯å¾ˆå½±å“</p>

<p>å€¼å¾—ä¸€æçš„æ˜¯,åŒä¸€ä¸ªkeyå¯ä»¥åŒæ—¶å­˜åœ¨å¤šä¸ªeffect</p>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="na">Taints</span><span class="pi">:</span>             <span class="s">elasticsearch-exclusive=true:NoExecute</span>
                    <span class="s">elasticsearch-exclusive=true:NoSchedule</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å…¶ä»–å‚è€ƒé“¾æ¥ï¼š</p>

<ol>
  <li><a href="https://jimmysong.io/posts/kubernetes-taint-and-toleration/">Kubernetesä¸­çš„Taintå’ŒTolerationï¼ˆæ±¡ç‚¹å’Œå®¹å¿ï¼‰</a></li>
  <li><a href="https://segmentfault.com/a/1190000012709117#articleHeader8">kubernetesçš„è°ƒåº¦æœºåˆ¶</a></li>
</ol>

<h2 id="å®¹å™¨ç¼–æ’çš„æŠ€å·§">å®¹å™¨ç¼–æ’çš„æŠ€å·§</h2>

<h3 id="wait-for-it">wait-for-it</h3>

<p>k8sç›®å‰æ²¡æœ‰æ²¡æœ‰ç±»ä¼¼docker-composeçš„<code class="highlighter-rouge">depends_on</code>ä¾èµ–å¯åŠ¨æœºåˆ¶,å»ºè®®ä½¿ç”¨<a href="https://blog.giantswarm.io/wait-for-it-using-readiness-probes-for-service-dependencies-in-kubernetes/">wait-for-it</a>é‡å†™é•œåƒçš„command.</p>

<h3 id="åœ¨cmdä¸­ä½¿ç”¨åŒå¼•å·çš„åŠæ³•">åœ¨cmdä¸­ä½¿ç”¨åŒå¼•å·çš„åŠæ³•</h3>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>
               <span class="pi">-</span> <span class="s2">"</span><span class="s">/bin/sh"</span>
               <span class="pi">-</span> <span class="s2">"</span><span class="s">-ec"</span>
               <span class="pi">-</span> <span class="pi">|</span>
                  <span class="s">curl -X POST --connect-timeout 5 -H 'Content-Type: application/json' \</span>
                  <span class="s">elasticsearch-logs:9200/logs,tracing,tracing-test/_delete_by_query?conflicts=proceed  \</span>
                  <span class="s">-d '{"query":{"range":{"@timestamp":{"lt":"now-90d","format": "epoch_millis"}}}}'</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="k8sçš„-master-cluster-æ¶æ„">k8sçš„ master-cluster æ¶æ„</h2>

<h3 id="mastercontrol-plane">master(CONTROL PLANE)</h3>

<ul>
  <li>
    <p>etcd distributed persistent storage</p>

    <p>Consistent and highly-available key value store used as Kubernetesâ€™ backing store for all cluster data.</p>
  </li>
  <li>
    <p>kube-apiserver</p>

    <p>front-end for the Kubernetes control plane.</p>
  </li>
  <li>
    <p>kube-scheduler</p>

    <p>Component on the master that watches newly created pods that have no node assigned, and selects a node for them to run on.</p>
  </li>
  <li>Controller Manager
    <ul>
      <li>
        <p>Node Controller</p>

        <p>Responsible for noticing and responding when nodes go down.</p>
      </li>
      <li>
        <p>Replication Controller</p>

        <p>Responsible for maintaining the correct number of pods for every replication controller object in the system.</p>
      </li>
      <li>
        <p>Endpoints Controller</p>

        <p>Populates the Endpoints object (that is, joins Services &amp; Pods).</p>
      </li>
      <li>
        <p>Service Account &amp; Token Controllers</p>

        <p>Create default accounts and API access tokens for new namespaces.</p>
      </li>
    </ul>
  </li>
  <li>cloud-controller-manager(<strong>alpha feature</strong>)
    <ul>
      <li>
        <p>Node Controller</p>

        <p>For checking the cloud provider to determine if a node has been deleted in the cloud after it stops responding</p>
      </li>
      <li>
        <p>Route Controller</p>

        <p>For setting up routes in the underlying cloud infrastructure</p>
      </li>
      <li>
        <p>Service Controller</p>

        <p>For creating, updating and deleting cloud provider load balancers</p>
      </li>
      <li>
        <p>Volume Controller</p>

        <p>For creating, attaching, and mounting volumes, and interacting with the cloud provider to orchestrate volumes</p>
      </li>
    </ul>
  </li>
</ul>

<p>å‚è€ƒé“¾æ¥:</p>
<ol>
  <li><a href="https://blog.csdn.net/huwh_/article/details/75675761">Kubernetesæ ¸å¿ƒåŸç†ï¼ˆäºŒï¼‰ä¹‹Controller Manager</a></li>
  <li><a href="https://kubernetes.io/docs/concepts/overview/components/">Kubernetesç»„ä»¶</a></li>
</ol>

<h3 id="worker-nodes">worker nodes</h3>

<ul>
  <li>
    <p>Kubelet</p>

    <p>The kubelet is the primary â€œnode agentâ€ that runs on each node.</p>
  </li>
  <li>
    <p>Kubernetes Proxy</p>

    <p>kube-proxy enables the Kubernetes service abstraction by maintaining network rules on the host and performing connection forwarding.</p>
  </li>
  <li>
    <p>Container Runtime (Docker, rkt, or others)</p>

    <p>The container runtime is the software that is responsible for running containers. Kubernetes supports several runtimes: Docker, rkt, runc and any OCI runtime-spec implementation.</p>
  </li>
</ul>

<h2 id="kubernetesçš„èµ„æº">kubernetesçš„èµ„æº</h2>

<ul>
  <li>spec</li>
</ul>

<p>The spec, which you must provide, describes your desired state for the objectâ€“the characteristics that you want the object to have.</p>

<ul>
  <li>status</li>
</ul>

<p>The status describes the actual state of the object, and is supplied and updated by the Kubernetes system.</p>

<p><img src="/img/in-post/learn-kubernetes/resource.png" alt="image" /></p>

<h3 id="pod">pod</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>A pod is a group of one or more tightly related containers that will always run together on the same worker node and in the same Linux namespace(s).

Each pod is like a separate logical machine with its own IP, hostname, processes, etc., running a single application.
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>liveness</li>
</ul>

<p>The kubelet uses liveness probes to know when to restart a Container.</p>

<ul>
  <li>readiness</li>
</ul>

<p>The kubelet uses readiness probes to know when a Container is ready to start accepting traffic.</p>

<ul>
  <li>é—®é¢˜ï¼šå¦‚æœåˆ é™¤ä¸€ä¸ªpod æ˜¯å…ˆä»endpointé‡Œç§»é™¤pod ip,è¿˜æ˜¯ pod å…ˆåˆ é™¤</li>
</ul>

<p>ä¸ªäººè§è§£ï¼š</p>

<p>åˆ é™¤ä¸€ä¸ªpodçš„k8så†…éƒ¨æµç¨‹</p>
<ol>
  <li>ç”¨æˆ·åˆ é™¤pod</li>
  <li>apiserveræ ‡è®°podä¸ºâ€™deadâ€™çŠ¶æ€</li>
  <li>kubeletåˆ é™¤pod é»˜è®¤ç­‰å¾…30sè¿˜åœ¨è¿è¡Œæ—¶ ä¼šå¼ºåˆ¶å…³é—­pod
3.1 kubeletç­‰å¾…podä¸­å®¹å™¨çš„ prestop æ‰§è¡Œç»“æŸ
3.2 å‘é€ sigterm ä¿¡å· è®©å®¹å™¨å…³é—­
3.3 è¶…è¿‡30sç­‰å¾…æ—¶é—´ å‘é€ sigkill ä¿¡å·å¼ºåˆ¶podå…³é—­</li>
  <li>nodecontrollerä¸­çš„endpoint controllerä»endpointä¸­åˆ é™¤æ­¤pod</li>
</ol>

<p>3 4 æ­¥éª¤åŒæ—¶è¿›è¡Œ ä¸€èˆ¬æƒ…å†µä¸‹4è‚¯å®šä¼šå…ˆäº3å®Œæˆ,ç”±äº 3 4 é¡ºåºä¸å®š  æç«¯æƒ…å†µä¸‹å¯èƒ½å­˜åœ¨ kubeletå·²ç»åˆ é™¤äº†pod,è€Œendpoint controllerä»ç„¶å­˜åœ¨æ­¤pod,ä¼šå¯¼è‡´svcè¯·æ±‚ä¼šè½¬å‘åˆ°å·²ç»åˆ é™¤çš„podä¸Š,ä»è€Œå¯¼è‡´è°ƒç”¨svcå‡ºé”™</p>

<p>å‚è€ƒé“¾æ¥ https://kubernetes.io/docs/concepts/workloads/pods/pod/#termination-of-pods</p>

<p>å‚è€ƒé“¾æ¥:</p>
<ol>
  <li><a href="https://kubernetes.io/docs/tasks/inject-data-application/environment-variable-expose-pod-information/">å®¹å™¨ä¸­ä½¿ç”¨podçš„æ•°æ®</a></li>
  <li><a href="https://tonybai.com/2017/03/03/access-api-server-from-a-pod-through-serviceaccount/">åœ¨Kubernetes Podä¸­ä½¿ç”¨Service Accountè®¿é—®API Server</a></li>
  <li><a href="https://pracucci.com/graceful-shutdown-of-kubernetes-pods.html">ä¼˜é›…åœæ­¢pod</a></li>
</ol>

<h3 id="deployment">Deployment</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>A Deployment controller provides declarative updates for Pods and ReplicaSets.
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>Rolling Update</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>    <span class="c">#åªé€‚ç”¨äºpod é‡Œé¢åªåŒ…å«ä¸€ä¸ª container çš„æƒ…å†µ</span>
    kubectl rolling-update NAME <span class="o">[</span>NEW_NAME] <span class="nt">--image</span><span class="o">=</span>IMAGE:TAG
</pre></td></tr></tbody></table></code></pre></div></div>

<p><a href="https://kubernetes.io/docs/concepts/workloads/pods/init-containers/">Init Containers</a> ç”¨æ¥ä½œåˆå§‹åŒ–ç¯å¢ƒçš„å®¹å™¨</p>

<p>å‚è€ƒ:</p>
<ol>
  <li><a href="https://kubernetes.io/docs/tasks/configure-pod-container/assign-cpu-resource/">Assign CPU Resources to Containers and Pods</a></li>
  <li><a href="https://container-solutions.com/kubernetes-deployment-strategies/">Kubernetes deployment strategies</a></li>
  <li><a href="https://blog.powerupcloud.com/autoscaling-based-on-cpu-memory-in-kubernetes-part-ii-fe2e495bddd4">Autoscaling based on CPU/Memory in Kubernetesâ€Šâ€”â€ŠPart II</a></li>
  <li><a href="https://kubernetes.io/docs/concepts/configuration/assign-pod-node/">Assigning Pods to Nodes</a></li>
</ol>

<ul>
  <li>èµ„æºä¸å¤Ÿæ—¶deploymentæ— æ³•æ›´æ–°</li>
</ul>

<p>0/6 nodes are available: 3 Insufficient memory, 3 node(s) had taints that the pod didnâ€™t tolerate.</p>

<h3 id="replication-controller">Replication Controller</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>A replication controller is a Kubernetes resource that ensures a pod is always up and running.

-&gt; label
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="replicasetå‰¯æœ¬é›†">ReplicaSet(å‰¯æœ¬é›†)</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>Replication Controller(å‰¯æœ¬æ§åˆ¶å™¨)çš„æ›¿ä»£äº§ç‰©
</pre></td></tr></tbody></table></code></pre></div></div>

<table>
  <thead>
    <tr>
      <th>k8sç»„ä»¶</th>
      <th>pod selector</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Replication Controller</td>
      <td>label</td>
    </tr>
    <tr>
      <td>ReplicaSet</td>
      <td>label ,pods that include a certain label key</td>
    </tr>
  </tbody>
</table>

<p>å‚è€ƒé“¾æ¥:</p>
<ol>
  <li><a href="https://blog.csdn.net/WaltonWang/article/details/77461697">èŠèŠä½ å¯èƒ½è¯¯è§£çš„Kubernetes Deploymentæ»šåŠ¨æ›´æ–°æœºåˆ¶</a></li>
</ol>

<h3 id="daemonsetå®ˆæŠ¤è¿›ç¨‹é›†">DaemonSet(å®ˆæŠ¤è¿›ç¨‹é›†)</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>A DaemonSet makes sure it creates as many pods as there are nodes and deploys each one on its own node
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>å¥åº·æ£€æŸ¥
    <ol>
      <li>liveness probe</li>
      <li>HTTP-based liveness probe</li>
      <li></li>
    </ol>
  </li>
</ul>

<h3 id="statefulsetæœ‰çŠ¶æ€å‰¯æœ¬é›†">StatefulSet(æœ‰çŠ¶æ€å‰¯æœ¬é›†)</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>Manages the deployment and scaling of a set of Pods , and provides guarantees about the ordering and uniqueness of these Pods.
</pre></td></tr></tbody></table></code></pre></div></div>

<p>å‚è€ƒ:</p>
<ol>
  <li><a href="https://jimmysong.io/kubernetes-handbook/concepts/statefulset.html">StatefulSet</a></li>
</ol>

<h3 id="volumes">volumes</h3>

<blockquote>
  <p>volumesæœ‰2ç§æ¨¡å¼</p>

  <p>In-treeæ˜¯ Kubernetes æ ‡å‡†ç‰ˆçš„ä¸€éƒ¨åˆ†ï¼Œå·²ç»å†™å…¥ Kubernetes ä»£ç ä¸­ã€‚
Out-of-tree æ˜¯é€šè¿‡ Flexvolume æ¥å£å®ç°çš„ï¼ŒFlexvolume å¯ä»¥ä½¿å¾—ç”¨æˆ·åœ¨ Kubernetes å†…è‡ªå·±ç¼–å†™é©±åŠ¨æˆ–æ·»åŠ è‡ªæœ‰æ•°æ®å·çš„æ”¯æŒã€‚</p>
</blockquote>

<ol>
  <li>emptyDir â€“ a simple empty directory used for storing transient data,</li>
  <li>hostPath â€“ for mounting directories from the worker nodeâ€™s filesystem into the pod,</li>
  <li>gitRepo â€“ a volume initialized by checking out the contents of a Git repository,</li>
  <li>nfs â€“ an NFS share mounted into the pod,</li>
  <li>gcePersistentDisk (Google Compute Engine Persistent Disk), awsElasticBlockStore
(Amazon Web Services Elastic Block Store Volume), azureDisk (Microsoft Azure Disk
Volume) â€“ for mounting cloud provider specific storage,</li>
  <li>cinder, cephfs, iscsi, flocker, glusterfs, quobyte, rbd, flexVolume, vsphereVolume,
photonPersistentDisk, scaleIO â€“ for mounting other types of network storage,</li>
  <li>configMap, secret, downwardAPI â€“ special types of volumes used to expose certain
Kubernetes resources and cluster info to the pod,</li>
  <li>persistentVolumeClaim â€“ a way to use a pre- or dynamically provisioned persistent
storage (weâ€™ll talk about them in the last section of this chapter).</li>
</ol>

<ul>
  <li>
    <p>Persistent Volume
æŒä¹…å·ï¼Œå°±æ˜¯å°†æ•°æ®å­˜å‚¨æ”¾åˆ°å¯¹åº”çš„å¤–éƒ¨å¯é å­˜å‚¨ä¸­ï¼Œç„¶åæä¾›ç»™Pod/å®¹å™¨ä½¿ç”¨ï¼Œè€Œæ— éœ€å…ˆå°†å¤–éƒ¨å­˜å‚¨æŒ‚åœ¨åˆ°ä¸»æœºä¸Šå†æä¾›ç»™å®¹å™¨ã€‚å®ƒæœ€å¤§çš„ç‰¹ç‚¹æ˜¯å…¶ç”Ÿå‘½å‘¨æœŸä¸Podä¸å…³è”ï¼Œåœ¨Podæ­»æ‰çš„æ—¶å€™å®ƒä¾ç„¶å­˜åœ¨ï¼Œåœ¨Podæ¢å¤çš„æ—¶å€™è‡ªåŠ¨æ¢å¤å…³è”ã€‚</p>
  </li>
  <li>
    <p>Persistent Volume Claim
ç”¨æ¥ç”³æ˜å®ƒå°†ä»PVæˆ–è€…Storage Classèµ„æºé‡Œè·å–æŸä¸ªå­˜å‚¨å¤§å°çš„ç©ºé—´ã€‚</p>
  </li>
</ul>

<p>å‚è€ƒï¼š</p>
<ol>
  <li><a href="https://jimmysong.io/posts/kubernetes-volumes-introduction">Kubernetesä¸­çš„Volumeä»‹ç»</a></li>
</ol>

<h3 id="configmap">ConfigMap</h3>

<p>ConfigMapæ˜¯ç”¨æ¥å­˜å‚¨é…ç½®æ–‡ä»¶çš„kubernetesèµ„æºå¯¹è±¡ï¼Œæ‰€æœ‰çš„é…ç½®å†…å®¹éƒ½å­˜å‚¨åœ¨etcdä¸­.</p>

<p>å®è·µè¯æ˜ä¿®æ”¹ ConfigMap æ— æ³•æ›´æ–°å®¹å™¨ä¸­å·²æ³¨å…¥çš„ç¯å¢ƒå˜é‡ä¿¡æ¯ã€‚</p>

<p>å‚è€ƒ:</p>
<ol>
  <li><a href="https://jimmysong.io/posts/kubernetes-configmap-hot-update/">Kubernetes ConfigMapçƒ­æ›´æ–°æµ‹è¯•</a></li>
</ol>

<h3 id="service">service</h3>

<blockquote>
  <p>A Kubernetes service is a resource you create to get a single, constant point of entry to a group of pods providing the same service.</p>
</blockquote>

<blockquote>
  <p>Each service has an IP address and port that never change while the service exists.</p>
</blockquote>

<blockquote>
  <p>The resources will be created in the order they appear in the file. Therefore, itâ€™s best to specify the service first, since that will ensure the scheduler can spread the pods associated with the service as they are created by the controller(s), such as Deployment.</p>
</blockquote>

<ul>
  <li>ClusterIP</li>
</ul>

<p>é›†ç¾¤å†…éƒ¨è®¿é—®ç”¨,å¤–éƒ¨å¯ç›´æ¥è®¿é—®</p>

<p>å½“typeä¸æŒ‡å®šæ—¶,åˆ›å»ºçš„å°±æ˜¯è¿™ä¸€ç±»å‹çš„æœåŠ¡</p>

<p>clusterIP: Noneæ˜¯ä¸€ç§ç‰¹æ®Šçš„<a href="https://kubernetes.io/zh/docs/concepts/services-networking/service/#headless-service">headless-service</a>,ç‰¹ç‚¹æ˜¯æ²¡æœ‰clusterIP</p>

<ul>
  <li>NodePort</li>
</ul>

<p>æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šå¼€ç›¸åŒçš„ç«¯å£,æ‰€ä»¥å«NodePort.æœ‰æ•°é‡é™åˆ¶.å¤–éƒ¨å¯ç›´æ¥è®¿é—®</p>

<ul>
  <li>LoadBalancer</li>
</ul>

<p>ç‰¹å®šäº‘äº§å•†çš„æœåŠ¡.å¦‚æœæ˜¯é˜¿é‡Œäº‘,å°±æ˜¯åœ¨NodePortçš„åŸºç¡€ä¸Š,å¸®ä½ è‡ªåŠ¨ç»‘å®šè´Ÿè½½å‡è¡¡çš„åç«¯æœåŠ¡å™¨è€Œå·²</p>

<ul>
  <li>ExternalName</li>
</ul>

<p>å‚è€ƒ:</p>
<ol>
  <li><a href="https://kubernetes.io/blog/2018/07/09/ipvs-based-in-cluster-load-balancing-deep-dive/">IPVS-Based In-Cluster Load Balancing Deep Dive</a></li>
</ol>

<h3 id="horizontal-pod-autoscaler">Horizontal Pod Autoscaler</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>The Horizontal Pod Autoscaler automatically scales the number of pods in a replication controller, deployment or replica set based on observed CPU utilization (or, with custom metrics support, on some other application-provided metrics).
</pre></td></tr></tbody></table></code></pre></div></div>

<p>é…åˆmetrics APIsä»¥åŠresource é‡Œé¢çš„ request èµ„æºè¿›è¡Œè°ƒæ•´.</p>

<h3 id="kubernetes-downward-api">Kubernetes Downward API</h3>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>It allows us to pass metadata about the pod and its environment through environment variables or files (in a so- called downwardAPI volume)
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>environment variables</li>
  <li>downwardAPI volume</li>
</ul>

<h3 id="resource-quotas">Resource Quotas</h3>

<p>åŸºäºnamespaceé™åˆ¶podèµ„æºçš„ä¸€ç§æ‰‹æ®µ</p>

<h2 id="ç½‘ç»œæ¨¡å‹">ç½‘ç»œæ¨¡å‹</h2>

<p><a href="https://mp.weixin.qq.com/s?__biz=MjM5OTcxMzE0MQ==&amp;mid=2653371440&amp;idx=1&amp;sn=49f4e773bb8a58728752275faf891273&amp;chksm=bce4dc2a8b93553c6b33d53c688ba30d61f88f0e065f50d82b1fb7e64daa4cc68394ffd8810b&amp;mpshare=1&amp;scene=23&amp;srcid=1031BL2jtxx8DABRb46lNGPl%23rd">Kubernetesç½‘ç»œæ¨¡å‹åŸç†</a></p>

<p>å‚è€ƒå‘½ä»¤:</p>
<ol>
  <li><a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands">kubectlå‘½ä»¤æŒ‡å—</a></li>
  <li><a href="https://yq.aliyun.com/articles/385699?spm=a2c4e.11153959.0.0.7355d55acvAlBq">Kubernetesä¸DockeråŸºæœ¬æ¦‚å¿µä¸å¸¸ç”¨å‘½ä»¤å¯¹ç…§</a></li>
  <li><a href="https://kubernetes.io/docs/reference/kubectl/cheatsheet/">kubectl Cheat Sheet</a></li>
  <li><a href="https://kubernetes.io/docs/reference/">K8Sèµ„æºé…ç½®æŒ‡å—</a></li>
  <li><a href="https://kubernetes.io/blog/2016/12/container-runtime-interface-cri-in-kubernetes/">Introducing Container Runtime Interface (CRI) in Kubernetes</a></li>
</ol>

<p>å‚è€ƒç”µå­ä¹¦:
<a href="https://jimmysong.io/kubernetes-handbook/concepts/statefulset.html">Kubernetes Handbookâ€”â€”Kubernetesä¸­æ–‡æŒ‡å—/äº‘åŸç”Ÿåº”ç”¨æ¶æ„å®è·µæ‰‹å†Œ</a></p>
:ET